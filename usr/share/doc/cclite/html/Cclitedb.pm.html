<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Cclitedb.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Cclitedb.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#bugs">BUGS</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#add_database_record">add_database_record</a></li>
			<li><a href="#add_database_record_dbh">add_database_record_dbh</a></li>
			<li><a href="#show_record">show_record</a></li>
			<li><a href="#update_database_record">update_database_record</a></li>
			<li><a href="#delete_database_record">delete_database_record</a></li>
			<li><a href="#sqlcount">sqlcount</a></li>
			<li><a href="#sqlraw">sqlraw</a></li>
			<li><a href="#sqlraw_return_array">sqlraw_return_array</a></li>
			<li><a href="#find_database_records">find_database_records</a></li>
			<li><a href="#get_where">get_where</a></li>
			<li><a href="#get_where_return_array">get_where_return_array</a></li>
			<li><a href="#get_where_multiple">get_where_multiple</a></li>
			<li><a href="#sqlfind">sqlfind</a></li>
			<li><a href="#modify_database_record">modify_database_record</a></li>
			<li><a href="#modify_database_record2">modify_database_record2</a></li>
			<li><a href="#display_database_record">display_database_record</a></li>
			<li><a href="#get_table_columns">get_table_columns</a></li>
			<li><a href="#check_db_and_version">check_db_and_version</a></li>
			<li><a href="#get_table_text_columns">get_table_text_columns</a></li>
			<li><a href="#makecolumns">makecolumns</a></li>
			<li><a href="#_registry_connect">_registry_connect</a></li>
			<li><a href="#registry_connect">registry_connect</a></li>
			<li><a href="#_sqlfind">_sqlfind</a></li>
			<li><a href="#_sqlgetall">_sqlgetall</a></li>
			<li><a href="#_sqlgetwhere">_sqlgetwhere</a></li>
			<li><a href="#_sqldelete">_sqldelete</a></li>
			<li><a href="#_sqlinsert">_sqlinsert</a></li>
			<li><a href="#_sqlupdate">_sqlupdate</a></li>
			<li><a href="#_sqlcount">_sqlcount</a></li>
			<li><a href="#makebutton">makebutton</a></li>
			<li><a href="#_choosetemplate">_choosetemplate</a></li>
			<li><a href="#makebox">makebox</a></li>
			<li><a href="#makelink">makelink</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Cclitedb-">package Cclitedb</a>
<ul>
<li><a href="#add_database_record-">add_database_record</a></li>
<li><a href="#add_database_record_dbh-">add_database_record_dbh</a></li>
<li><a href="#show_record-">show_record</a></li>
<li><a href="#update_database_record-">update_database_record</a></li>
<li><a href="#delete_database_record-">delete_database_record</a></li>
<li><a href="#sqlcount-">sqlcount</a></li>
<li><a href="#sqlraw-">sqlraw</a></li>
<li><a href="#sqlraw_return_array-">sqlraw_return_array</a></li>
<li><a href="#find_database_records-">find_database_records</a></li>
<li><a href="#get_where-">get_where</a></li>
<li><a href="#get_where_return_array-">get_where_return_array</a></li>
<li><a href="#get_where_multiple-">get_where_multiple</a></li>
<li><a href="#sqlfind-">sqlfind</a></li>
<li><a href="#modify_database_record-">modify_database_record</a></li>
<li><a href="#modify_database_record2-">modify_database_record2</a></li>
<li><a href="#display_database_record-">display_database_record</a></li>
<li><a href="#get_table_columns-">get_table_columns</a></li>
<li><a href="#check_db_and_version-">check_db_and_version</a></li>
<li><a href="#get_table_text_columns-">get_table_text_columns</a></li>
<li><a href="#makecolumns-">makecolumns</a></li>
<li><a href="#_registry_connect-">_registry_connect</a></li>
<li><a href="#registry_connect-">registry_connect</a></li>
<li><a href="#_sqlfind-">_sqlfind</a></li>
<li><a href="#_sqlgetall-">_sqlgetall</a></li>
<li><a href="#_sqlgetwhere-">_sqlgetwhere</a></li>
<li><a href="#_sqldelete-">_sqldelete</a></li>
<li><a href="#_sqlinsert-">_sqlinsert</a></li>
<li><a href="#_sqlupdate-">_sqlupdate</a></li>
<li><a href="#_sqlcount-">_sqlcount</a></li>
<li><a href="#makebutton-">makebutton</a></li>
<li><a href="#_choosetemplate-">_choosetemplate</a></li>
<li><a href="#makebox-">makebox</a></li>
<li><a href="#makelink-">makelink</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Cclitedb.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Database routines for Cclite</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains all the database routines and static SQL for cclite and some utility routines
to add a function:
 1.  add a routine to generate SQL here 
 2.  add it to the export list below
 3.  use it in on of the main programs
The token is calculated from session info, remote address and an internal registry
key. It diminishes session hijack risk
November 2004: Limit clauses added to _sqlgetwhere _sqlgetall _sqlfind
=head1 AUTHOR</p>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="bugs">BUGS</a></h1>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cclite.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005-2007 GPL Licenced 
=cut</p>
<pre>
<a name="package-Cclitedb-"></a><span class="k">package </span><span class="i">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">DBI</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>

<span class="c">###DBI-&gt;trace( 4, &#39;../debug/debug.dbi&#39; );      # Database abstraction</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>    <span class="c"># for paging routine, at least</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>

<span class="k">our</span> <span class="i">$log</span> = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;Cclitedb&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#---------------------------------------------------------</span>
<span class="c"># note the sql ones almost certainly shouldn&#39;t be exported!</span>

<span class="i">@EXPORT</span> = <span class="q">qw(check_db_and_version</span>
  <span class="q">add_database_record</span>
  <span class="q">add_database_record_dbh</span>
  <span class="q">update_database_record</span>
  <span class="q">modify_database_record</span>
  <span class="q">modify_database_record2</span>
  <span class="q">delete_database_record</span>
  <span class="q">find_database_records</span>
  <span class="q">makebutton</span>
  <span class="q">makebox</span>
  <span class="q">makelink</span>
  <span class="q">makehome</span>
  <span class="q">sqlget</span>
  <span class="q">sqlgetall</span>
  <span class="q">sqlcount</span>
  <span class="q">get_where</span>
  <span class="q">get_where_return_array</span>
  <span class="q">get_where_multiple</span>
  <span class="q">get_table_columns</span>
  <span class="q">registry_connect</span>
  <span class="q">server_hello</span>
  <span class="q">show_record</span>
  <span class="q">sqlinsert</span>
  <span class="q">sqlupdate</span>
  <span class="q">sqlgetpeople</span>
  <span class="q">sqlfind</span>
  <span class="q">sqlraw</span>
  <span class="q">sqlraw_return_array</span>
  <span class="q">sqldelete</span>
  <span class="q">makecolumns)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="add_database_record">add_database_record</a></h3>
<p>Add a record to the cclite database
now very general should work out which fields to insert via 'describe'</p>
<pre>
<a name="add_database_record-"></a><span class="k">sub </span><span class="m">add_database_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$insert</span> = <span class="i">_sqlinsert</span><span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span>    = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$insert</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rv</span>     = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span>  = <span class="i">$sth</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="add_database_record_dbh">add_database_record_dbh</a></h3>
<p>Add a record to the cclite database
now very general should work out which fields to insert via 'describe'
Version to be used in transactions, connect is outside the routine</p>
<pre>
<a name="add_database_record_dbh-"></a><span class="k">sub </span><span class="m">add_database_record_dbh</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$rc</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_id</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$insert</span> = <span class="i">_sqlinsert</span><span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span>    = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$insert</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rv</span>     = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span>  = <span class="i">$sth</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_record">show_record</a></h3>
<p>show detail for a database record
very rudimentary at present, packs up record into table
and returns as result</p>
<pre>
<a name="show_record-"></a><span class="k">sub </span><span class="m">show_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#---------------------------------------------------</span>
    <span class="c"># Note kludge to deal with irregular id fields</span>
    <span class="k">my</span> <span class="i">%id_fields</span> = <span class="q">qw(om_users userId om_trades tradeId)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span>        = <span class="q">&quot;id&quot;</span><span class="sc">;</span>
    <span class="i">$id</span> = <span class="i">$id_fields</span>{<span class="i">$table</span>} <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$id_fields</span>{<span class="i">$table</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c">#----------------------------------------------------</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$returnref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="i">$id</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$returnref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># disambiguate userLogin for display: duserLogin = display userLogin</span>
        <span class="c"># hence this should be used in any display templates</span>
        <span class="i">$$fieldsref</span>{<span class="w">duserLogin</span>} = <span class="i">$$returnref</span>{<span class="w">userLogin</span>}
          <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> <span class="k">eq</span> <span class="q">&quot;userLogin&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &lt;tr&gt;&lt;td class=&quot;pme-key-1&quot;&gt;$key&lt;/td&gt;&lt;td class=&quot;pme-value-1&quot;&gt;$$returnref{$key}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>

    <span class="c"># default result.html is used, if no template is supplied</span>
    <span class="k">my</span> <span class="i">$template</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$template</span> = <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>}<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="update_database_record">update_database_record</a></h3>
<p>This is used by registry modification transaction, do not remove</p>
<p>Simplest one, but uses hash exclusively, will it work as a web service?
So far, we have:
update_database_record : raw
modify_database_record : produces form: keep and generalise
modify_database_record2 : where</p>
<p>Need to eliminate one of these!</p>
<pre>
<a name="update_database_record-"></a><span class="k">sub </span><span class="m">update_database_record</span> <span class="s">{</span>

    <span class="c"># note useid is 1 for using the id field in where</span>
    <span class="c">#               2 for using the user logon</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$useid</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">%messages</span><span class="cm">,</span> <span class="i">$messagesref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># deals with no language problem</span>
    <span class="c">#FIXME: In Ccsmsgateway language delivers notused why is this?</span>
    <span class="c"># duplicated language code with Ccu</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$messagesref</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$language</span> = <span class="q">&#39;en&#39;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$language</span><span class="s">)</span> || <span class="i">$language</span> <span class="k">eq</span> <span class="q">&#39;notused&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">%messages</span>    = <span class="i">Ccu::readmessages</span><span class="s">(</span><span class="i">$language</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_users&#39;</span> &amp;&amp; <span class="i">$$fieldsref</span>{<span class="w">action</span>} <span class="k">eq</span> <span class="q">&quot;update&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$$fieldsref</span>{<span class="w">registry</span>} = <span class="i">$db</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@status</span> =
          <span class="i">Ccvalidate::validate_user</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># need to sort out status values throughout</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span>[<span class="n">0</span>] == <span class="n">-1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">shift</span> <span class="i">@status</span><span class="sc">;</span>
            <span class="i">$html</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># hash password: corrected 18/10/2009 for 0 zero url type</span>
        <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} =
          <span class="i">Ccsecure::hash_password</span><span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} <span class="s">)</span>
          <span class="k">if</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># unlock the password if administrator and Password changed</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPasswordTries</span>}  = <span class="n">3</span><span class="sc">;</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPasswordStatus</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} = <span class="i">text_to_hash</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span>
          <span class="k">if</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} =
          <span class="i">format_for_uk_mobile</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} <span class="s">)</span>
          <span class="k">if</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c"># unlock the SMS PIN if administrator and PIN changed</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPinTries</span>}  = <span class="n">3</span><span class="sc">;</span>
            <span class="i">$$fieldsref</span>{<span class="w">userPinStatus</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$update</span> = <span class="i">_sqlupdate</span><span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$useid</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$update</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#FIXME: Some tables still haven&#39;t literals</span>
    <span class="k">my</span> <span class="i">$table_literal</span> = <span class="i">$messages</span>{<span class="i">$table</span>} || <span class="i">$table</span><span class="sc">;</span>

    <span class="i">$html</span> = <span class="q">&quot;$table_literal record $$fieldsref{id} $$fieldsref{action}&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="delete_database_record">delete_database_record</a></h3>
<p>Delete a database record. Compensates for different ids
within tables due to use of tiki schema. Ugly at present
but functioning</p>
<pre>
<a name="delete_database_record-"></a><span class="k">sub </span><span class="m">delete_database_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id</span><span class="sc">;</span>

    <span class="c"># compensate for different id names in tables, ugly</span>
    <span class="k">my</span> <span class="i">%translate</span> = <span class="q">qw(om_trades tradeId om_users userId)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$translate</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$id</span> = <span class="i">$translate</span>{<span class="i">$table</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$id</span> = <span class="q">&quot;id&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$delete</span> = <span class="i">_sqldelete</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="i">$id</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$delete</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># this is not multilingual to be fixed</span>
    <span class="i">$html</span> = <span class="q">&quot;$table record $$fieldsref{$id} deleted&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlcount">sqlcount</a></h3>
<p>Count a set of records in the database, either to output
as a guide figure or to make pagination information</p>
<p>Can be done via sqlstring or where</p>
<p>This needs to return an error too</p>
<pre>
<a name="sqlcount-"></a><span class="k">sub </span><span class="m">sqlcount</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$value</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># count all the transactions belonging to the current user</span>
    <span class="k">my</span> <span class="i">$sqlcount</span> = <span class="i">_sqlcount</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$value</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$sqlcount</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@row</span>   = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$count</span> = <span class="i">$row</span>[<span class="n">0</span>]<span class="sc">;</span>
    <span class="k">return</span> <span class="i">$count</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlraw">sqlraw</a></h3>
<p>Sql raw a given piece of sql. 
Does not allow update or delete used for complex joins etc.
change to hash_ref, self-describing but problematic in soap calls</p>
<pre>
<a name="sqlraw-"></a><span class="k">sub </span><span class="m">sqlraw</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># remove all modification attempts!</span>
    <span class="i">$sqlstring</span> =~ <span class="q">s/delete|insert|update//gi</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$sqlstring</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_hashref</span><span class="s">(</span><span class="i">$id</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># --- example of use---------------------------------</span>
    <span class="c"># $hash_ref = $sth-&gt;fetchall_hashref(&#39;id&#39;);</span>
    <span class="c"># print &quot;Name for id 42 is $hash_ref-&gt;{42}-&gt;{name}\n&quot;;</span>
    <span class="c">#----------------------------------------------------</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlraw_return_array">sqlraw_return_array</a></h3>
<p>returns an array, probably useful for web services
otherwise identical to sqlraw, probably should be
renamed to sql_raw_return_hash...</p>
<pre>
<a name="sqlraw_return_array-"></a><span class="k">sub </span><span class="m">sqlraw_return_array</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># remove all modification attempts!</span>
    <span class="i">$sqlstring</span> =~ <span class="q">s/delete|insert|update//gi</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># cumulate any detail error with registry error 10/2009</span>
    <span class="i">$registryerror</span> .= <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span><span class="sc">;</span>
    <span class="c">###$log-&gt;debug(&quot;$db $registryerror $sqlstring&quot;) ;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$sqlstring</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$array_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_arrayref</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="find_database_records">find_database_records</a></h3>
<p>Find strings within a table
Makes a large OR using LIKE.
Very inefficient but works at present</p>
<p>This will now deliver all transactions into a find
that is done by the manager...be careful</p>
<pre>
<a name="find_database_records-"></a><span class="k">sub </span><span class="m">find_database_records</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">get_table_text_columns</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$row_ref</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="i">$string</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># make a massive where statement for all textual columns</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$column</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$column</span> = <span class="q">&quot;$column LIKE \&#39;%$$fieldsref{string}%\&#39;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$like</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot; or &quot;</span><span class="cm">,</span> <span class="i">@columns</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># constrain finds on om_trades to just the owner&#39;s records</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> &amp;&amp; !<span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

      <span class="c"># first select base set, only records for user, if not admin</span>
      <span class="c"># debits and opening balances are user sourced, credits are remote sourced</span>

        <span class="i">$like</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">and ((tradeSource = &#39;$$cookieref{userLogin}&#39; and (tradeType = &#39;debit&#39; or tradeType = &#39;open&#39;))</span>
<span class="hh"> or</span>
<span class="hh"> (tradeDestination = &#39;$$cookieref{userLogin}&#39; and  tradeType = &#39;credit&#39;)</span>
<span class="hh">)</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># count all the transactions belonging to the current user</span>
    <span class="c"># if om_trades otherwise count all records</span>
    <span class="c">#</span>
    <span class="i">$count</span> =
      <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="q">&quot;tradeSource&quot;</span><span class="cm">,</span>
        <span class="i">$$cookieref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$count</span> = <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># get the columns too</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$column_array_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;describe $table&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$find</span> = <span class="i">_sqlfind</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$like</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$find</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$array_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_arrayref</span><span class="sc">;</span>

    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$column_array_ref</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_where">get_where</a></h3>
<p>FIXME: This is throwing errors into the apache log
get a record via a single = field condition
should return one record only</p>
<pre>
<a name="get_where-"></a><span class="k">sub </span><span class="m">get_where</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>

<span class="c">###    $log-&gt;debug(&quot;get_where:g:$get r:$registryerror p:$package, f:$filename, l:$line&quot;);</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_hashref</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_where_return_array">get_where_return_array</a></h3>
<p>get a record via a single = field condition
returns an array for web services use</p>
<pre>
<a name="get_where_return_array-"></a><span class="k">sub </span><span class="m">get_where_return_array</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">@array</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">@array</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$dbh</span><span class="i">-&gt;disconnect</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">@array</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_where_multiple">get_where_multiple</a></h3>
<p>get multiple records via a field condition returns an array
this should completely replace get_where after a while
needs limit clause</p>
<pre>
<a name="get_where_multiple-"></a><span class="k">sub </span><span class="m">get_where_multiple</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$package</span><span class="cm">,</span> <span class="i">$filename</span><span class="cm">,</span> <span class="i">$line</span> <span class="s">)</span> = <span class="k">caller</span><span class="sc">;</span>
    <span class="c">###$log-&gt;debug(&quot;get_where_multiple: g:$get $registryerror p:$package, f:$filename, l:$line&quot;);</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$array_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_arrayref</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sqlfind">sqlfind</a></h3>
<p>sql find for a given piece of sql. This is sometimes the motor
for a given application. To some extent, this is a 'tramp' function
as defined in coding complete, but it hides _sqlfind too...</p>
<p>'order' param after $sqlstring isn't filled at present</p>
<pre>
<a name="sqlfind-"></a><span class="k">sub </span><span class="m">sqlfind</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span>
        <span class="i">$order</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlfind</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$dbh</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$rv</span>  = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$array_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchall_arrayref</span><span class="sc">;</span>
        <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="modify_database_record">modify_database_record</a></h3>
<pre>
 Prepares to modify:
  - fetches a record by id
  - transfers fields to fieldsref
  - set up appropriate next action
  - display form if named, default if not
  - hardwired template logic probably needs to be moved</pre>
<pre>
<a name="modify_database_record-"></a><span class="k">sub </span><span class="m">modify_database_record</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$field</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># work out default template, results.html is not used nowadays</span>
    <span class="k">my</span> <span class="i">$default_template</span> = <span class="i">$table</span><span class="sc">;</span>
    <span class="i">$default_template</span> =~ <span class="q">s/om_//</span><span class="sc">;</span>
    <span class="i">$default_template</span> .= <span class="q">&quot;\056html&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$template</span> = <span class="i">$$fieldsref</span>{<span class="w">template</span>} || <span class="i">$default_template</span><span class="sc">;</span>

    <span class="c"># compensate for different id names, needs to be stripped</span>
    <span class="c"># out by version 2</span>
    <span class="k">my</span> <span class="i">%translate</span> = <span class="q">qw(om_trades tradeId om_users userId)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$idname</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">exists</span> <span class="i">$translate</span>{<span class="i">$table</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$idname</span> = <span class="i">$translate</span>{<span class="i">$table</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$idname</span> = <span class="q">&#39;id&#39;</span><span class="sc">;</span>    <span class="c"># called id in all other tables</span>
    <span class="s">}</span>

    <span class="c">#---- thank goodness that&#39;s over-------------------</span>
    <span class="k">my</span> <span class="i">$get</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_users&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$get</span> = <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="i">$idname</span>}<span class="cm">,</span>
            <span class="i">$table</span><span class="cm">,</span> <span class="i">$idname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$get</span> = <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">userId</span>}<span class="cm">,</span>
            <span class="i">$table</span><span class="cm">,</span> <span class="i">$idname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">###print &quot;get is $get\ template is $template \n&quot; ;</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hash_ref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_hashref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span>    = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$hash_ref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="modify_database_record2">modify_database_record2</a></h3>
<p>Did this never work? Just modified 2/5/2005 to produce
a where condition update.</p>
<p>Needs investigation and possible removal</p>
<pre>
<a name="modify_database_record2-"></a><span class="k">sub </span><span class="m">modify_database_record2</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>    <span class="i">$name</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$field</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$offset</span><span class="sc">;</span>    <span class="c"># not used here</span>
    <span class="k">my</span> <span class="i">$limit</span><span class="sc">;</span>     <span class="c"># not used here</span>
                   <span class="c"># this needs to be replaced by fetchrow_hashref...</span>
    <span class="k">my</span> <span class="i">$counter</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># count the rows as they go by!</span>
    <span class="k">my</span> <span class="i">$get</span> =
      <span class="i">_sqlgetwhere</span><span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$fieldsref</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_hashref</span><span class="sc">;</span>    <span class="c"># note fieldsref now comes from db</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="display_database_record">display_database_record</a></h3>
<p>Generalised display a record from any table in the database
Returns html directly, is therefore single language</p>
<p>Needs to take a template as input to make multi-language</p>
<pre>
<a name="display_database_record-"></a><span class="k">sub </span><span class="m">display_database_record</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">@row</span><span class="cm">,</span> <span class="i">$home</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$counter</span> = <span class="n">0</span><span class="sc">;</span>                            <span class="c"># count the rows as they go by!</span>
    <span class="k">my</span> <span class="i">$get</span>     = <span class="i">_sqlget</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">id</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$get</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fieldnames</span> = <span class="i">makecolumns</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$id</span> = <span class="i">$row</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@row</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">         &lt;tr&gt;&lt;td  class=&quot;pme-key-1&quot;&gt;$fieldnames[$counter]&lt;/td&gt;&lt;td class=&quot;pme-key-1&quot;&gt;$field&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

            <span class="i">$counter</span>++<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$homelink</span> = <span class="i">makehome</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$header</span>   = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;tr&gt;&lt;td class=&quot;pme-key-1&quot; colspan=&quot;2&quot;&gt;Record $$fieldsref{id}&lt;/td&gt;&lt;td class=&quot;pme-key-1&quot;&gt;$homelink&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="i">$html</span> = <span class="q">&quot;&lt;table width=\&quot;80%\&quot;&gt;$header $html&lt;/table&gt;&quot;</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_table_columns">get_table_columns</a></h3>
<p>Gets all the columns within a table via a
table describe. Used to prepare other operations</p>
<pre>
<a name="get_table_columns-"></a><span class="k">sub </span><span class="m">get_table_columns</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$sth</span><span class="cm">,</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">@row</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$show</span> = <span class="q">&quot;describe $table;&quot;</span><span class="sc">;</span>
    <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$show</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rv</span> = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">$row</span>[<span class="n">0</span>]<span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="check_db_and_version">check_db_and_version</a></h3>
<p>checks for database password and no innodb problems
during install/configuration update</p>
<p>alpha quality code, new in December 2005</p>
<pre>
<a name="check_db_and_version-"></a><span class="k">sub </span><span class="m">check_db_and_version</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$token</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#---------------------------------------------------------</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">&amp;Cclitedb::_registry_connect</span><span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># return signature: $refresh,$metarefresh,$error,$html,$pagename,$cookies</span>
    <span class="c"># no connection to database, return reason</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$registryerror</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$registryerror</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># mysql version less than 4, no inno_db, return version</span>
    <span class="k">my</span> <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="q">&quot;show variables;&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$m</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@row</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">last</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span>[<span class="n">0</span>] =~ <span class="q">/^have_innodb/i</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span>[<span class="n">1</span>] !~ <span class="q">/^YES/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;innodb  $row[1]&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># nothing comes back, ok</span>
    <span class="k">return</span> <span class="k">undef</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_table_text_columns">get_table_text_columns</a></h3>
<p>gets text type columns via describe
probably refactor this as a mode of get_table_columns?</p>
<pre>
<a name="get_table_text_columns-"></a><span class="k">sub </span><span class="m">get_table_text_columns</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$sth</span><span class="cm">,</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">@row</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$show</span> = <span class="q">&quot;describe $table;&quot;</span><span class="sc">;</span>
    <span class="i">$sth</span> = <span class="i">$dbh</span><span class="i">-&gt;prepare</span><span class="s">(</span><span class="i">$show</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rv</span> = <span class="i">$sth</span><span class="i">-&gt;execute</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="i">@row</span> = <span class="i">$sth</span><span class="i">-&gt;fetchrow_array</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">$row</span>[<span class="n">0</span>] <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span>[<span class="n">1</span>] =~ <span class="q">/varchar|text|enum/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$sth</span><span class="i">-&gt;finish</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$dbh</span><span class="i">-&gt;errstr</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="makecolumns">makecolumns</a></h3>
<p>Make a list of columns, is this obsolete now?</p>
<pre>
<a name="makecolumns-"></a><span class="k">sub </span><span class="m">makecolumns</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$mode</span><span class="cm">,</span> <span class="i">$columns_ref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsstring</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@$columns_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$mode</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">$fieldsstring</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">@fields</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_registry_connect">_registry_connect</a></h3>
<p>connect to database (therefore a registry) or database server 
(with blank $db, to create registries)</p>
<p>Note that all _ prefixed are inner routines, shouldn't be exposed</p>
<p>This needs review to pass the user and password inwards cleanly 12/2005</p>
<pre>
<a name="_registry_connect-"></a><span class="k">sub </span><span class="m">_registry_connect</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbuser</span>     = <span class="i">$configuration</span>{<span class="w">dbuser</span>}<span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbpassword</span> = <span class="i">$configuration</span>{<span class="w">dbpassword</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#open connection to MySql database</span>
    <span class="k">my</span> <span class="i">$dbh</span> = <span class="w">DBI</span><span class="w">-&gt;connect</span><span class="s">(</span> <span class="q">&quot;dbi:mysql:$db&quot;</span><span class="cm">,</span> <span class="i">$dbuser</span><span class="cm">,</span> <span class="i">$dbpassword</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$DBI::errstr</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="registry_connect">registry_connect</a></h3>
<p>FIXME: Exposed version of connect to database (therefore a registry) or database server 
(with blank $db, to create registries)</p>
<p>This is for the future with persistent database handles in mono-registry</p>
<pre>
<a name="registry_connect-"></a><span class="k">sub </span><span class="m">registry_connect</span> <span class="s">{</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbuser</span>     = <span class="i">$configuration</span>{<span class="w">dbuser</span>}<span class="sc">;</span>
    <span class="k">our</span> <span class="i">$dbpassword</span> = <span class="i">$configuration</span>{<span class="w">dbpassword</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c">#open connection to MySql database</span>
    <span class="k">my</span> <span class="i">$dbh</span> = <span class="w">DBI</span><span class="w">-&gt;connect</span><span class="s">(</span> <span class="q">&quot;dbi:mysql:$db&quot;</span><span class="cm">,</span> <span class="i">$dbuser</span><span class="cm">,</span> <span class="i">$dbpassword</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$error</span> = <span class="i">$DBI::errstr</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlfind">_sqlfind</a></h3>
<p>find record via string, orders output set
if order parameter is present</p>
<pre>
<a name="_sqlfind-"></a><span class="k">sub </span><span class="m">_sqlfind</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlfind</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit_clause</span><span class="sc">;</span>

   <span class="c"># mild security don&#39;t deliver complete tables  unless admin 10.3.2007/06/2007</span>
    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> <span class="i">$sqlstring</span> == <span class="n">1</span> || <span class="i">$sqlstring</span> <span class="k">eq</span> <span class="q">&quot;1=1&quot;</span> <span class="s">)</span> &amp;&amp; !<span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$offset</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$offset</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$limit_clause</span> = <span class="q">&quot;LIMIT $offset,$limit&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$order</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sqlfind</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   SELECT * from $table WHERE ($sqlstring) ORDER BY $order $limit_clause</span>
<span class="h">EOT</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$sqlfind</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   SELECT * from $table WHERE ($sqlstring) $limit_clause</span>
<span class="h">EOT</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$sqlfind</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlgetall">_sqlgetall</a></h3>
<p>select all the records in a table
uses limit and offset, if present</p>
<pre>
<a name="_sqlgetall-"></a><span class="k">sub </span><span class="m">_sqlgetall</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit_clause</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$offset</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$offset</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$limit_clause</span> = <span class="q">&quot;LIMIT $offset,$limit&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$sqlget</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   SELECT * </span>
<span class="hh">   from $table $limit_clause</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sqlget</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlgetwhere">_sqlgetwhere</a></h3>
<p>Used for getting the registry via name, 
can be used for usernames, also</p>
<p>As of 06/2007 now needs tidying up</p>
<pre>
<a name="_sqlgetwhere-"></a><span class="k">sub </span><span class="m">_sqlgetwhere</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlgetwhere</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$limit_clause</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$offset</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$offset</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$limit_clause</span> = <span class="q">&quot;LIMIT $offset,$limit&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$name</span> <span class="k">ne</span> <span class="q">&quot;*&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT * FROM $table WHERE $fieldname = \&#39;$name\&#39; ORDER BY $fieldname $limit_clause </span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT * FROM $table WHERE $fieldname = \&#39;$name\&#39; ORDER BY tradeDate DESC $limit_clause </span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT * FROM $table WHERE 1 ORDER BY $fieldname $limit_clause</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

            <span class="i">$sqlgetwhere</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT * FROM $table 1 ORDER BY tradeDate DESC $limit_clause </span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$sqlgetwhere</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqldelete">_sqldelete</a></h3>
<p>delete record via id only</p>
<pre>
<a name="_sqldelete-"></a><span class="k">sub </span><span class="m">_sqldelete</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$id</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqldelete</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   DELETE FROM $table WHERE ($fieldname = $id)</span>
<span class="h">EOT</span>
    <span class="k">return</span> <span class="i">$sqldelete</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlinsert">_sqlinsert</a></h3>
<p>Insert a record now made general, will insert into any table, 
column definitions are provided via 'describe table_name' done before this
note please stick to 'id' for an id/primary key, makes life simpler
this is inherited from Mose etc... userId, tradeId hence the complex
regex test below.</p>
<pre>
<a name="_sqlinsert-"></a><span class="k">sub </span><span class="m">_sqlinsert</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@values</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$value_string</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">get_table_columns</span><span class="s">(</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsstring</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@columns</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$column_name</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">next</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$column_name</span> =~ <span class="q">/^id|^Id|^userId|^tradeId/</span> <span class="s">)</span>
          <span class="sc">;</span>    <span class="c"># don&#39;t put id into this</span>
        <span class="k">push</span> <span class="i">@values</span><span class="cm">,</span> <span class="q">&quot;&#39;$fields{$column_name}&#39;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># string out the field values for the insert</span>
    <span class="i">$value_string</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@values</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlinsert</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   INSERT INTO $tablename (</span>
<span class="hh">     $fieldsstring</span>
<span class="hh">   ) VALUES (</span>
<span class="hh">    NULL,</span>
<span class="hh">    $value_string </span>
<span class="hh">   )</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sqlinsert</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlupdate">_sqlupdate</a></h3>
<p>Update a record
only the fields supplied run into the update, unlike insert
in which ALL the columns are initialised.</p>
<pre>
<a name="_sqlupdate-"></a><span class="k">sub </span><span class="m">_sqlupdate</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$dbh</span><span class="cm">,</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$useid</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$value_string</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$id_field</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span> = <span class="i">get_table_columns</span><span class="s">(</span> <span class="i">$tablename</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsstring</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,\n&quot;</span><span class="cm">,</span> <span class="i">@columns</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$column_name</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="s">(</span> <span class="i">$id_field</span> = <span class="i">$column_name</span> <span class="s">)</span> &amp;&amp; <span class="k">next</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$column_name</span> =~ <span class="q">/^id|^userId|^tradeId/</span> &amp;&amp; <span class="i">$useid</span> == <span class="n">1</span> <span class="s">)</span>
          <span class="sc">;</span>    <span class="c"># don&#39;t put id into this</span>

        <span class="s">(</span> <span class="s">(</span> <span class="i">$id_field</span> = <span class="i">$column_name</span> <span class="s">)</span> &amp;&amp; <span class="k">next</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$column_name</span> =~ <span class="q">/userLogin/</span> &amp;&amp; <span class="i">$useid</span> == <span class="n">2</span> <span class="s">)</span>
          <span class="sc">;</span>    <span class="c"># don&#39;t put id into this</span>

        <span class="i">$value_string</span> .= <span class="q">&quot;$column_name \= \&#39;$fields{$column_name}\&#39;,\n&quot;</span>

  <span class="c">#FIXME: ugly hack to zeroise commitlimit field in om_registry if blank 11/2008</span>
          <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$fields</span>{<span class="i">$column_name</span>} <span class="s">)</span>
            || <span class="i">$fields</span>{<span class="i">$column_name</span>} =~ <span class="q">m/commitlimit/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#FIXME: ugly hack to blank latest_news field in om_registry if blank 11/2009</span>
    <span class="i">$value_string</span> .= <span class="q">&quot;latest_news \= \&#39;\&#39;,\n&quot;</span>
      <span class="k">if</span> <span class="s">(</span> <span class="s">(</span> !<span class="k">defined</span> <span class="i">$fields</span>{<span class="w">latest_news</span>} <span class="s">)</span>
        || <span class="s">(</span> !<span class="k">length</span> <span class="i">$fields</span>{<span class="w">latest_news</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$value_string</span> =~ <span class="q">s/,$//</span><span class="sc">;</span>    <span class="c"># remove the last comma!</span>
    <span class="c">###$log-&gt;debug(&quot;value string is $value_string&quot;) ;</span>
    <span class="k">my</span> <span class="i">$sqlupdate</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   UPDATE $tablename </span>
<span class="hh">   SET</span>
<span class="hh">   $value_string </span>
<span class="hh">   WHERE ( $id_field = &#39;$fields{$id_field}&#39;)</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$sqlupdate</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_sqlcount">_sqlcount</a></h3>
<p>This is only tested for the transactions table at present
counts transactions for the logged in user.</p>
<pre>
<a name="_sqlcount-"></a><span class="k">sub </span><span class="m">_sqlcount</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$value</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlcount</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$sqlstring</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$sqlcount</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">     SELECT COUNT(*) FROM $table</span>
<span class="hh">      WHERE $fieldname = &#39;$value&#39;  GROUP BY $fieldname</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$sqlcount</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">    SELECT COUNT(*) FROM $table</span>
<span class="hh">     WHERE $sqlstring  </span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># removed group by fieldname from second statement</span>
    <span class="k">return</span> <span class="i">$sqlcount</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="makebutton">makebutton</a></h3>
<p>Make button needs serious work, mixture of array for record
and extras_hash_ref for extra floating fields is very ugly</p>
<p>Values in extras override database values if there's
name collision. It's assumed that the extras are tailor made</p>
<p>it also currently isn't very multilingual - another problem
</p>
<pre>

label is the label on the push button, action is the name
of the action in the controller.</pre>
<pre>
<a name="makebutton-"></a><span class="k">sub </span><span class="m">makebutton</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$label</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$arrayref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> =
      <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@row</span> = <span class="i">@$arrayref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$formfields</span><span class="cm">,</span> <span class="i">$x</span><span class="cm">,</span> <span class="i">$senddetected</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span> = <span class="i">_registry_connect</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@fieldnames</span> = <span class="i">get_table_columns</span><span class="s">(</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$dbh</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$x</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$field</span> <span class="s">(</span><span class="i">@fieldnames</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$field</span> !~ <span class="q">/Send|Go/</span> <span class="s">)</span> <span class="s">{</span>

            <span class="c"># hack because of &#39;name&#39; collision in currencies table</span>
            <span class="i">$field</span> = <span class="q">&quot;cname&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_currencies&#39;</span> &amp;&amp; <span class="i">$x</span> == <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$field</span> = <span class="q">&quot;dname&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_partners&#39;</span>   &amp;&amp; <span class="i">$x</span> == <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c">#</span>
            <span class="c"># only need id info within a delete button</span>
            <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;delete&quot;</span> &amp;&amp; <span class="i">$field</span> !~ <span class="q">/id$/i</span> <span class="s">)</span><span class="sc">;</span>

            <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;$field&quot; value=&quot;$row[$x]&quot;&gt;</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input  type=&quot;submit&quot; name=&quot;$field&quot; value=&quot;$field&quot;&gt;</span>
<span class="h">EOT</span>
            <span class="i">$senddetected</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># endif</span>
        <span class="i">$x</span>++<span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># end foreach</span>

    <span class="c"># add a template into resulttemplate</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;display&quot;</span> || <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;template&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$template</span> = <span class="i">_choosetemplate</span><span class="s">(</span> <span class="s">(</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$formfields</span> .= <span class="i">$template</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$senddetected</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;subaction&quot; value=&quot;$table&quot;&gt;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;$action&quot;&gt;</span>
<span class="hh"> &lt;input class=&quot;$class&quot; type=&quot;submit&quot; name=&quot;go&quot; value=&quot;\u$label&quot;&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$button</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;form class=&quot;pme-form&quot; action=&quot;$$fieldsref{home}&quot; method=&quot;POST&quot;&gt;</span>
<span class="hh">$formfields</span>
<span class="hh">&lt;/form&gt;</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$button</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_choosetemplate">_choosetemplate</a></h3>
<p>Choose a template for display items when making
buttons. This is ugly, since choice of templates is
hardcoded into the code</p>
<pre>
<a name="_choosetemplate-"></a><span class="k">sub </span><span class="m">_choosetemplate</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%templates</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$template</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;display&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">%templates</span> = <span class="q">qw(om_yellowpages displayyellowpage.html</span>
          <span class="q">om_trades displaytransaction.html</span>
          <span class="q">om_users displayuser.html</span>
        <span class="q">)</span><span class="sc">;</span>
        <span class="i">$template</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;resulttemplate&quot; value=&quot;$templates{$table}&quot;&gt;</span>
<span class="h">EOT</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;template&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">%templates</span> = <span class="q">qw(om_users users.html</span>
          <span class="q">om_currencies modcurrency.html</span>
          <span class="q">om_trades displaytransaction.html</span>
          <span class="q">om_yellowpages modifyyellowpage.html</span>
          <span class="q">om_partners modpartners.html</span>
        <span class="q">)</span><span class="sc">;</span>
        <span class="i">$template</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;name&quot; value=&quot;$templates{$table}&quot;&gt;</span>
<span class="h">EOT</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$template</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="makebox">makebox</a></h3>
<p>make a tick box for deletions etc.
currently unused at 8/2005</p>
<pre>
<a name="makebox-"></a><span class="k">sub </span><span class="m">makebox</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$url</span><span class="cm">,</span> <span class="i">$action_name</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$extras_hash_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;hidden&quot; name=&quot;subaction&quot; value=&quot;$table&quot;&gt;</span>
<span class="h">EOT</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$extras_hash_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> &lt;input type=&quot;checkbox&quot; name=&quot;$key&quot; value=&quot;$id&quot;&gt; $action_name</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$formfields</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="makelink">makelink</a></h3>
<p>make a content rich link for emails etc.</p>

<pre>
<a name="makelink-"></a><span class="k">sub </span><span class="m">makelink</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$url</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$formfields</span><span class="cm">,</span> <span class="i">$senddetected</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$formfields</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   $key=$fields{$key}&amp;</span>
<span class="h">EOT</span>

    <span class="s">}</span>    <span class="c"># end foreach</span>

    <span class="k">my</span> <span class="i">$button</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">     $url?$formfields</span>
<span class="h">EOT</span>

    <span class="k">return</span> <span class="i">$button</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
