<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Cclite.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Cclite.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#get_basic_credentials">get_basic_credentials</a></li>
			<li><a href="#add_user">add_user</a></li>
			<li><a href="#logon_user">logon_user</a></li>
			<li><a href="#_compare_password_or_api_key">_compare_password_or_api_key</a></li>
			<li><a href="#logoff_user">logoff_user</a></li>
			<li><a href="#get_news">get_news</a></li>
			<li><a href="#find_records">find_records</a></li>
			<li><a href="#show_user">show_user</a></li>
			<li><a href="#change_language">change_language</a></li>
			<li><a href="#modify_user">modify_user</a></li>
			<li><a href="#delete_user">delete_user</a></li>
			<li><a href="#make_uri_and_proxy">make_uri_and_proxy</a></li>
			<li><a href="#find_item">find_item</a></li>
			<li><a href="#wrapper_for_check_user_and_add_trade">wrapper_for_check_user_and_add_trade</a></li>
			<li><a href="#check_user_and_add_trade">check_user_and_add_trade</a></li>
			<li><a href="#split_transaction">split_transaction</a></li>
			<li><a href="#directpay">directpay</a></li>
			<li><a href="#transaction">transaction</a></li>
			<li><a href="#create_transaction_mirror">create_transaction_mirror</a></li>
			<li><a href="#delete_trade">delete_trade</a></li>
			<li><a href="#find_and_delete_trade">find_and_delete_trade</a></li>
			<li><a href="#modify_trade">modify_trade</a></li>
			<li><a href="#find_and_modify_trade">find_and_modify_trade</a></li>
			<li><a href="#get_many_items">get_many_items</a></li>
			<li><a href="#get_trades">get_trades</a></li>
			<li><a href="#collect_items">collect_items</a></li>
			<li><a href="#notify_by_mail">notify_by_mail</a></li>
			<li><a href="#windows_notifybymail">windows_notifybymail</a></li>
			<li><a href="#forgotten_password">forgotten_password</a></li>
			<li><a href="#show_balance_and_volume">show_balance_and_volume</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Cclite-">package Cclite</a>
<ul>
<li><a href="#SOAP::Transport::HTTP::Client::get_basic_credentials-">SOAP::Transport::HTTP::Client::get_basic_credentials</a></li>
<li><a href="#add_user-">add_user</a></li>
<li><a href="#confirm_user-">confirm_user</a></li>
<li><a href="#logon_user-">logon_user</a></li>
<li><a href="#_compare_password_or_api_key-">_compare_password_or_api_key</a></li>
<li><a href="#logoff_user-">logoff_user</a></li>
<li><a href="#get_news-">get_news</a></li>
<li><a href="#find_records-">find_records</a></li>
<li><a href="#show_user-">show_user</a></li>
<li><a href="#change_language-">change_language</a></li>
<li><a href="#modify_user-">modify_user</a></li>
<li><a href="#delete_user-">delete_user</a></li>
<li><a href="#make_uri_and_proxy-">make_uri_and_proxy</a></li>
<li><a href="#find_item-">find_item</a></li>
<li><a href="#wrapper_for_check_user_and_add_trade-">wrapper_for_check_user_and_add_trade</a></li>
<li><a href="#check_user_and_add_trade-">check_user_and_add_trade</a></li>
<li><a href="#split_transaction-">split_transaction</a></li>
<li><a href="#directpay-">directpay</a></li>
<li><a href="#transaction-">transaction</a></li>
<li><a href="#create_transaction_mirror-">create_transaction_mirror</a></li>
<li><a href="#delete_trade-">delete_trade</a></li>
<li><a href="#find_and_delete_trade-">find_and_delete_trade</a></li>
<li><a href="#modify_trade-">modify_trade</a></li>
<li><a href="#find_and_modify_trade-">find_and_modify_trade</a></li>
<li><a href="#get_many_items-">get_many_items</a></li>
<li><a href="#get_trades-">get_trades</a></li>
<li><a href="#collect_items-">collect_items</a></li>
<li><a href="#notify_by_mail-">notify_by_mail</a></li>
<li><a href="#windows_notifybymail-">windows_notifybymail</a></li>
<li><a href="#forgotten_password-">forgotten_password</a></li>
<li><a href="#show_balance_and_volume-">show_balance_and_volume</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Cclite.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Cclite main model</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is the second prototype perl web services version of the CClite package for use
with soap lite/c#/dotnet etc.</p>
<p>The design philosophy is as follows:</p>
<pre>
  - simplicity, small number of lines of code
  - use SHA2 based hashing to preserve integrity
  - use MySql for storage, first version used filestore
  - many validation checks, especially on transactions
  - everything should return at least a status, passed up the return chain
 
Nearly everything that is not Mysql is a hash,</pre>
<p>Integrity individual SHA2 fingerprints on the transactions and for the
SMS messages. Secure transmission is proposed via https which will
also work for SOAP (a large to-be-done).</p>
<p>This Cclite package should contain anything/everything that is to be exposed
as an external web service. This is not true now and needs tidying
up.</p>
<p>These functions assume that all the local data has been validated
Probably this is done via Ccvalidate.pm. 
There are extra actions for remote registry checks already</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2004-2007 GPL Licenced</p>
<pre>
<a name="package-Cclite-"></a><span class="k">package </span><span class="i">Cclite</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>

<span class="c"># new way of doing mail</span>
<span class="k">use</span> <span class="w">Mail::Sendmail</span> <span class="q">qw(sendmail %mailcfg)</span><span class="sc">;</span>

<span class="c"># notify by mail is exported now, to allow sms/email notifies</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span>    = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="i">@EXPORT</span> = <span class="q">qw(add_user</span>
  <span class="q">modify_user</span>
  <span class="q">show_user</span>
  <span class="q">confirm_user</span>
  <span class="q">change_language</span>
  <span class="q">logon_user</span>
  <span class="q">logoff_user</span>
  <span class="q">collect_items</span>
  <span class="q">get_user</span>
  <span class="q">get_news</span>
  <span class="q">get_trades</span>
  <span class="q">delete_trade</span>
  <span class="q">find_and_delete_trade</span>
  <span class="q">modify_trade</span>
  <span class="q">notify_by_mail</span>
  <span class="q">find_and_modify_trade</span>
  <span class="q">forgotten_password</span>
  <span class="q">find_records</span>
  <span class="q">show_balance_and_volume</span>
  <span class="q">sms_transaction</span>
  <span class="q">get_next_user</span>
  <span class="q">get_items</span>
  <span class="q">get_many_items</span>
  <span class="q">delete_user</span>
  <span class="q">split_transaction</span>
  <span class="q">directpay</span>
  <span class="q">transaction</span>
  <span class="q">check_user_and_add_trade</span>
  <span class="q">wrapper_for_check_user_and_add_trade</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash
</p>
<pre>

=cut</pre>
<pre>
<span class="k">our</span> <span class="i">%messages</span>    = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$messagesref</span> = \<span class="i">%messages</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$log</span>         = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;Cclite&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="get_basic_credentials">get_basic_credentials</a></h3>
<p>SOAP basic endpoint authentication: needs configuration file parameters and
general beefing up. This example will authenticate a user 'transport'
with a password of 'test'</p>
<p>One potential problem is managing the user/password values in this</p>
<pre>
<a name="SOAP::Transport::HTTP::Client::get_basic_credentials-"></a><span class="k">sub </span><span class="m">SOAP::Transport::HTTP::Client::get_basic_credentials</span> <span class="s">{</span>
    <span class="k">return</span> <span class="q">&#39;transport&#39;</span> <span class="cm">=&gt;</span> <span class="q">&#39;test&#39;</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="add_user">add_user</a></h3>
<p>Add a user to the user table
$class added to some routines for cclite web services access</p>
<p>Normally a user is validated via email and becomes active at that
point. See manual for how to switch this off</p>
<p>A stub user via the drupal (and soon Elgg) passthrough  can also be added
here, in this case, validation is skipped. August 2009</p>
<pre>
<a name="add_user-"></a><span class="k">sub </span><span class="m">add_user</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hash</span>       = <span class="q">&quot;&quot;</span><span class="sc">;</span>                 <span class="c"># for the moment, needs sha1 afterwards</span>
    <span class="k">my</span> <span class="i">$return_url</span> = <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="sc">;</span>

    <span class="c"># need nuserLogin field to make the autosuggest work in ccsuggest.cgi</span>
    <span class="c"># but must put correct field into the database</span>

    <span class="c"># lower case only screen names, as of 11/2008</span>
    <span class="i">$$fieldsref</span>{<span class="w">nuserLogin</span>} =~ <span class="q">s/\s+$//</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>} = <span class="k">lc</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">nuserLogin</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># api user creation gives non-validated stub records</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">logontype</span>} <span class="k">ne</span> <span class="q">&#39;api&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">@status</span> =
          <span class="i">validate_user</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>
            <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span>[<span class="n">0</span>] == <span class="n">-1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">shift</span> <span class="i">@status</span><span class="sc">;</span>
            <span class="i">$$fieldsref</span>{<span class="w">errors</span>} = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;newuser.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># new users are set to initial status defined in cclite.cgi</span>
    <span class="i">$$fieldsref</span>{<span class="w">userStatus</span>} = <span class="i">$$fieldsref</span>{<span class="w">initialUserStatus</span>}<span class="sc">;</span>

    <span class="c"># FIXME: These should not be hardcoded, 3 tries, not test yet + active</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPasswordTries</span>}  = <span class="n">3</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPasswordStatus</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userJoindate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="i">$$fieldsref</span>{<span class="w">userLevel</span>}    = <span class="q">&#39;user&#39;</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>} = <span class="i">$$fieldsref</span>{<span class="w">userHash</span>}<span class="sc">;</span>

<span class="c"># mobile pin number is stored as hashed, status waiting, phone number reformatted</span>
<span class="c"># pin status is always waiting until a confirm sms, 3 tries then locked</span>
<span class="c"># FIXME: Most of these should not be hardcoded</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPin</span>}       = <span class="i">text_to_hash</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPinStatus</span>} = <span class="q">&#39;waiting&#39;</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPinTries</span>}  = <span class="n">3</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} = <span class="i">format_for_uk_mobile</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userMobile</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># add the user to the registry database</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$rv</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="k">delete</span> <span class="i">$$fieldsref</span>{<span class="w">saveadd</span>}<span class="sc">;</span>
    <span class="k">delete</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>}<span class="sc">;</span>

    <span class="c">#</span>
    <span class="i">$$fieldsref</span>{<span class="w">action</span>}     = <span class="q">&quot;confirmuser&quot;</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">userStatus</span>} = <span class="q">&quot;active&quot;</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">Send</span>}       = <span class="q">&quot;$messages{confirm} $$fieldsref{userName}&quot;</span><span class="sc">;</span>

<span class="c"># make a hyperlink: many people will receive text-only email, therefore no buttons</span>
    <span class="k">my</span> <span class="i">$urlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$return_url?registry=$$fieldsref{registry}&amp;subaction=om_users&amp;userLogin=$$fieldsref{userLogin}&amp;userStatus=active&amp;action=confirmuser</span>
<span class="h">EOT</span>

    <span class="c"># type 1 notification for new user</span>
    <span class="c"># modified 11/2008, give a return from the attempt to send mail</span>
    <span class="c"># won&#39;t send email if user is intially active as default, saves an email!</span>
    <span class="k">my</span> <span class="i">$mail_return</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">initialUserStatus</span>} <span class="k">ne</span> <span class="q">&#39;active&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$mail_return</span> = <span class="i">notify_by_mail</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>
            <span class="i">$db</span><span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">userName</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">userEmail</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">systemMailAddress</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">systemMailReplyAddress</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">smtp</span>}<span class="cm">,</span>
            <span class="i">$urlstring</span><span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span>
            <span class="n">1</span><span class="cm">,</span>
            <span class="i">$hash</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$return_url</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>
        <span class="q">&quot;$messages{useradded} &lt;br/&gt; $mail_return&quot;</span><span class="cm">,</span>
        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># make a user active in the database usually via reception</span>
<span class="c"># of an email, move to here to provide a little feedback</span>

<a name="confirm_user-"></a><span class="k">sub </span><span class="m">confirm_user</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="i">update_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="w">language</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>
        <span class="q">&quot;$$fieldsref{userLogin} $messages{isnowactive}&quot;</span><span class="cm">,</span>
        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="logon_user">logon_user</a></h3>
<p>Logon a remote web user</p>
<p>no remote access for this, put somewhere else? Ccsecure?
by this I mean, doesn't need/want exposure as web service...
need to check whether user is already logged on: new field
need to check whether the user is confirmed, otherwise: no login
need to log failures: new table om_log and log_violation in Ccsecure
need to cumulate cascading return codes</p>
<p>Extended for api key style logon, compares key and then gives same
set of tokens etc. as for the individual user</p>
<p>Ugliness at the bottom of this, for moving the user to the correct
start page via print Location. 10/2009</p>
<pre>
<a name="logon_user-"></a><span class="k">sub </span><span class="m">logon_user</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$registry_private_value</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$offset</span> <span class="s">)</span><span class="sc">;</span>                                   <span class="c"># unused here ;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">%cookie</span><span class="cm">,</span> <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fail</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># set to 1 if logon failure, for better refresh experience</span>
         <span class="c"># get the user record from the database, depending on login type</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># merchant key delivered as cookie</span>
    <span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># user delivered via REST, same as form....</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">logontype</span>} <span class="k">eq</span> <span class="q">&#39;form&#39;</span> || <span class="i">$$fieldsref</span>{<span class="w">logontype</span>} <span class="k">eq</span> <span class="q">&#39;api&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="q">&quot;userLogin&quot;</span><span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="i">$registry_private_value</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># test and branch to deal with bad db user and non-existent database, used  to 500</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;logon database problem: s:$status u:$$fieldsref{userLogin} r:$$fieldsref{registry}&quot;</span>
            <span class="s">)</span><span class="sc">;</span>
            <span class="i">$html</span> =
<span class="q">&quot;$messages{loginfailedfor} $$fieldsref{userLogin} $messages{at} $$fieldsref{registry}: $status &lt;a href=\&quot;$$fieldsref{home}\&quot;&gt;$messages{tryagain}&lt;/a&gt;&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
                <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">logontype</span>} <span class="k">eq</span> <span class="q">&#39;remote&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="q">&quot;userLogin&quot;</span><span class="cm">,</span>
            <span class="i">$ENV</span>{<span class="w">REMOTE_USER</span>}<span class="cm">,</span> <span class="i">$registry_private_value</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># login failed here...need some industrial processing to deal with this</span>
    <span class="c"># no user found</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userId</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;$messages{loginfailedfor} $$fieldsref{userLogin} $messages{at} $$fieldsref{registry} : user not found&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">$html</span> =
<span class="q">&quot;$messages{loginfailedfor} $$fieldsref{userLogin} $messages{at} $$fieldsref{registry}: $status &lt;a href=\&quot;$$fieldsref{home}\&quot;&gt;$messages{tryagain}&lt;/a&gt;&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
            <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">elsif</span>

      <span class="c"># compares password from form or api key from initial cookie</span>
      <span class="s">(</span>
        !<span class="i">_compare_password_or_api_key</span><span class="s">(</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$userref</span><span class="cm">,</span> <span class="i">$registry_private_value</span>
        <span class="s">)</span>
      <span class="s">)</span>

    <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;$messages{loginfailedfor} $$fieldsref{userLogin} $messages{at} $$fieldsref{registry} : password failed&quot;</span>
        <span class="s">)</span><span class="sc">;</span>

<span class="c">#FIXME: The locking mechanism is in place but nothing for resetting and testing, bigger job...</span>
        <span class="i">$$userref</span>{<span class="w">userPasswordTries</span>}--<span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$userref</span>{<span class="q">&#39;userPasswordTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$userref</span>{<span class="q">&#39;userPasswordStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$$userref</span>{<span class="w">userPasswordTries</span>} = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">undef</span>
          <span class="i">$$userref</span>{<span class="w">userPassword</span>}<span class="sc">;</span> <span class="c"># remove this otherwise it&#39;s rehashed and re-update</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="cm">,</span> <span class="i">$c</span><span class="cm">,</span> <span class="i">$d</span> <span class="s">)</span> =
          <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="i">$userref</span><span class="cm">,</span>
            <span class="i">$$userref</span>{<span class="w">language</span>}<span class="cm">,</span> <span class="i">$cookie</span>{<span class="w">token</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="i">$html</span> =
<span class="q">&quot;$messages{passwordfailedfor} $$fieldsref{userLogin} $messages{at} $db &lt;a href=\&quot;$$fieldsref{home}\&quot;&gt;$messages{tryagain}&lt;/a&gt;&quot;</span><span class="sc">;</span>

        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
            <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># user not active</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userStatus</span>} <span class="k">ne</span> <span class="q">&#39;active&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$html</span> =
<span class="q">&quot;$$fieldsref{userLogin} $messages{at} $db $messages{isnotactive} &lt;a href=\&quot;$$fieldsref{home}\&quot;&gt;$messages{tryagain}&lt;/a&gt;&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
            <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># login success</span>
        <span class="k">my</span> <span class="i">$path</span> = <span class="q">&quot;/&quot;</span><span class="sc">;</span>

        <span class="c">#my $nonce;</span>
        <span class="k">my</span> <span class="i">$domain</span> = <span class="i">$$fieldsref</span>{<span class="w">domain</span>}<span class="sc">;</span>

        <span class="k">my</span> <span class="i">$ip_address</span> = <span class="i">$ENV</span>{<span class="w">REMOTE_ADDR</span>}<span class="sc">;</span>
        <span class="c">###$log-&gt;debug(&quot;in logon: $registry_private_value $$userref{userLogin} $ENV{REMOTE_ADDR}&quot;) ;</span>
        <span class="c"># cookie is produced this time, not checked</span>
        <span class="s">(</span> <span class="i">$cookie</span>{<span class="q">&#39;token&#39;</span>}<span class="cm">,</span> <span class="i">$cookie</span>{<span class="q">&#39;token1&#39;</span>} <span class="s">)</span> =
          <span class="i">calculate_token</span><span class="s">(</span> <span class="i">$registry_private_value</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$ip_address</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># make cookie fields from the user table</span>
        <span class="i">$cookie</span>{<span class="w">userLogin</span>} = <span class="i">$$userref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>
        <span class="i">$cookie</span>{<span class="w">userId</span>} =
          <span class="i">$$userref</span>{<span class="w">userId</span>}<span class="sc">;</span>    <span class="c"># not used yet, to replace userLogin</span>
        <span class="i">$cookie</span>{<span class="w">language</span>} = <span class="i">$$userref</span>{<span class="w">userLang</span>}<span class="sc">;</span>

  <span class="c"># avoid cumulation of registry cookie values, this is a browser problem though</span>
        <span class="i">$cookie</span>{<span class="w">registry</span>} = <span class="i">$$cookieref</span>{<span class="w">registry</span>} || <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="sc">;</span>

        <span class="i">$cookie</span>{<span class="w">userLevel</span>} = <span class="i">$$userref</span>{<span class="w">userLevel</span>}<span class="sc">;</span>

        <span class="c"># make a cookie header, valid for session</span>
        <span class="i">$cookieheader</span> =
          <span class="i">return_cookie_header</span><span class="s">(</span> <span class="q">&quot;-1&quot;</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$path</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">%cookie</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># calculate date and time stamp for om_users table</span>
        <span class="c"># get date and timestamp</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$$userref</span>{<span class="w">userLastLogin</span>} = <span class="q">&quot;$date$time&quot;</span><span class="sc">;</span>
        <span class="k">undef</span>
          <span class="i">$$userref</span>{<span class="w">userPassword</span>}<span class="sc">;</span> <span class="c"># remove this otherwise it&#39;s rehashed and re-update</span>
                                   <span class="c"># mode 2 is where userLogin = value ;</span>
            <span class="c"># use userref to update record, should strip all other fields...</span>
            <span class="c"># throw away return codes for the present</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="cm">,</span> <span class="i">$c</span><span class="cm">,</span> <span class="i">$d</span> <span class="s">)</span> =
          <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="i">$userref</span><span class="cm">,</span>
            <span class="i">$$userref</span>{<span class="w">language</span>}<span class="cm">,</span> <span class="i">$cookie</span>{<span class="w">token</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="k">print</span> <span class="i">$cookieheader</span> <span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;Location:$$fieldsref{home}\n\n&quot;</span><span class="sc">;</span>
        <span class="c">### print &quot;Location:$ENV{SCRIPT_PATH}\n\n&quot;;</span>
        <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>

    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_compare_password_or_api_key">_compare_password_or_api_key</a></h3>
<p>Offload the gradually more complex logic for password checking</p>
<pre>
<a name="_compare_password_or_api_key-"></a><span class="k">sub </span><span class="m">_compare_password_or_api_key</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$userref</span><span class="cm">,</span> <span class="i">$registry_private_value</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$passed</span>           = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$compare_password</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$compare_api_key</span>  = <span class="n">0</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">logontype</span>} <span class="k">eq</span> <span class="q">&#39;form&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$compare_password</span> =
          <span class="i">compare_password</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userHash</span>}<span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">userPassword</span>}<span class="cm">,</span>
            <span class="i">$$userref</span>{<span class="w">userPassword</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="c"># password failed and it comes from the api key hash</span>
    <span class="c"># first cut drupal and elgg etc. connections 08/2009</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">logontype</span>} <span class="k">eq</span> <span class="q">&#39;api&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$compare_api_key</span> =
          <span class="i">compare_api_key</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span>
            <span class="i">$$cookieref</span>{<span class="q">&#39;merchant_key_hash&#39;</span>}<span class="cm">,</span>
            <span class="i">$registry_private_value</span> <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span>
<span class="q">&quot;in password compare compare_password:$compare_password compare_api_key:$compare_api_key  logontype: $$fieldsref{logontype}&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$passed</span> = <span class="n">1</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$compare_password</span> || <span class="i">$compare_api_key</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$passed</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="logoff_user">logoff_user</a></h3>
<p>Logoff a web user
Again this should probably be moved away from Cclite</p>
<pre>
<a name="logoff_user-"></a><span class="k">sub </span><span class="m">logoff_user</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="i">$registry_private_value</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$offset</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># unused here ;</span>
    <span class="k">my</span> <span class="i">$path</span>    = <span class="q">&quot;/&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$domain</span>  = <span class="i">$$fieldsref</span>{<span class="w">domain</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$home</span>    = <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">%cookies</span> = <span class="i">%$cookieref</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">youare</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">at</span>}     = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">action</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%cookies</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$cookies</span>{<span class="i">$key</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># make a cookie header</span>
    <span class="k">my</span> <span class="i">$cookieheader</span> =
      <span class="i">return_cookie_header</span><span class="s">(</span> <span class="q">&quot;-1&quot;</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$path</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">%cookies</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span> = <span class="q">&quot;$messages{goodbye} $$cookieref{userLogin}&quot;</span><span class="sc">;</span>
    <span class="i">&amp;Ccu::display_template</span><span class="s">(</span>
        <span class="q">&quot;1&quot;</span><span class="cm">,</span>    <span class="i">$home</span><span class="cm">,</span>         <span class="q">&quot;&quot;</span><span class="cm">,</span>         <span class="i">$html</span><span class="cm">,</span>
        <span class="i">$pages</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieheader</span><span class="cm">,</span>
        <span class="q">&quot;&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_news">get_news</a></h3>
<p>Get news from registry table in database
There's only one record which contains a news field</p>
<pre>
<a name="get_news-"></a><span class="k">sub </span><span class="m">get_news</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># get the first (and only..) record within the registry table</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&quot;om_registry&quot;</span><span class="cm">,</span> <span class="q">&quot;id&quot;</span><span class="cm">,</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># this is messy but don&#39;t want the box, if empty</span>
    <span class="k">return</span> <span class="i">$$registryref</span>{<span class="w">latest_news</span>}<span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="find_records">find_records</a></h3>
<p>Find database records
provides a list as return</p>
<p>create a large 'or' for textual fields and then find
cookieref processed to get logon field
specific for finding trades at present</p>
<p>04/2005 this was moved from Cclitedb and the database
part was split and moved into the database part</p>
<p>05/2007 somewhat re-written to be slightly less messy,
some way to go though...</p>
<pre>
<a name="find_records-"></a><span class="k">sub </span><span class="m">find_records</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">@row</span><span class="cm">,</span> <span class="i">$home</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$allow_changes</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># used only to avoid repeating a complex test</span>

   <span class="c"># take into account string1, string2, string3 used in the new ajax find forms</span>

    <span class="i">$$fieldsref</span>{<span class="w">string</span>} = <span class="i">$$fieldsref</span>{<span class="w">string1</span>}
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">string1</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">string</span>} = <span class="i">$$fieldsref</span>{<span class="w">string2</span>}
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">string2</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">string</span>} = <span class="i">$$fieldsref</span>{<span class="w">string3</span>}
      <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">string3</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$column_array_ref</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
      <span class="i">find_database_records</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$i</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@columns</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$paging_html</span> = <span class="i">Ccu::make_page_links</span><span class="s">(</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span>
      <span class="sc">;</span>    <span class="c"># make links for all pages</span>
    <span class="k">my</span> <span class="i">$colspan</span>        = <span class="n">0</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_counter</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row_ref</span> <span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$id</span> = <span class="i">$$row_ref</span>[<span class="n">0</span>]<span class="sc">;</span>

        <span class="c"># there&#39;s always a display button</span>
        <span class="k">my</span> <span class="i">$display_button</span> =
          <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">show</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;display&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$row_ref</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># add a modify and delete button if a yellow pages record belongs to</span>
        <span class="c"># the logged on user or the user is an administrator</span>
        <span class="k">my</span> <span class="i">$delete_button</span> = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$modify_button</span> = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span>
            <span class="i">$$cookieref</span>{<span class="w">userLevel</span>} <span class="k">eq</span> <span class="q">&quot;admin&quot;</span>
            || <span class="s">(</span>   <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_yellowpages&quot;</span> <span class="s">)</span>
                &amp;&amp; <span class="s">(</span> <span class="i">$$row_ref</span>[<span class="n">5</span>] <span class="k">eq</span> <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>} <span class="s">)</span> <span class="s">)</span>
          <span class="s">)</span>
        <span class="s">{</span>

            <span class="i">$allow_changes</span> = <span class="n">1</span><span class="sc">;</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$delete_button</span> =
                  <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">delete</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;delete&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
                    <span class="i">$row_ref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

                <span class="c"># if the record is a trade, then the delete operation becomes</span>
                <span class="c"># &#39;modify the status to cancel&#39;</span>

                <span class="i">$delete_button</span> =
                  <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">cancel</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;canceltrade&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
                    <span class="i">$row_ref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

            <span class="s">}</span>

            <span class="i">$modify_button</span> =
              <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">modify</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;template&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
                <span class="i">$row_ref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>

        <span class="c"># this messily tidies up the fields in the column-wise displays</span>
        <span class="c"># can use sql for this later on</span>

        <span class="k">delete</span> <span class="i">@$row_ref</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">10</span> .. <span class="n">14</span> ] <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">delete</span> <span class="i">@$row_ref</span>[ <span class="n">4</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">7</span><span class="cm">,</span> <span class="n">9</span><span class="cm">,</span> <span class="n">11</span> .. <span class="n">18</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_yellowpages&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">@$row_ref</span> = <span class="i">@$row_ref</span>[ <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">16</span><span class="cm">,</span> <span class="n">17</span> .. <span class="n">19</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_users&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">unshift</span> <span class="i">@$row_ref</span><span class="cm">,</span> <span class="s">(</span> <span class="i">$display_button</span><span class="cm">,</span> <span class="i">$modify_button</span><span class="cm">,</span> <span class="i">$delete_button</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$row</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$entry</span> <span class="s">(</span><span class="i">@$row_ref</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$entry</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$row</span> .= <span class="q">&quot;&lt;td class=\&quot;pme-key-1\&quot;&gt;$entry&lt;/td&gt;&quot;</span><span class="sc">;</span>
                <span class="i">$colspan</span>++<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c"># make stripey styles</span>
        <span class="k">my</span> <span class="i">$row_style</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$record_counter</span> % <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$row_style</span> = <span class="q">&quot;odd&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$row_style</span> = <span class="q">&quot;even&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$row</span> = <span class="q">&quot;&lt;tr class=\&quot;$row_style\&quot;&gt;$row&lt;/tr&gt;\n&quot;</span><span class="sc">;</span>

        <span class="c"># kludge for debits class in row#</span>
        <span class="c"># this is monolingual and needs to be revisited</span>
        <span class="i">$row</span> =~ <span class="q">s/key-1/key-rejected/g</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span> =~ <span class="q">/rejected|declined/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$row</span> =~ <span class="q">s/key-1/key-debit/g</span>   <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span> =~ <span class="q">/debit/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$row</span> =~ <span class="q">s/key-\w+/key-split/g</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span> =~ <span class="q">/split/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$html</span> .= <span class="i">$row</span><span class="sc">;</span>
        <span class="i">$record_counter</span>++<span class="sc">;</span>

    <span class="s">}</span>    <span class="c"># end of loop for found records</span>

    <span class="k">my</span> <span class="i">$col_titles</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$header</span><span class="sc">;</span>

    <span class="c"># if there are results, use multilingual table title..</span>
    <span class="k">my</span> <span class="i">$table_title</span> = <span class="i">$messages</span>{<span class="i">$table</span>}<span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$count</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># edit the column headings</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span><span class="i">@$column_array_ref</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$$row</span>[<span class="n">0</span>] =~ <span class="q">s/trade|user//</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@columns</span><span class="cm">,</span> <span class="q">&quot;\u$$row[0]&quot;</span><span class="sc">;</span>    <span class="c"># make the heading columns uppercase</span>
        <span class="s">}</span>

        <span class="i">@columns</span> = <span class="i">@columns</span>[ <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">16</span><span class="cm">,</span> <span class="n">17</span> .. <span class="n">19</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_users&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">delete</span> <span class="i">@columns</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">10</span> .. <span class="n">14</span> ] <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">delete</span> <span class="i">@columns</span>[ <span class="n">4</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">7</span><span class="cm">,</span> <span class="n">9</span><span class="cm">,</span> <span class="n">11</span> .. <span class="n">18</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_yellowpages&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># make the column heading for buttons uppercase</span>
        <span class="k">unshift</span> <span class="i">@columns</span><span class="cm">,</span>
          <span class="s">(</span>
            <span class="q">&quot;\u$messages{display}&quot;</span><span class="cm">,</span> <span class="q">&quot;\u$messages{modify}&quot;</span><span class="cm">,</span> <span class="q">&quot;\u$messages{delete}&quot;</span>
          <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$row</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$entry</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$row</span> .= <span class="q">&quot;&lt;td class=\&quot;pme-key-title\&quot;&gt;$entry&lt;/td&gt;&quot;</span>
              <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$entry</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$row</span> = <span class="q">&quot;&lt;tr class=\&quot;smallgreytext\&quot;&gt;$row&lt;/tr&gt;\n&quot;</span><span class="sc">;</span>
        <span class="i">$col_titles</span> .= <span class="i">$row</span><span class="sc">;</span>

        <span class="i">$col_titles</span> = <span class="q">&quot;&lt;tr&gt;$col_titles&lt;/tr&gt;\n&quot;</span><span class="sc">;</span>

        <span class="i">$header</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">      &lt;tr&gt;</span>
<span class="hh">         &lt;td class=&quot;pme-key-title&quot; colspan=&quot;$colspan&quot;&gt;$paging_html $messages{found} $count $messages{recordswith} &quot;$$fieldsref{string}&quot; $messages{in} $table_title&lt;/td&gt;</span>
<span class="hh">     &lt;/tr&gt;</span>
<span class="h">EOT</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$header</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">      &lt;tr&gt;</span>
<span class="hh">         &lt;td class=&quot;pme-key-1&quot; colspan=&quot;$colspan&quot;&gt;$messages{found} $count $messages{recordswith} &quot;$$fieldsref{string}&quot; $messages{in} $table_title&lt;/td&gt;</span>
<span class="hh">         &lt;td class=&quot;pme-key-1&quot;&gt;&lt;/td&gt;</span>
<span class="hh">     &lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="i">$html</span> =
<span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$header $col_titles $html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_user">show_user</a></h3>
<p>show user profile including balance and volume and stubs
of each advert for a given user, near equivalent of
show_yellow for users</p>
<p>Also probably a candidate for batch processing
html needs removing or internationalizing</p>
<pre>
<a name="show_user-"></a><span class="k">sub </span><span class="m">show_user</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  SELECT DISTINCT u.userLogin,u.userName, userStatus,</span>
<span class="hh">                  u.userPostcode, u.userEmail,u.userMobile,</span>
<span class="hh">                  u.userTelephone, y.id, y.subject, y.description, </span>
<span class="hh">                  y.fromuserid, y.price, y.unit, y.tradeCurrency</span>
<span class="hh">  FROM om_yellowpages y, om_users u</span>
<span class="hh">  WHERE (</span>
<span class="hh">  y.fromuserid = u.userLogin AND u.userLogin = &#39;$$fieldsref{userLogin}&#39;)</span>
<span class="h">EOT</span>

    <span class="c"># get equi-joined table</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%report</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># get balance and volume for user to show in table ;</span>
    <span class="c">#</span>
    <span class="c"># pass $fieldsref into this, but it&#39;s unused within</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$balv</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$first_pass</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$counter</span>    = <span class="n">0</span><span class="sc">;</span>    <span class="c"># used for counting what goes on left and right</span>
    <span class="k">my</span> <span class="i">$userhtml</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$userimage</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$hash_key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>

<span class="c"># must be revisited this is wrongness! parasitic call to table because of fetchall_hashref!</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error2</span><span class="cm">,</span> <span class="i">$hash_ref1</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$hash_key</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$record_ref</span> = <span class="i">$hash_ref</span>-&gt;{<span class="i">$hash_key</span>}<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$save_subject</span><span class="sc">;</span>

        <span class="c"># find a way of using simple template substitution on these fragments</span>

        <span class="k">if</span> <span class="s">(</span><span class="i">$first_pass</span><span class="s">)</span> <span class="s">{</span>

<span class="c">### $userimage = &lt;&lt;EOT;</span>
<span class="c">###   &lt;img src=&quot;/images/$hash_ref-&gt;{$hash_key}-&gt;{userLogin}\056jpg&quot;&gt;</span>
<span class="c">### EOT</span>

            <span class="i">$userhtml</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &lt;tr&gt;&lt;td valign=&quot;top&quot; class=&quot;pme-key-title&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{userName} $messages{is} \u$hash_ref-&gt;{$hash_key}-&gt;{userStatus}&lt;/td&gt;</span>
<span class="hh">       &lt;td valign=&quot;top&quot; colspan=&quot;2&quot; class=&quot;pme-key-title&quot;&gt;&lt;a href=&quot;mailto:$hash_ref-&gt;{$hash_key}-&gt;{userEmail}?subject=$db&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{userEmail}&lt;/a&gt;&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;pme-key-1&quot;&gt;&lt;/td&gt;</span>
<span class="hh">   &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td valign=&quot;top&quot; colspan=&quot;3&quot; class=&quot;pme-key-1&quot;&gt;bal&lt;/td&gt;</span>
<span class="hh">       &lt;td valign=&quot;top&quot; class=&quot;pme-key-1&quot;&gt;&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;pme-key-1&quot;&gt;&lt;/td&gt;</span>
<span class="hh">   &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td valign=&quot;top&quot; class=&quot;pme-key-1&quot;&gt;$messages{postcode}&lt;/td&gt;</span>
<span class="hh">       &lt;td valign=&quot;top&quot; class=&quot;pme-key-1&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{userPostcode}&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;pme-key-1&quot;&gt;&lt;/td&gt;</span>
<span class="hh">   &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td valign=&quot;top&quot; class=&quot;pme-key-1&quot;&gt;$messages{telephone}&lt;/td&gt;</span>
<span class="hh">       &lt;td valign=&quot;top&quot; class=&quot;pme-key-1&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{userTelephone}&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;pme-key-1&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{userMobile}&lt;/td&gt;</span>
<span class="hh">   &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td colspan=&quot;3&quot; &gt;&lt;/td&gt;</span>
<span class="hh">       &lt;/tr&gt;</span>
<span class="h">EOT</span>

            <span class="i">$first_pass</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$record_ref</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$hash_ref</span>-&gt;{<span class="i">$hash_key</span>}-&gt;{<span class="w">subject</span>} <span class="k">ne</span> <span class="i">$save_subject</span> <span class="s">)</span> <span class="s">{</span>

                <span class="c"># colour code the advert summaries by changing the display class</span>
                <span class="c"># truelets is something that&#39;s paid at 100% in LETS</span>
                <span class="c">#</span>
                <span class="k">my</span> <span class="i">$dclass</span> = <span class="q">&quot;pme-key-1&quot;</span><span class="sc">;</span>    <span class="c"># default case</span>
                <span class="i">$dclass</span> = <span class="q">&quot;pme-key-green&quot;</span>
                  <span class="k">if</span> <span class="s">(</span> <span class="i">$$hash_ref1</span>{<span class="w">truelets</span>} <span class="k">eq</span> <span class="q">&quot;yes&quot;</span>
                    &amp;&amp; <span class="i">$$hash_ref1</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&quot;offered&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$dclass</span> = <span class="q">&quot;pme-key-1&quot;</span>
                  <span class="k">if</span> <span class="s">(</span> <span class="i">$$hash_ref1</span>{<span class="w">truelets</span>} <span class="k">ne</span> <span class="q">&quot;yes&quot;</span>
                    &amp;&amp; <span class="i">$$hash_ref1</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&quot;offered&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$dclass</span> = <span class="q">&quot;pme-key-debit&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$$hash_ref1</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&quot;wanted&quot;</span> <span class="s">)</span><span class="sc">;</span>

                <span class="c"># show &#39;per unit&#39; price if unit is valid</span>
                <span class="k">my</span> <span class="i">$per_unit</span> = <span class="q">&quot;$messages{per} $$hash_ref1{unit}&quot;</span>
                  <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$hash_ref1</span>{<span class="w">unit</span>} <span class="s">)</span>
                    &amp;&amp; <span class="i">$$hash_ref1</span>{<span class="w">unit</span>} <span class="k">ne</span> <span class="q">&#39;other&#39;</span> <span class="s">)</span><span class="sc">;</span>

                <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &lt;tr&gt;&lt;td class=&quot;pme-key-title&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{subject}&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;&quot;&gt;&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;&quot;&gt;&lt;/td&gt; </span>
<span class="hh">       &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td colspan=&quot;2&quot; class=&quot;pme-key-title&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{description}&lt;/td&gt;</span>
<span class="hh">       &lt;td class=&quot;$dclass&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{price} $hash_ref-&gt;{$hash_key}-&gt;{tradeCurrency}s $per_unit&lt;/td&gt;</span>
<span class="hh">       &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;&lt;/td&gt;</span>
<span class="hh">       &lt;/tr&gt;</span>
<span class="hh">   &lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;&lt;/td&gt;</span>
<span class="hh">       &lt;/tr&gt;</span>
<span class="h">EOT</span>

                <span class="i">$save_subject</span> = <span class="i">$hash_ref</span>-&gt;{<span class="i">$hash_key</span>}-&gt;{<span class="w">subject</span>}<span class="sc">;</span>
            <span class="s">}</span>

        <span class="s">}</span>    <span class="c"># this record</span>
        <span class="i">$first_pass</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="i">$counter</span>++<span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># all records</span>
    <span class="i">$userhtml</span> =~ <span class="q">s/bal/$balv/</span><span class="sc">;</span>
    <span class="i">$userhtml</span> =~ <span class="q">s/bal//g</span><span class="sc">;</span>
    <span class="i">$userhtml</span> =~ <span class="q">s!image!$userimage!</span><span class="sc">;</span>
    <span class="c">###$userhtml =~ s/image//g;</span>
    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;$userhtml&lt;tr&gt;&lt;td colspan=\&quot;3\&quot;&gt;&lt;/td&gt;&lt;/tr&gt;$html&lt;/table&gt;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="change_language">change_language</a></h3>
<p>Change the user language for the web interface
never tested recently as of 4/2005, waiting until
html is somewhat complete</p>
<pre>
<a name="change_language-"></a><span class="k">sub </span><span class="m">change_language</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$template_dir</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$domain</span>    = <span class="q">&quot;bigwaveheuristics.com&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%cookie</span>    = <span class="i">%$cookieref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$path</span>      = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="i">$cookie</span>{<span class="w">language</span>} = <span class="i">$$fieldsref</span>{<span class="w">language</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$pages</span> =
      <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="q">&quot;$template_dir/$fieldsref-&gt;{language}&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$cookies</span> = <span class="i">return_cookie_header</span><span class="s">(</span> <span class="q">&quot;-1&quot;</span><span class="cm">,</span> <span class="i">$domain</span><span class="cm">,</span> <span class="i">$path</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">%cookie</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">languagechanged</span>}<span class="cm">,</span>
        <span class="i">$pages</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="modify_user">modify_user</a></h3>
<p>Modify an existing user, needs implementing to replace
raw update: update_database_record</p>
<p>Also needs extension so that, for example an administrator
can modify credit limit fields etc.</p>
<pre>
<a name="modify_user-"></a><span class="k">sub </span><span class="m">modify_user</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$userlogin</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hash</span>       = <span class="q">&quot;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return_url</span> = <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="sc">;</span>

    <span class="i">@status</span> =
      <span class="i">validate_user</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$messagesref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span>[<span class="n">0</span>] == <span class="n">-1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">shift</span> <span class="i">@status</span><span class="sc">;</span>
        <span class="i">$html</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;&quot;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span>
            <span class="q">&quot;0&quot;</span><span class="cm">,</span>        <span class="i">$return_url</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>
            <span class="i">$html</span><span class="cm">,</span>      <span class="i">$pages</span><span class="cm">,</span>      <span class="q">&quot;result.html&quot;</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>          <span class="i">$token</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># mobile pin number is stored as hashed</span>
    <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} = <span class="i">text_to_hash</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">userPin</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
      <span class="s">)</span>
      = <span class="i">modify_database_record2</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$userlogin</span><span class="cm">,</span>
        <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>     <span class="q">&#39;users.html&#39;</span><span class="cm">,</span>
        <span class="i">$token</span>
      <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span>
        <span class="n">0</span><span class="cm">,</span>         <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="delete_user">delete_user</a></h3>
<p>Delete a user, physically, all accounts need to be closed first
Not done in current version</p>
<pre>
<a name="delete_user-"></a><span class="k">sub </span><span class="m">delete_user</span> <span class="s">{</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="make_uri_and_proxy">make_uri_and_proxy</a></h3>
<p>Make distant registry uri and proxy from a domain name given in a registry
record. If there is no explicit uri and proxy, this is what happens:</p>
<p>uri   : <a href="http://subdomain.domain.tld/Cclite">http://subdomain.domain.tld/Cclite</a>
proxy : <a href="http://subdomain.domain.tld/cgi-bin/ccserver.cgi">http://subdomain.domain.tld/cgi-bin/ccserver.cgi</a></p>
<p>If there is an explicit domain and proxy in the proxy registry record
these are overridden</p>
<pre>
<a name="make_uri_and_proxy-"></a><span class="k">sub </span><span class="m">make_uri_and_proxy</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$domain</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$uri</span>      = <span class="q">&quot;http://$domain/Cclite&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$proxy</span>    = <span class="q">&quot;http://$domain/cgi-bin/ccserver.cgi&quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$uri</span><span class="cm">,</span> <span class="i">$proxy</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="find_item">find_item</a></h3>
<p>Find an item, either locally or remotely via web service call
This uses an sqlstring and sql find. It's general but more dangerous
than some of the others</p>
<p>There's an 'understanding' that this will deliver a single record
but that's not necessarily true and needs tidying up</p>
<p>Need to keep array returns because hash returns don't seem to work,
this conflicts with 'unbreakability' confered by returing
hashes from</p>
<pre>
        # make stripey styles
        my $row_style  ;
        if ($record_counter % 2 ) {
          $row_style = &quot;odd&quot; ;
        } else {
          $row_style = &quot;even&quot; ;
        }the database
 
If the registry is local, direct access to record. If the registry
is a proxy for a distant registry, access via soap</pre>
<p>Note the slightly awkward nature of the _get_entry calls
since this is not blessed, class is supplied when called
locally..probably needs to get fixed</p>
<pre>
<a name="find_item-"></a><span class="k">sub </span><span class="m">find_item</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_partners&#39;</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%user</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$soap</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$stamp</span> = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># it&#39;s a locally existing registry, or om_partners not defined, simple mono-registry set-up</span>
    <span class="k">my</span> <span class="i">$order</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">registrytype</span>} <span class="k">eq</span> <span class="q">&quot;local&quot;</span>
        || !<span class="k">length</span><span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">registrytype</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> = <span class="i">sqlfind</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span>
            <span class="i">$order</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># it&#39;s a proxy for a distant registry: soap call</span>
        <span class="c"># make default type uri and proxy, if not defined in registry record</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">uri</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">uri</span>}<span class="cm">,</span> <span class="i">$$registryref</span>{<span class="w">proxy</span>} <span class="s">)</span> =
              <span class="i">make_uri_and_proxy</span><span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">domain</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="i">$soap</span> =
          <span class="w">SOAP::Lite</span><span class="w">-&gt;uri</span><span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">uri</span>} <span class="s">)</span><span class="i">-&gt;proxy</span><span class="s">(</span> <span class="i">$$registryref</span>{<span class="w">proxy</span>} <span class="s">)</span>
          <span class="i">-&gt;sqlfind</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span>
            <span class="i">$order</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
          <span class="s">)</span><span class="sc">;</span>

        <span class="c"># this needs to be more solid</span>
        <span class="k">die</span> <span class="i">$soap</span><span class="i">-&gt;faultstring</span> <span class="k">if</span> <span class="i">$soap</span><span class="i">-&gt;fault</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> = <span class="i">$soap</span><span class="i">-&gt;paramsout</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$global_status</span> =
      <span class="i">checkstatus</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># checkstatus is in Ccu, not finished</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">%user</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="wrapper_for_check_user_and_add_trade">wrapper_for_check_user_and_add_trade</a></h3>
<p>this wrapper deals with some php difficulties in
passing array references remotely 2006/01</p>
<pre>
<a name="wrapper_for_check_user_and_add_trade-"></a><span class="k">sub </span><span class="m">wrapper_for_check_user_and_add_trade</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">@transaction</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">@transaction</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@errors</span> =
      <span class="i">check_user_and_add_trade</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">@errors</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="check_user_and_add_trade">check_user_and_add_trade</a></h3>
<p>Check user validity and add the trade</p>
<p>integrated for remote SOAP access, to avoid two round trips
will return if something wrong with remote user</p>
<p>As of 06/2007 now returns keys for literals, so that messages
can be translated into the initiating user's language with
the transaction function
=cut</p>
<pre>
<a name="check_user_and_add_trade-"></a><span class="k">sub </span><span class="m">check_user_and_add_trade</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%transaction</span> = <span class="i">%$transaction_ref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">@errors</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
        <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="q">&quot;userLogin&quot;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">tradeDestination</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&quot;rdb1: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># destination user doesn&#39;t exist</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userLogin</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&#39;nonexist&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># destination user does exist but inactive</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userStatus</span>} <span class="k">ne</span> <span class="q">&quot;active&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&#39;userinactive&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># see if the currency exists in partner</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
        <span class="q">&quot;om_currencies&quot;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&quot;rdb2: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># no currency in remote registry</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$currencyref</span>{<span class="w">name</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&#39;noremotecurrency&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># currency inactive in remote registry</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$$currencyref</span>{<span class="w">status</span>} <span class="k">ne</span> <span class="q">&quot;active&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&#39;currencyinactive&#39;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$adderror</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@errors</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="i">@errors</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$adderror</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
          <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> \<span class="i">%transaction</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="q">&quot;rdb3: $adderror&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$adderror</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">@errors</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="split_transaction">split_transaction</a></h3>
<p>This is a transaction that divides into two elementary transactions,
a primary currency and a secondary currency. Used, for example, for recording items
that are partially paid in national currency.</p>
<p>The hash reference for the transaction is that of the 'primary' transaction part.
This will tie everything together.</p>
<p>Ideally this will need to be a complete atomic database transaction in
a future version.</p>
<pre>
<a name="split_transaction-"></a><span class="k">sub </span><span class="m">split_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># this is the primary transaction, we&#39;d like to use this as an engine</span>
    <span class="i">$$transaction_ref</span>{<span class="w">mode</span>} = <span class="q">&#39;engine&#39;</span><span class="sc">;</span>

    <span class="c"># comment the transaction as a split</span>
    <span class="i">$$transaction_ref</span>{<span class="w">tradeTitle</span>} =
      <span class="q">&quot;$messages{split}:$$transaction_ref{tradeTitle}&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$t</span><span class="s">)</span> = <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># the transaction array is now altered to put the secondary currency</span>
    <span class="c"># into the primary fields</span>

    <span class="i">$$transaction_ref</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$transaction_ref</span>{<span class="w">stradeCurrency</span>}<span class="sc">;</span>
    <span class="i">$$transaction_ref</span>{<span class="w">tradeAmount</span>}   = <span class="i">$$transaction_ref</span>{<span class="w">stradeAmount</span>}<span class="sc">;</span>
    <span class="i">$$transaction_ref</span>{<span class="w">mode</span>}          = <span class="q">&#39;html&#39;</span><span class="sc">;</span>
    <span class="i">$$transaction_ref</span>{<span class="w">tradeHash</span>}     = <span class="i">$$t</span>{<span class="w">tradeHash</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="directpay">directpay</a></h3>
<p>Transaction from a foreign system, drupal for the moment
Provides limited html in return, dealing with a complete 'foreign'
interface rather than complete cclite templates</p>
<pre>
<a name="directpay-"></a><span class="k">sub </span><span class="m">directpay</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># merchant key hash compared to calculated before doing anything</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">compare_api_key</span><span class="s">(</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="q">&#39;merchant_key_hash&#39;</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
      <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">return</span> <span class="q">&quot;invalid merchant key&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
          <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="transaction">transaction</a></h3>
<p>Transaction part of the motor, buyer, seller etc.
The journal part will be done in the future via the db journals</p>
<p>fromid - initiating userid e.g. jsb
from_regy - initiating registry e.g. nw.cov.uk
to_id - receiving id e.g. rik
to_regy - receiving registry e.g. se.cov.uk
system - domain of payment system e.g. b2b.cov.uk
amount - amount of currency tranferred e.g. 23.45
currency is probably always stored as cents and displayed as units/cents
user_date - integer seconds since 12:00:00AM 1/1/1970 GMT user record
            these are readable dates and times in Hugh's version</p>
<p>system_date - integer seconds since 12:00:00AM 1/1/1970 GMT system record
            these are readable dates and times in Hugh's version</p>
<p>details - string to identify transaction e.g. customer a/c jkl2345987
           this probably has a description in it in Hugh's Version</p>
<p>mms_accept, mss_accept, mas_accept values 'Y' for yes, 'N'
            for no, 'W' for waiting. A payment clears when all 3 are 'Y' or
            is rejected if a single 'N' is recorded.</p>
<p>status values: W - waiting, R - rejected, C - cleared, T - timed out</p>
<p>Return status numbers need sorting out, more possible failure
modes need to be identified</p>
<p>Transaction commit to be sorted, especially some imperfect version
of remote commit: returns hash/compared to local calculation?</p>
<p>When this is invoked the SMS, Mail, CSV is already translated into
standard transaction format in Ccinterfaces.pm and Ccsmsgateway.pm</p>
<pre>
<a name="transaction-"></a><span class="k">sub </span><span class="m">transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$offset</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># not used here</span>
    <span class="k">my</span> <span class="i">$same_registry</span> =
      <span class="n">0</span><span class="sc">;</span>    <span class="c"># if the same registry, can use a Mysql transaction...</span>
            <span class="c"># if local registries can use two, but not the same effect...</span>
    <span class="k">my</span> <span class="i">%transaction</span> = <span class="i">%$transaction_ref</span><span class="sc">;</span>

    <span class="c"># $log-&gt;warn(&quot;mode:$$transaction_ref{mode} \n ===============&quot; );</span>
    <span class="c"># this is somewhat more rational as of 06/2007</span>
    <span class="k">my</span> <span class="i">@remote_status</span><span class="sc">;</span>    <span class="c"># messages returned from remote registry</span>
    <span class="k">my</span> <span class="i">@local_status</span><span class="sc">;</span>     <span class="c"># messages returned from local registry</span>
        <span class="c"># also local messages are accumulated then returned so that</span>
        <span class="c"># the user can see everything that&#39;s wrong, not just the last message</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#----------------------------------------------------------------------------------</span>
<span class="c"># validate transaction, do everything we can to make sure it&#39;s valid</span>
<span class="c"># can&#39;t do a transaction with the same person as sender and receiver</span>

    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>} <span class="k">eq</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>} <span class="s">)</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$transaction</span>{<span class="w">tradeSource</span>} <span class="k">eq</span> <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">sameaccount</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># no transaction source, can happen from rest interface</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$transaction</span>{<span class="w">tradeSource</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">nosource</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># cash must be credited to the cash account when issued</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="i">$transaction</span>{<span class="w">tradeItem</span>} <span class="k">eq</span> <span class="q">&#39;cash&#39;</span>
        &amp;&amp; <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} <span class="k">ne</span> <span class="q">&#39;cash&#39;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;mustgotocash&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># there&#39;s a commitment limit in the registry and this is exceeded by this</span>
<span class="c"># transaction, commitment limit is global, at present, should probably be per-currency</span>

    <span class="c"># now have a look at the commitmentlimit in the registry record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registry_ref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&quot;om_registry&quot;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db1: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># test commitment, this can be zero for an issuance local currency</span>
    <span class="c"># null means no commitlimit</span>
    <span class="k">my</span> <span class="i">$commitment_limit</span> = <span class="i">$$registry_ref</span>{<span class="w">commitlimit</span>}<span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span><span class="s">(</span><span class="i">$commitment_limit</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># html to return html, values to return raw balances and volumes</span>
        <span class="c"># for each currency</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span> = <span class="i">show_balance_and_volume</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span>     <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span>
            <span class="q">&quot;&quot;</span><span class="cm">,</span>          <span class="i">$transaction</span>{<span class="w">tradeSource</span>}<span class="cm">,</span>
            <span class="q">&#39;values&#39;</span><span class="cm">,</span>    <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span>     <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="c"># current balance for this particular currency</span>
        <span class="k">my</span> <span class="i">$balance</span> = <span class="i">$$balance_ref</span>{ <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} }<span class="sc">;</span>

<span class="c"># balances are negative in the sending side, need to subtract and make absolute</span>
<span class="c"># if more than commitment limit transaction does not proceed</span>
<span class="c"># sysaccount -can- issue value into accounts: should check for &#39;local&#39; style currency</span>
<span class="c"># corrected commit limit arithmetic 12/2008</span>

        <span class="c">### $log-&gt;debug(&quot;beforehand b:$balance c:$commitment_limit  t:$transaction{tradeAmount}&quot;) ;</span>

        <span class="k">if</span> <span class="s">(</span>
            <span class="s">(</span>
                <span class="s">(</span>
                    <span class="s">(</span> <span class="i">$balance</span> + <span class="i">$commitment_limit</span> <span class="s">)</span> - <span class="i">$transaction</span>{<span class="w">tradeAmount</span>}
                <span class="s">)</span> &lt; <span class="n">0</span>
            <span class="s">)</span>
            &amp;&amp; <span class="i">$transaction</span>{<span class="w">tradeSource</span>} <span class="k">ne</span> <span class="q">&#39;sysaccount&#39;</span>
          <span class="s">)</span>
        <span class="s">{</span>

            <span class="c">###$log-&gt;debug(&quot;exceeded b:$balance c:$commitment_limit  t:$transaction{tradeAmount}&quot;) ;</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">transactionlimitexceeded</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># create mirror transaction here ; this also hashes the transaction and adds</span>
    <span class="c"># the original transaction hash field to both sides</span>

    <span class="k">my</span> <span class="i">$debit_transaction_ref</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$debit_transaction_ref</span> <span class="s">)</span> =
      <span class="i">create_transaction_mirror</span><span class="s">(</span> <span class="i">$transaction</span>{<span class="w">action</span>}<span class="cm">,</span> <span class="i">%transaction</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">%transaction</span> = <span class="i">%$transaction_ref</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%debit_transaction</span> = <span class="i">%$debit_transaction_ref</span><span class="sc">;</span>

<span class="c"># do the remote side before the local side..if the remote side fails, neither are done</span>
<span class="c"># the credit transaction can be in a remote registry</span>
<span class="c"># need to get the trading partners description from the originating registry, not the distant one</span>
<span class="c"># modified to deal with the current registry itself: most common type of transaction</span>
<span class="c"># local means on the same system, same_registry is on the same system, within the same registry</span>
<span class="c"># therefore can be carried within a mysql transaction</span>

    <span class="k">my</span> <span class="i">%registry</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>} <span class="k">eq</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$registry</span>{<span class="w">type</span>} = <span class="q">&quot;local&quot;</span><span class="sc">;</span>
        <span class="i">$same_registry</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registry_ref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
            <span class="q">&quot;om_partners&quot;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="i">%registry</span> = <span class="i">%$registry_ref</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db2: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c">#   error code here</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$soap</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># it&#39;s a registry that lives locally on this currency server</span>
    <span class="c"># therefore this is done directly and not via soap calls</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$registry</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&quot;local&quot;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># check whether remote registry is still a partner</span>
        <span class="c"># not necessary if partner is the same registry</span>
        <span class="c">#</span>

        <span class="k">unless</span> <span class="s">(</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>} <span class="k">eq</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>} <span class="s">)</span> <span class="s">{</span>

            <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$partnerref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
                <span class="i">$class</span><span class="cm">,</span>                     <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
                <span class="q">&quot;om_partners&quot;</span><span class="cm">,</span>              <span class="q">&quot;name&quot;</span><span class="cm">,</span>
                <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
                <span class="i">$offset</span><span class="cm">,</span>                    <span class="i">$limit</span>

            <span class="s">)</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db3: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$partnerref</span>{<span class="w">name</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">noremotepartner</span>}<span class="sc">;</span>
            <span class="s">}</span>

            <span class="c"># destination partner does exist but inactive</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$$partnerref</span>{<span class="w">status</span>} <span class="k">ne</span> <span class="q">&quot;active&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">remotepartnerinactive</span>}<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="c"># check facts about destination user</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
            <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="q">&quot;userLogin&quot;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">tradeDestination</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db4: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># destination user doesn&#39;t exist</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userLogin</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">nonexist</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># destination user does exist but inactive</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userStatus</span>} <span class="k">ne</span> <span class="q">&quot;active&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">userinactive</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># see if the currency exists in partner</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
            <span class="q">&quot;om_currencies&quot;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db5: $status&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$status</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># no currency in remote registry</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$currencyref</span>{<span class="w">name</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">noremotecurrency</span>}<span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># currency inactive in remote registry</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$currencyref</span>{<span class="w">status</span>} <span class="k">ne</span> <span class="q">&quot;active&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">currencyinactive</span>}<span class="sc">;</span>
        <span class="s">}</span>

      <span class="c"># since the remote is about to be rejected, reject the local one</span>
      <span class="c"># since nothing has changed yet in the databases, return with a message...</span>
      <span class="c"># processing changed 1/2009 to avoid storage of many rejected transactions</span>

        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$local_status</span>[<span class="n">0</span>] <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">transactionrejected</span>}<span class="sc">;</span>
            <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="q">&quot;rejected&quot;</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$output_message</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;\n&quot;</span><span class="cm">,</span> <span class="i">@local_status</span> <span class="s">)</span><span class="sc">;</span>

            <span class="c"># warn about rejections at this level in log</span>
            <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span><span class="q">&quot;rejected transaction: $output_message&quot;</span><span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span>
                <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c">###my $l = length ($local_status[0]) ;</span>
        <span class="c">###my $x = join(&quot;|&quot;,@local_status) ;</span>
        <span class="c">###$log-&gt;debug(&quot;local status is $x - l: $l $local_status[0] &quot;) ;</span>

        <span class="c"># add the transaction to the receiving user...</span>

        <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
          <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
            <span class="i">$transaction</span>{<span class="w">subaction</span>}<span class="cm">,</span> \<span class="i">%transaction</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db6: $error&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span><span class="sc">;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># transaction in remote registry, this is one integrated sub-routine</span>
        <span class="c"># reduces round-trip &#39;costs&#39; and avoid soap hanging problems</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>}<span class="cm">,</span> <span class="i">$registry</span>{<span class="w">proxy</span>} <span class="s">)</span> =
              <span class="i">make_uri_and_proxy</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">domain</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># check remote user and add transaction to the remote registry</span>
        <span class="c"># done as an integrated call to avoid xml to-and-fro</span>
        <span class="c">#</span>
        <span class="k">my</span> <span class="i">$soap</span> =
          <span class="w">SOAP::Lite</span><span class="w">-&gt;uri</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>} <span class="s">)</span><span class="i">-&gt;proxy</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">proxy</span>} <span class="s">)</span>
          <span class="i">-&gt;check_user_and_add_trade</span><span class="s">(</span> <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> \<span class="i">%transaction</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$s</span> = <span class="i">$soap</span><span class="i">-&gt;faultstring</span><span class="sc">;</span>
        <span class="k">die</span> <span class="i">$soap</span><span class="i">-&gt;faultstring</span> <span class="k">if</span> <span class="i">$soap</span><span class="i">-&gt;fault</span><span class="sc">;</span>

        <span class="c"># get all the messages and pack them up</span>
        <span class="i">@remote_status</span> = <span class="i">$soap</span><span class="i">-&gt;paramsout</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$res</span> = <span class="i">$soap</span><span class="i">-&gt;result</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@remote_status</span><span class="cm">,</span> <span class="i">$res</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># remote status is delivered as literal keys and database status messages</span>
    <span class="c"># this translates them where possible, database messages are prepended with</span>
    <span class="c"># rdbn and left as-is, soap status also untranslatable</span>

    <span class="k">my</span> <span class="i">@translated_remote_status</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$status</span> <span class="s">(</span><span class="i">@remote_status</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$messages</span>{<span class="i">$status</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@translated_remote_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="i">$status</span>}<span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@translated_remote_status</span><span class="cm">,</span> <span class="i">$status</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># the debit transaction is always saved in the local registry</span>
    <span class="c"># but with rejected tradeStatus and the errors packed into the</span>
    <span class="c"># tradeDescription</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$local_status</span>[<span class="n">0</span>] <span class="s">)</span> || <span class="k">length</span><span class="s">(</span> <span class="i">$remote_status</span>[<span class="n">0</span>] <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$debit_transaction</span>{<span class="w">tradeDescription</span>} =
          <span class="k">join</span><span class="s">(</span> <span class="q">&quot;\r\n&quot;</span><span class="cm">,</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">@translated_remote_status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$debit_transaction</span>{<span class="w">tradeStatus</span>} = <span class="q">&quot;rejected&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$record_id</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="i">$transaction</span>{<span class="w">subaction</span>}<span class="cm">,</span> \<span class="i">%debit_transaction</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># since this can fail at local database attempt, at least there &#39;may&#39;</span>
    <span class="c"># be a screen display of this</span>
    <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="q">&quot;db7: $error&quot;</span> <span class="k">if</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$local_status</span>[<span class="n">0</span>] <span class="s">)</span> || <span class="k">length</span><span class="s">(</span> <span class="i">$remote_status</span>[<span class="n">0</span>] <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">transactionrejected</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">push</span> <span class="i">@local_status</span><span class="cm">,</span>
<span class="q">&quot;$messages{transactionaccepted}&lt;br/&gt;Ref:&amp;nbsp;$transaction{tradeHash}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$output_message</span> =
      <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;br/&gt;\n&quot;</span><span class="cm">,</span> <span class="i">@local_status</span><span class="cm">,</span> <span class="i">@translated_remote_status</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span>
        <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="q">&quot;$$transaction_ref{home}?action=showtransnotify_by_mail&quot;</span><span class="cm">,</span>
        <span class="i">$error</span><span class="cm">,</span>
        <span class="i">$output_message</span><span class="cm">,</span>

        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="create_transaction_mirror">create_transaction_mirror</a></h3>
<p>Creates the 'mirror image' of a transaction to either create or
delete a double entry. This is isolated in one subroutine so that
changes in transaction structure are reflected in one place</p>
<p>Don't mess with the literal values like 'debit' and 'credit'
in here, they are database enums, not message literals</p>
<pre>
<a name="create_transaction_mirror-"></a><span class="k">sub </span><span class="m">create_transaction_mirror</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$action</span><span class="cm">,</span> <span class="i">%transaction</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># prepare both sides of the transaction image</span>
    <span class="k">my</span> <span class="i">%debit_transaction</span> = <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c"># get date and timestamp</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$timestamp</span> = <span class="q">&quot;$date$time&quot;</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="i">$transaction</span>{<span class="w">tradeStamp</span>}       = <span class="i">$timestamp</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">ne</span> <span class="q">&quot;delete&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$debit_transaction</span>{<span class="w">tradeStamp</span>} = <span class="i">$timestamp</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$action</span> <span class="k">ne</span> <span class="q">&quot;delete&quot;</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># current date is inserted if no date suplied by transaction, batch values supply</span>
<span class="c"># date, for example</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$transaction</span>{<span class="w">tradeDate</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$debit_transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$transaction</span>{<span class="w">tradeDate</span>}<span class="sc">;</span>

    <span class="c">#</span>
    <span class="i">$transaction</span>{<span class="w">tradeType</span>}       = <span class="q">&quot;credit&quot;</span><span class="sc">;</span>
    <span class="i">$debit_transaction</span>{<span class="w">tradeType</span>} = <span class="q">&quot;debit&quot;</span><span class="sc">;</span>

    <span class="c"># the initial payment status is usually waiting but can be &#39;accepted&#39;</span>
    <span class="c"># initial status is applied only if there&#39;s no current status</span>
    <span class="c"># this deals with batch interfaces slightly better</span>

    <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$transaction</span>{<span class="w">tradeStatus</span>}
      || <span class="i">$transaction</span>{<span class="w">initialPaymentStatus</span>}<span class="sc">;</span>
    <span class="i">$debit_transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$transaction</span>{<span class="w">tradeStatus</span>}<span class="sc">;</span>

   <span class="c"># the mirror ties both sides of a transaction to allow distributed registries</span>

    <span class="i">$debit_transaction</span>{<span class="w">tradeMirror</span>} = <span class="i">$transaction</span>{<span class="w">toregistry</span>}<span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeMirror</span>}       = <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="sc">;</span>

    <span class="c"># add tax flag to both sides</span>
    <span class="i">$debit_transaction</span>{<span class="w">tradeTaxflag</span>} = <span class="i">$transaction</span>{<span class="w">tradeTaxflag</span>}<span class="sc">;</span>

    <span class="c"># hash transaction and join to both sides of deal</span>
    <span class="c"># the primary trade hash is -imposed-, if it exists, for split trades</span>
    <span class="c"># in order to make a link between the two operations</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$transaction</span>{<span class="w">tradeHash</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># tidied up as of 06/2007, only hashes core information</span>
        <span class="c"># for transaction, not all template fields etc.</span>
        <span class="c"># means that hash can be reproduced if necessary</span>
        <span class="c"># next release should include token value</span>

        <span class="k">my</span> <span class="i">$transaction_as_text</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>
            <span class="i">$transaction</span>{<span class="w">tradeStamp</span>}<span class="cm">,</span>       <span class="i">$transaction</span>{<span class="w">tradeDate</span>}<span class="cm">,</span>
            <span class="i">$transaction</span>{<span class="w">tradeType</span>}<span class="cm">,</span>        <span class="i">$transaction</span>{<span class="w">tradeSource</span>}<span class="cm">,</span>
            <span class="i">$transaction</span>{<span class="w">tradeDestination</span>}<span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="i">$transaction</span>{<span class="w">tradeTaxflag</span>}<span class="cm">,</span>     <span class="i">$transaction</span>{<span class="w">tradeAmount</span>}<span class="cm">,</span>
            <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} <span class="s">)</span><span class="sc">;</span>

        <span class="c">#FIXME: Do we want URL Safe trade hashes? These are not they...</span>
        <span class="k">my</span> <span class="i">$hash_value</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$transaction_as_text</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$transaction</span>{<span class="w">tradeHash</span>}       = <span class="i">$hash_value</span><span class="sc">;</span>
        <span class="i">$debit_transaction</span>{<span class="w">tradeHash</span>} = <span class="i">$hash_value</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$debit_transaction</span>{<span class="w">tradeHash</span>} = <span class="i">$transaction</span>{<span class="w">tradeHash</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="s">(</span> \<span class="i">%transaction</span><span class="cm">,</span> \<span class="i">%debit_transaction</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="delete_trade">delete_trade</a></h3>
<p>This operation should probably NOT be allowed on an established transaction
</p>
<pre>

Needs the timestamp to identify it
Plenty of deleted transactions affect reputation</pre>
<pre>

Local one can be deleted directly via id
Remote one needs 'get where fromuser = user and timestamp = timestamp
Left in code, just in case</pre>
<p>Perhaps these operations should be removed? ML/MF 04/2005
06/2007 cancel status in om_trades + a new modify trade operation
this is how a trade should be cancelled</p>
<pre>
<a name="delete_trade-"></a><span class="k">sub </span><span class="m">delete_trade</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># create transaction mirror</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$debit_transaction_ref</span><span class="cm">,</span> <span class="i">$html</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># check whether local</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%registry</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$db</span> <span class="k">eq</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$registry</span>{<span class="w">type</span>} = <span class="q">&quot;local&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registry_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_partners&quot;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span>
            <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">%registry</span> = <span class="i">%$registry_ref</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># if local use direct call</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$registry</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&#39;local&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># get where fromuser = user and timestamp = timestamp</span>
        <span class="i">find_and_delete_trade</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># get where fromuser = user and timestamp = timestamp</span>
        <span class="c"># else use web services call</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>}<span class="cm">,</span> <span class="i">$registry</span>{<span class="w">proxy</span>} <span class="s">)</span> =
              <span class="i">make_uri_and_proxy</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">domain</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># check remote user and add transaction to the remote registry</span>
        <span class="c"># done as an integrated call to avoid xml to-and-fro</span>
        <span class="c">#</span>
        <span class="k">my</span> <span class="i">$soap</span> =
          <span class="w">SOAP::Lite</span><span class="w">-&gt;uri</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>} <span class="s">)</span><span class="i">-&gt;proxy</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">proxy</span>} <span class="s">)</span>
          <span class="i">-&gt;find_and_delete_trade</span><span class="s">(</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">die</span> <span class="i">$soap</span><span class="i">-&gt;faultstring</span> <span class="k">if</span> <span class="i">$soap</span><span class="i">-&gt;fault</span><span class="sc">;</span>

        <span class="c"># get all the messages and pack them up</span>
        <span class="k">my</span> <span class="i">@status</span> = <span class="i">$soap</span><span class="i">-&gt;paramsout</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$res</span>    = <span class="i">$soap</span><span class="i">-&gt;result</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$res</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># delete local side record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$h</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
      <span class="i">delete_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="find_and_delete_trade">find_and_delete_trade</a></h3>
<p>This is a delete for the destination trade via timestamp 
and user</p>
<p>get via get_where and delete via delete_database_record
these are packed together to increase web services efficiency
This is a remote trade that cannot be identified via an id
</p>
<pre>

Need check here that multiple trades aren't returned for mirror
in which case the whole thing should stop</pre>
<p>Perhaps these operations should be removed? ML/MF 04/2005</p>
<pre>
<a name="find_and_delete_trade-"></a><span class="k">sub </span><span class="m">find_and_delete_trade</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$order</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlstring</span> =
<span class="q">&quot;tradeStamp = \&#39;$$transaction_ref{tradeStamp}\&#39; and tradeDestination = \&#39;$$transaction_ref{tradeDestination}\&#39;&quot;</span><span class="sc">;</span>

    <span class="c"># sqlfind timestamp and corresponding record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> = <span class="i">sqlfind</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># put the id into a record hash for delete, if there&#39;s more than one returned should die!</span>
<span class="c">#</span>
    <span class="k">my</span> <span class="i">$row_ref</span> = <span class="i">@$array_ref</span>[<span class="n">0</span>]<span class="sc">;</span>

    <span class="c"># hash is just field name and record id for delete</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="s">(</span> <span class="q">&quot;tradeId&quot;</span><span class="cm">,</span> <span class="q">&quot;$$row_ref[0]&quot;</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># just the id in this hash</span>
    <span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

    <span class="c"># delete</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
      <span class="i">delete_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="modify_trade">modify_trade</a></h3>
<p>These are modification operations allowed on an established transaction
to change the trade state only. Needs filtering to only
allow changes to: tradeStatus</p>
<p>Needs the timestamp to identify it
Plenty of declined and cancelled transactions should affect reputation
Local one can be modified directly via id
Remote one needs 'get where fromuser = user and timestamp = timestamp</p>
<p>This is probably a more reasonable way of doing delete</p>
<pre>
<a name="modify_trade-"></a><span class="k">sub </span><span class="m">modify_trade</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$debit_transaction_ref</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># filter anything that doesn&#39;t belong to tradeStatus, tradeDestination,</span>
    <span class="c"># tradeSource,tradeMirror, tradeId</span>

    <span class="c"># change status for confirm</span>
    <span class="i">$$transaction_ref</span>{<span class="w">tradeStatus</span>} = <span class="q">&quot;accepted&quot;</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$$transaction_ref</span>{<span class="w">action</span>} <span class="k">eq</span> <span class="q">&quot;confirmtrade&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># change status for confirm</span>
    <span class="i">$$transaction_ref</span>{<span class="w">tradeStatus</span>} = <span class="q">&quot;declined&quot;</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$$transaction_ref</span>{<span class="w">action</span>} <span class="k">eq</span> <span class="q">&quot;declinetrade&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># change status for delete, does not delete record, only changes</span>
    <span class="c"># status to cancelled 06/2007</span>
    <span class="i">$$transaction_ref</span>{<span class="w">tradeStatus</span>} = <span class="q">&quot;cancelled&quot;</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$$transaction_ref</span>{<span class="w">action</span>} <span class="k">eq</span> <span class="q">&quot;canceltrade&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># if it&#39;s not any of these then the status is unchanged...</span>

    <span class="c"># filter fields that shouldn&#39;t be modified, include home needs this!</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$transaction_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> !~
<span class="q">/tradeStamp|tradeStatus|tradeCurrency|tradeDestination|tradeSource|tradeMirror|tradeId|tradeDestination|home/</span>
          <span class="s">)</span>
        <span class="s">{</span>
            <span class="k">delete</span> <span class="i">$$transaction_ref</span>{<span class="i">$key</span>}<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># check whether local</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%registry</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$db</span> <span class="k">eq</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>} <span class="s">)</span> <span class="s">{</span>
        <span class="i">$registry</span>{<span class="w">type</span>} = <span class="q">&quot;local&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$registry_ref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_partners&quot;</span><span class="cm">,</span> <span class="q">&quot;name&quot;</span><span class="cm">,</span>
            <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">%registry</span> = <span class="i">%$registry_ref</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># if local use direct call</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$registry</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&#39;local&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># get where fromuser = user and timestamp = timestamp</span>
        <span class="i">find_and_modify_trade</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># get where fromuser = user and timestamp = timestamp</span>
        <span class="c"># else use web services call</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>}<span class="cm">,</span> <span class="i">$registry</span>{<span class="w">proxy</span>} <span class="s">)</span> =
              <span class="i">make_uri_and_proxy</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">domain</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># check remote user and add transaction to the remote registry</span>
        <span class="c"># done as an integrated call to avoid xml to-and-fro</span>
        <span class="c">#</span>
        <span class="k">my</span> <span class="i">$soap</span> =
          <span class="w">SOAP::Lite</span><span class="w">-&gt;uri</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">uri</span>} <span class="s">)</span><span class="i">-&gt;proxy</span><span class="s">(</span> <span class="i">$registry</span>{<span class="w">proxy</span>} <span class="s">)</span>
          <span class="i">-&gt;find_and_modify_trade</span><span class="s">(</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">die</span> <span class="i">$soap</span><span class="i">-&gt;faultstring</span> <span class="k">if</span> <span class="i">$soap</span><span class="i">-&gt;fault</span><span class="sc">;</span>

        <span class="c"># get all the messages and pack them up</span>
        <span class="k">my</span> <span class="i">@status</span> = <span class="i">$soap</span><span class="i">-&gt;paramsout</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$res</span>    = <span class="i">$soap</span><span class="i">-&gt;result</span><span class="sc">;</span>
        <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$res</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># update local side trade</span>
    <span class="i">update_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$html</span> = <span class="q">&quot;$messages{transactionstatusnow} $$transaction_ref{tradeStatus}&quot;</span><span class="sc">;</span>

    <span class="c"># return to transaction list</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="q">&quot;$$transaction_ref{home}?action=showtrans&quot;</span><span class="cm">,</span>
        <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="find_and_modify_trade">find_and_modify_trade</a></h3>
<p>This is a modification for the destination trade via timestamp 
and user</p>
<p>get via get_where and delete via delete_database_record
these are packed together to increase web services efficiency
This is a remote trade that cannot be identified via an id
</p>
<pre>

Need check here that multiple trades aren't returned for mirror
in which case the whole thing should stop</pre>
<p>This should probably be based on id via the hash in the future</p>
<pre>
<a name="find_and_modify_trade-"></a><span class="k">sub </span><span class="m">find_and_modify_trade</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$pagename</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">tradeStamp = &#39;$$transaction_ref{tradeStamp}&#39; and</span>
<span class="hh">tradeCurrency = &#39;$$transaction_ref{tradeCurrency}&#39; and</span>
<span class="hh">tradeSource = &#39;$$transaction_ref{tradeSource}&#39; and</span>
<span class="hh">tradeId &lt;&gt; &#39;$$transaction_ref{tradeId}&#39;</span>
<span class="h">EOT</span>

    <span class="c"># sqlfind timestamp and corresponding record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> = <span class="i">sqlfind</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$transaction_ref</span>{<span class="w">tradeMirror</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$order</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># put the id into a record hash for delete, if there&#39;s more than one returned should die!</span>
<span class="c">#</span>
    <span class="k">my</span> <span class="i">$row_ref</span> = <span class="i">@$array_ref</span>[<span class="n">0</span>]<span class="sc">;</span>

    <span class="c"># hash is just id field and status for modify at present</span>
    <span class="c"># only allowed to modify status value of transactions</span>
    <span class="k">my</span> <span class="i">%fields</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="s">(</span>
        <span class="q">&#39;tradeId&#39;</span><span class="cm">,</span> <span class="i">$$row_ref</span>[<span class="n">0</span>]<span class="cm">,</span> <span class="q">&#39;tradeStatus&#39;</span><span class="cm">,</span> <span class="q">&quot;$$transaction_ref{tradeStatus}&quot;</span>
    <span class="s">)</span><span class="sc">;</span>    <span class="c"># just the id  and trade status in this hash</span>
    <span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

    <span class="c"># modify the trade status</span>
    <span class="i">update_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_many_items">get_many_items</a></h3>
<p>This get_many_items is mainly used for getting transactions at present
But it should become a general purpose lister, for ads,
users, SICs etc</p>
<p>Items delivered as arrays, since SOAP problems with hashes
At present mode = html to produce an html type listing</p>
<p>12/2005: This is becoming a bit of a disgrace although it runs pretty well
07/2007: More disgraceful, new code anyone?
xx/2008: get_trades added to start to unscramble...</p>
<pre>
<a name="get_many_items-"></a><span class="k">sub </span><span class="m">get_many_items</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>   <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$name</span><span class="cm">,</span>  <span class="i">$mode</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>    <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$allow_changes</span><span class="cm">,</span> <span class="i">$colspan</span><span class="cm">,</span> <span class="i">$entry</span><span class="cm">,</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$option_string</span><span class="cm">,</span>
        <span class="i">$error</span><span class="cm">,</span>         <span class="i">$row</span><span class="cm">,</span>     <span class="i">$html</span><span class="cm">,</span>  <span class="i">$home</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$total_count</span><span class="sc">;</span>

    <span class="c"># for the present deliver all trade types</span>
    <span class="k">my</span> <span class="i">$trade_type</span> = <span class="q">&quot;all&quot;</span><span class="sc">;</span>

    <span class="c"># count total in set, as opposed to number delivered by limit</span>
    <span class="c"># note that this is overwritten by get_trades, if finding trades</span>

    <span class="k">if</span> <span class="s">(</span>   <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_partners&quot;</span>
        &amp;&amp; <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_currencies&quot;</span>
        &amp;&amp; <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$total_count</span> =
          <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$total_count</span> = <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="sc">;</span>    <span class="c"># count them all</span>
         <span class="c"># get the records</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span><span class="q">&quot;limit is $limit&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$total_count</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
          <span class="i">get_trades</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="i">$trade_type</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># only show one month of totals</span>

       <span class="c">#      this works but it needs to be cached because it&#39;s slow</span>
       <span class="c">#      turned off until it&#39;s within a caching scheme.</span>
       <span class="c">#      $$fieldsref{maxreport} = 1;</span>
       <span class="c">#</span>
       <span class="c">#        # html to return html, values to return raw balances and volumes</span>
       <span class="c">#        my ( $c, $m, $e, $html, $p, $c ) =</span>
       <span class="c">#          show_balance_and_volume( &#39;local&#39;, $db, $table, $fieldsref, &quot;&quot;,</span>
       <span class="c">#            $$fieldsref{userLogin}, &#39;html&#39;, $token, $offset, $limit );</span>
       <span class="c">#</span>
       <span class="c">#        $$fieldsref{righthandside} = $html;</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
          <span class="i">get_where_multiple</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span> <span class="i">$name</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$total_count</span> = <span class="k">scalar</span><span class="s">(</span> <span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># count the records returned</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$x</span>              = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$record_counter</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span> <span class="s">{</span>

        <span class="k">my</span> <span class="i">$id</span>             = <span class="i">$$row</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$modify_button</span>  = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$delete_button</span>  = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$display_button</span> = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$confirm_button</span> = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$decline_button</span> = <span class="q">&quot;&amp;nbsp;&quot;</span><span class="sc">;</span>

        <span class="i">$display_button</span> =
          <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">show</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;display&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$row</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#FIXME: this is a weak piece of code, in that , if the script is the admin script</span>
<span class="c"># there&#39;ll always be modify and delete, scope of button display needs to</span>
<span class="c"># shouldn&#39;t really delete currencies or users, for example,</span>
<span class="c"># current restriction is not to delete trades</span>
<span class="c"># cut down 05/2007</span>

        <span class="c"># there&#39;s always a display button</span>

        <span class="k">if</span> <span class="s">(</span>
            <span class="s">(</span>
                <span class="s">(</span>
                       <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_yellowpages&quot;</span> <span class="s">)</span>
                    &amp;&amp; <span class="s">(</span> <span class="i">$$row</span>[<span class="n">5</span>] <span class="k">eq</span> <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>} <span class="s">)</span>
                <span class="s">)</span>
                || <span class="s">(</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> &amp;&amp; <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span>

            <span class="s">)</span>
          <span class="s">)</span>
        <span class="s">{</span>

            <span class="k">my</span> <span class="i">$class</span><span class="sc">;</span>
            <span class="i">$allow_changes</span> = <span class="n">1</span><span class="sc">;</span>

            <span class="c"># if the record is a trade, then the delete operation becomes</span>
            <span class="c"># &#39;modify the status to cancel&#39;</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$delete_button</span> =
                  <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">delete</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;delete&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
                    <span class="i">$row</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

                <span class="c"># if the record is a trade, then the delete operation becomes</span>
                <span class="c"># &#39;modify the status to cancel&#39;</span>

                <span class="i">$$fieldsref</span>{<span class="w">tradeStatus</span>} = <span class="q">&quot;cancelled&quot;</span><span class="sc">;</span>
                <span class="i">$delete_button</span> =
                  <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">modify</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;template&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
                    <span class="i">$row</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

            <span class="s">}</span>

            <span class="i">$modify_button</span> =
              <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">modify</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;template&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$row</span><span class="cm">,</span>
                <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="s">}</span>    <span class="c"># end of buttons</span>

        <span class="c"># delete button for trades is removed now</span>
        <span class="c"># decline button implemented 12/2005</span>

        <span class="k">if</span> <span class="s">(</span>   <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_trades&#39;</span>
            &amp;&amp; <span class="i">$$row</span>[<span class="n">8</span>] <span class="k">eq</span> <span class="q">&#39;credit&#39;</span>
            &amp;&amp; <span class="i">$$row</span>[<span class="n">1</span>] <span class="k">eq</span> <span class="q">&quot;waiting&quot;</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$confirm_button</span> =
              <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">ok</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;confirmtrade&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$row</span><span class="cm">,</span>
                <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

            <span class="i">$decline_button</span> =
              <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">reject</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;declinetrade&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span>
                <span class="i">$row</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># end of trades buttons</span>

        <span class="c"># this is a weakness and should be coded out 05/2007</span>

        <span class="i">$modify_button</span> =
          <span class="i">makebutton</span><span class="s">(</span> <span class="i">$messages</span>{<span class="w">modify</span>}<span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&quot;template&quot;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$row</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_currencies&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># tidy up columns</span>
        <span class="k">delete</span> <span class="i">@$row</span>[ <span class="n">1</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span> ] <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_partners&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># very limited display for passthrough to Drupal and Elgg</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;mode&#39;</span>} <span class="k">ne</span> <span class="q">&#39;csv&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">delete</span> <span class="i">@$row</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">10</span> .. <span class="n">14</span> ]<span class="sc">;</span>
            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                <span class="k">delete</span> <span class="i">@$row</span>[ <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">10</span> .. <span class="n">14</span> ]<span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

        <span class="k">delete</span> <span class="i">@$row</span>[ <span class="n">4</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">7</span><span class="cm">,</span> <span class="n">9</span><span class="cm">,</span> <span class="n">11</span> .. <span class="n">18</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_yellowpages&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">@$row</span> = <span class="i">@$row</span>[ <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">16</span><span class="cm">,</span> <span class="n">17</span> .. <span class="n">19</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_users&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># experimental: show decimal places for trades</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">usedecimals</span>} <span class="k">eq</span> <span class="q">&quot;yes&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$row</span>[<span class="n">9</span>] =~ <span class="q">s/(\d{2})$/.$1/</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_trades&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_trades&#39;</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$row</span>[<span class="n">9</span>] <span class="s">)</span> == <span class="n">3</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$$row</span>[<span class="n">9</span>] = <span class="q">&quot;0$$row[9]&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>

 <span class="c"># trades have somehwat different buttons to the others</span>
 <span class="c"># everything now has three, but passthrough Drupal or Elgg display doesn&#39;t have</span>
 <span class="c"># any buttons currently</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">mode</span>} <span class="k">ne</span> <span class="q">&#39;csv&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">unshift</span> <span class="i">@$row</span><span class="cm">,</span>
                  <span class="s">(</span> <span class="i">$display_button</span><span class="cm">,</span> <span class="i">$confirm_button</span><span class="cm">,</span> <span class="i">$decline_button</span> <span class="s">)</span>
                  <span class="sc">;</span>    <span class="c"># push button onto row</span>
            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                <span class="k">unshift</span> <span class="i">@$row</span><span class="cm">,</span>
                  <span class="s">(</span> <span class="i">$display_button</span><span class="cm">,</span> <span class="i">$modify_button</span><span class="cm">,</span> <span class="i">$delete_button</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>    <span class="c"># end of unshift for buttons</span>
        <span class="s">}</span>
        <span class="k">my</span> <span class="i">$row_contents</span><span class="sc">;</span>

        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$element</span> <span class="s">(</span><span class="i">@$row</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$element</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$row_contents</span> .=
                  <span class="q">&quot;&lt;td align=\&quot;right\&quot; class=\&quot;pme-key-1\&quot;&gt;$element&lt;/td&gt;&quot;</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>    <span class="c"># end of pack up row contents</span>
             <span class="c"># make stripey styles</span>
        <span class="k">my</span> <span class="i">$row_style</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$record_counter</span> % <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$row_style</span> = <span class="q">&quot;odd&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$row_style</span> = <span class="q">&quot;even&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$row_contents</span> = <span class="q">&quot;&lt;tr class=\&quot;$row_style\&quot;&gt;$row_contents&lt;/tr&gt;\n&quot;</span><span class="sc">;</span>

        <span class="c"># kludge for debits class in row#</span>
        <span class="c"># this is monolingual and needs to be revisited</span>
        <span class="i">$row_contents</span> =~ <span class="q">s/key-1/key-rejected/g</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$row_contents</span> =~ <span class="q">/rejected|declined/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$row_contents</span> =~ <span class="q">s/key-1/key-debit/g</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$row_contents</span> =~ <span class="q">/debit/</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># splits that are not declined in orange</span>
        <span class="i">$row_contents</span> =~ <span class="q">s/key-\w+/key-split/g</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$row_contents</span> =~ <span class="q">/split/</span> &amp;&amp; <span class="i">$row_contents</span> !~ <span class="q">/declined/</span> <span class="s">)</span><span class="sc">;</span>

        <span class="i">$html</span> .= <span class="i">$row_contents</span><span class="sc">;</span>

        <span class="c"># colspan is the row size</span>
        <span class="i">$colspan</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@$row</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$record_counter</span>++<span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># end of loop for records</span>

    <span class="k">my</span> <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span>
      <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># only do all the formatting, if there are some results returned</span>
    <span class="k">my</span> <span class="i">$col_titles</span><span class="sc">;</span>

    <span class="c"># create paging info for top of display</span>
    <span class="k">my</span> <span class="i">$paging_html</span> = <span class="i">&amp;Ccu::make_page_links</span><span class="s">(</span> <span class="i">$total_count</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># if there are results, use multilingual table title..</span>
    <span class="k">my</span> <span class="i">$table_title</span> = <span class="i">$messages</span>{<span class="i">$table</span>}<span class="sc">;</span>

    <span class="k">my</span> <span class="i">$table_title</span> = <span class="i">$messages</span>{<span class="i">$table</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$thisspan</span>    = <span class="i">$colspan</span> + <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$header</span><span class="sc">;</span>

    <span class="c"># if there&#39;s more than one page and not csv show paging</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$paging_html</span><span class="s">)</span> &amp;&amp; <span class="i">$$fieldsref</span>{<span class="w">mode</span>} <span class="k">ne</span> <span class="q">&#39;csv&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$header</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &lt;tr&gt;</span>
<span class="hh">         &lt;td class=&quot;pme-key-title&quot; colspan=&quot;$thisspan&quot;&gt;$messages{pages} $paging_html&lt;/td&gt;</span>
<span class="hh">   &lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$total_count</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$column_array_ref</span> <span class="s">)</span> =
          <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;describe $table&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">@columns</span><span class="sc">;</span>

        <span class="c"># edit the column headings</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span><span class="i">@$column_array_ref</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$$row</span>[<span class="n">0</span>] =~ <span class="q">s/trade|user//</span><span class="sc">;</span>
            <span class="k">push</span> <span class="i">@columns</span><span class="cm">,</span> <span class="i">$$row</span>[<span class="n">0</span>]<span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># end of edit column heading</span>

        <span class="i">@columns</span> = <span class="i">@columns</span>[ <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">16</span><span class="cm">,</span> <span class="n">17</span> .. <span class="n">19</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_users&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">delete</span> <span class="i">@columns</span>[ <span class="n">1</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span> ] <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_partners&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">delete</span> <span class="i">@columns</span>[ <span class="n">3</span><span class="cm">,</span> <span class="n">10</span> .. <span class="n">14</span> ] <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">delete</span> <span class="i">@columns</span>[ <span class="n">4</span><span class="cm">,</span> <span class="n">6</span><span class="cm">,</span> <span class="n">7</span><span class="cm">,</span> <span class="n">9</span><span class="cm">,</span> <span class="n">11</span> .. <span class="n">18</span> ]
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&quot;om_yellowpages&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># buttons are not the same for trades, can&#39;t modify or delete</span>
        <span class="c"># can accept or decline waiting trades. No buttons and no button</span>
        <span class="c"># titles for passthrough to Drupla or Elgg</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">ne</span> <span class="q">&quot;om_trades&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">unshift</span> <span class="i">@columns</span><span class="cm">,</span>
              <span class="s">(</span> <span class="i">$messages</span>{<span class="w">display</span>}<span class="cm">,</span> <span class="i">$messages</span>{<span class="w">modify</span>}<span class="cm">,</span> <span class="i">$messages</span>{<span class="w">delete</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">mode</span>} <span class="k">ne</span> <span class="q">&#39;csv&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">unshift</span> <span class="i">@columns</span><span class="cm">,</span>
              <span class="s">(</span> <span class="i">$messages</span>{<span class="w">display</span>}<span class="cm">,</span> <span class="i">$messages</span>{<span class="w">ok</span>}<span class="cm">,</span> <span class="i">$messages</span>{<span class="w">no</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># end of unshift column titles</span>

        <span class="k">my</span> <span class="i">$row</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$entry</span> <span class="s">(</span><span class="i">@columns</span><span class="s">)</span> <span class="s">{</span>
            <span class="i">$row</span> .= <span class="q">&quot;&lt;td class=\&quot;pme-key-title\&quot;&gt;$entry&lt;/td&gt;&quot;</span>
              <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$entry</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c"># end of make column titles</span>

        <span class="i">$col_titles</span> .= <span class="q">&quot;&lt;tr&gt;$row&lt;/tr&gt;\n&quot;</span><span class="sc">;</span>

        <span class="i">$header</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">      &lt;tr&gt;</span>
<span class="hh">         &lt;td class=&quot;pme-key-title&quot; colspan=&quot;$colspan&quot;&gt;$messages{found} $total_count $messages{$trade_type} $messages{in} $table_title&lt;/td&gt;</span>
<span class="hh">     &lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="i">$header</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">      &lt;tr&gt;</span>
<span class="hh">         &lt;td class=&quot;pme-key-1&quot; colspan=&quot;$colspan&quot;&gt; $total_count $messages{in} $table_title&lt;/td&gt;</span>
<span class="hh">     &lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="i">$html</span> =
<span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$header $col_titles $html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="get_trades">get_trades</a></h3>
<p>coded 07/2007</p>
<p>Delivers count of trades and an arrray reference
for the retrieved trades.</p>
<p>For admin level users all trades are delivered,
for user level only trades that have tradeDestination 
or tradeSource = user are delivered</p>
<p>This is the first step in descrambling get_many_items</p>
<p>This is the complete enum of statuses:
enum('waiting', 'rejected', 'timedout', 'accepted', 'cleared', 'declined', 'cancelled')</p>
<p><table cellspacing="0" cellpadding="0"><tr><td>type can be all <td>= all transactions
<tr><td>            active <td>= waiting and accepted
<tr><td>            accepted <td>= accepted (this is the value for arithmetic)
<tr><td>            not_accepted <td>= declined and cancelled
<tr><td>            error <td>= rejected and timedout</table></p>
<pre>
<a name="get_trades-"></a><span class="k">sub </span><span class="m">get_trades</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$user</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlstring</span><span class="sc">;</span>

    <span class="c"># first select base set, only records for user, if not admin</span>
    <span class="c"># debits and opening balances are user sourced, credits are remote sourced</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">((tradeSource = &#39;$user&#39; and (tradeType = &#39;debit&#39; or tradeType = &#39;open&#39;))</span>
<span class="hh"> or</span>
<span class="hh"> (tradeDestination = &#39;$user&#39; and  tradeType = &#39;credit&#39;)</span>
<span class="hh">)</span>
<span class="h">EOT</span>

        <span class="c"># then refine for various status types and append to sql statement</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&quot;active&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlstring</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">and (tradeStatus = &#39;waiting&#39; or tradeStatus = &#39;accepted&#39;)</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&quot;accepted&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlstring</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">and (tradeStatus = &#39;accepted&#39;)</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&quot;not_accepted&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlstring</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">and (tradeStatus = &#39;declined&#39; or tradeStatus = &#39;cancelled&#39;)</span>
<span class="h">EOT</span>

        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$type</span> <span class="k">eq</span> <span class="q">&quot;error&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$sqlstring</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">and (tradeStatus = &#39;rejected&#39; or tradeStatus = &#39;timedout&#39;)</span>
<span class="h">EOT</span>

        <span class="s">}</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> &amp;&amp; <span class="i">$type</span> <span class="k">eq</span> <span class="q">&quot;all&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$sqlstring</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="c"># error condition needed here</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$sqlcount</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$sqlstring </span>
<span class="h">EOT</span>

    <span class="c"># count the whole set</span>

    <span class="k">my</span> <span class="i">$count</span> = <span class="i">sqlcount</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$sqlcount</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># sqlfind either records belonging to this account, or all, if an admin is asking</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$trade_array_ref</span> <span class="s">)</span> = <span class="i">sqlfind</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span>     <span class="i">$db</span><span class="cm">,</span>              <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span>
        <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;tradeDate desc&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>      <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$count</span><span class="cm">,</span> <span class="i">$trade_array_ref</span><span class="sc">;</span>

<span class="s">}</span>

</pre><p></p>
<h3><a name="collect_items">collect_items</a></h3>
<p>FIXME: This has become a problem in that it is invoked, when there's not a
valid user or registry, because it is implicated in display_template..</p>
<p>This is exanded to collect currencies, languages, yellowpage categories
This is a possible flaw, all the currencies have to be collected from the
home registry</p>
<p>Read this registry collect complete list of currencies. 
Check later in transaction for allowed currency combinations. 
This needs to be moved further to the top later</p>
<p>Only select mode works at present Needs to be generalised so that it 
only collects active items via 'status'. 
This is hacked in for yellow page categories, at present.</p>
<p>Amended not to display closed or suspended currencies in 12/2005</p>
<pre>
<a name="collect_items-"></a><span class="k">sub </span><span class="m">collect_items</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$ordinal</span><span class="cm">,</span>
        <span class="i">$mode</span><span class="cm">,</span>  <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">return</span> <span class="q">&#39;&#39;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$db</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$rc</span><span class="cm">,</span> <span class="i">$record_id</span><span class="cm">,</span> <span class="i">$entry</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$option_string</span><span class="cm">,</span> <span class="i">%duplicates</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># hacked in special sql for categories, keep them in order in the drop down</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_categories&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$sqlstring</span> =
          <span class="q">&quot;SELECT * FROM `om_categories` WHERE 1 order by parent,description&quot;</span><span class="sc">;</span>
        <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
          <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$id</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
          <span class="i">get_where_multiple</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="q">&quot;*&quot;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
            <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$first_pass</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$save</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span> <span class="i">@</span>{<span class="i">$array_ref</span>} <span class="s">)</span> <span class="s">{</span>

 <span class="c">#------------------------------------------------------------------------------</span>
 <span class="c"># only take active items from categories table</span>
 <span class="c"># this needs to become more general</span>
 <span class="c"># ordinal = 2 means that major categories are collected for a category update</span>
 <span class="c"># somewhat kludged...</span>

        <span class="k">next</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_categories&#39;</span>
            &amp;&amp; <span class="i">$$row</span>[<span class="n">3</span>] <span class="k">eq</span> <span class="q">&#39;inactive&#39;</span>
            &amp;&amp; <span class="i">$ordinal</span> != <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>

   <span class="c"># don&#39;t display currencies that are declared as closed or suspended/predelete</span>
        <span class="k">next</span>
          <span class="k">if</span> <span class="s">(</span>
            <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_currencies&#39;</span>
            &amp;&amp; <span class="s">(</span>   <span class="i">$$row</span>[<span class="n">5</span>] <span class="k">eq</span> <span class="q">&#39;closed&#39;</span>
                || <span class="i">$$row</span>[<span class="n">3</span>] <span class="k">eq</span> <span class="q">&#39;suspended&#39;</span>
                || <span class="i">$$row</span>[<span class="n">3</span>] <span class="k">eq</span> <span class="q">&#39;predelete&#39;</span> <span class="s">)</span>
          <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$item</span> = <span class="i">$$row</span>[<span class="i">$ordinal</span>]<span class="sc">;</span>
        <span class="k">my</span> <span class="i">$x</span>    = <span class="n">1</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$name</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$checked</span><span class="sc">;</span>

        <span class="c"># if it&#39;s not already defined and not a current subdirectory</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">defined</span> <span class="i">$duplicates</span>{<span class="i">$item</span>} &amp;&amp; <span class="i">$item</span> !~ <span class="q">/\056/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$mode</span> <span class="k">eq</span> <span class="q">&quot;select&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$table</span> <span class="k">eq</span> <span class="q">&#39;om_categories&#39;</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="i">$ordinal</span> != <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hashref</span> <span class="s">)</span> =
                          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_categories&#39;</span><span class="cm">,</span> <span class="q">&#39;category&#39;</span><span class="cm">,</span>
                            <span class="i">$$row</span>[<span class="n">2</span>]<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># put the code into the value with the literal: group the categories with optgroup</span>
                        <span class="i">$option_string</span> .=
                          <span class="q">&quot;&lt;optgroup label=\&quot;$$hashref{description}\&quot;&gt;&quot;</span>
                          <span class="k">if</span> <span class="s">(</span> <span class="i">$first_pass</span> || <span class="i">$save</span> <span class="k">ne</span> <span class="i">$$row</span>[<span class="n">2</span>] <span class="s">)</span><span class="sc">;</span>
                        <span class="i">$option_string</span> .=
<span class="q">&quot;&lt;option value=\&quot;$$row[1],$$row[2],$item\&quot;&gt;\u$item&lt;/option&gt;\n&quot;</span><span class="sc">;</span>
                        <span class="i">$option_string</span> = <span class="q">&quot;&lt;/optgroup&gt;$option_string&quot;</span>
                          <span class="k">if</span> <span class="s">(</span> <span class="i">$first_pass</span> || <span class="i">$save</span> <span class="k">ne</span> <span class="i">$$row</span>[<span class="n">2</span>] <span class="s">)</span><span class="sc">;</span>
                        <span class="i">$save</span>       = <span class="i">$$row</span>[<span class="n">2</span>]<span class="sc">;</span>
                        <span class="i">$first_pass</span> = <span class="n">0</span><span class="sc">;</span>
                    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hashref1</span> <span class="s">)</span> =
                          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_categories&#39;</span><span class="cm">,</span> <span class="q">&#39;category&#39;</span><span class="cm">,</span>
                            <span class="i">$$row</span>[<span class="n">2</span>]<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
                        <span class="i">$option_string</span> .=
<span class="q">&quot;&lt;option value=\&quot;$$row[2]\&quot;&gt;\u$$hashref1{description}&lt;/option&gt;\n&quot;</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$option_string</span> .=
                      <span class="q">&quot;&lt;option value=\&quot;$item\&quot;&gt;\u$item&lt;/option&gt;\n&quot;</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$mode</span> <span class="k">eq</span> <span class="q">&quot;checkbox&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$name</span> = <span class="q">&quot;$item$x&quot;</span><span class="sc">;</span>
                <span class="i">$checked</span> = <span class="q">&quot;checked&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$$fieldsref</span>{<span class="i">$name</span>} <span class="s">)</span><span class="sc">;</span>
                <span class="i">$option_string</span> .=
<span class="q">&quot;&lt;input type=\&quot;checkbox\&quot; name=\&quot;$name\&quot; $checked value=\&quot;$item\&quot;&gt;\u$item &amp;nbsp;&quot;</span><span class="sc">;</span>
                <span class="k">undef</span> <span class="i">$checked</span><span class="sc">;</span>
                <span class="i">$x</span>++<span class="sc">;</span>
            <span class="s">}</span>
            <span class="i">$duplicates</span>{<span class="i">$item</span>} = <span class="q">&quot;y&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="i">$option_string</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="notify_by_mail">notify_by_mail</a></h3>
<p>Give activation URL for new account or new password for account via email. This will only normally work
on Linux based systems. Note that the forged header needs to be changed
and may be a current problem</p>
<p>Modify the display name elegantly to tell them which registry</p>
<p>notification type is  1 for new users
                      2 for forgotten password
		      3 general mailing
		      4 sms gateway messages</p>
<p>smtp is a mail server in addition to localhost</p>
<pre>
<a name="notify_by_mail-"></a><span class="k">sub </span><span class="m">notify_by_mail</span> <span class="s">{</span>

    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$name</span><span class="cm">,</span>           <span class="i">$email</span><span class="cm">,</span>       <span class="i">$systemfrom</span><span class="cm">,</span>
        <span class="i">$return_address</span><span class="cm">,</span> <span class="i">$accountname</span><span class="cm">,</span> <span class="i">$smtp</span><span class="cm">,</span>
        <span class="i">$urlstring</span><span class="cm">,</span>      <span class="i">$text</span><span class="cm">,</span>        <span class="i">$notificationtype</span><span class="cm">,</span>
        <span class="i">$hash</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># new style configuration read </span>
    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    
    <span class="c"># cite an additional mailserver if necessary, localhost is default</span>
    <span class="i">$mailcfg</span>{<span class="w">smtp</span>} = <span class="s">[</span><span class="q">qw(localhost $smtp)</span><span class="s">]</span> <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$smtp</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$message</span><span class="cm">,</span> <span class="i">$from</span><span class="cm">,</span> <span class="i">$subject</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$from</span>    = <span class="q">&quot;cclite new account at $registry &lt;$return_address&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$subject</span> = <span class="q">&quot;$messages{pleaseactivate}\r\n\r\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$messages{hi} $name, </span>
<span class="hh">$messages{pleasenote}</span>

<span class="hh">$urlstring</span>

<span class="hh">$messages{usernameis} $accountname $messages{suppliedwhen}</span>
<span class="hh">.</span>

<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># forgotten password</span>

    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$from</span>    = <span class="q">&quot;cclite $messages{newpassword1}&lt;$return_address&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$subject</span> = <span class="q">&quot;$messages{newpassword}\r\n\r\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$messages{hi} $name, </span>

<span class="hh">$urlstring</span>

<span class="hh">$messages{usernameis} $accountname </span>
<span class="hh">.</span>


<span class="h">EOT</span>

        <span class="c"># type 3 is general letters to everyone within a registry</span>
        <span class="c"># not implemented at present</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">3</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$from</span>    = <span class="q">&quot;member mailing &lt;$return_address&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$subject</span> = <span class="q">&quot;$messages{generalmailing}\r\n\r\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$messages{hi} $name, </span>

<span class="hh">$text</span>

<span class="hh">$messages{usernameis} $accountname </span>
<span class="hh">.</span>


<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># type 4 is for sms confirmations and other sms</span>
    <span class="c"># operations, this is a bit of a mess now...</span>
    <span class="k">elsif</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">4</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$from</span>    = <span class="q">&quot;$messages{smstransactionemailtitle} &lt;$return_address&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$subject</span> = <span class="q">&quot;$messages{smstransactiontitle}\r\n\r\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$messages{hi} $name, </span>

<span class="hh">$text</span>
<span class="hh">$messages{usernameis} $accountname </span>

<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">5</span> <span class="s">)</span> <span class="s">{</span>

    <span class="c"># type 5 is for new style mail confirmations and other mail transaction related</span>
    <span class="c"># operations, this is more of a mess now...</span>

        <span class="i">$from</span>    = <span class="q">&quot;$registry mail transactions &lt;$return_address&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$subject</span> = <span class="q">&quot;$registry mail transaction result \r\n\r\n&quot;</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">$messages{hi} $name, </span>

<span class="hh">$text</span>
<span class="hh">$messages{usernameis} $accountname </span>

<span class="h">EOT</span>


   
    <span class="s">}</span>



    <span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">net_smtp</span>} <span class="s">)</span> <span class="s">{</span>
    <span class="k">eval</span> <span class="s">{</span>
        <span class="c"># new style use configuration from Ccconfiguration.pm 11/2009</span>
  
        
        <span class="c"># read the current registry to pick up per-registry email values</span>
      <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span>
            <span class="n">1</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
      <span class="k">my</span> <span class="i">$return_address</span> = <span class="i">$registryref</span>-&gt;{<span class="w">admemail</span>} <span class="sc">;</span>
      <span class="k">my</span> <span class="i">$password</span> = <span class="i">$registryref</span>-&gt;{<span class="w">admpass</span>} <span class="sc">;</span>    
      <span class="k">my</span> <span class="i">$host</span> = <span class="i">$return_address</span> <span class="sc">;</span>
        <span class="c"># get the domain part as postbox...</span>
         <span class="i">$host</span> =~ <span class="q">s/^(.*?)\@(.*)$/$2/</span> <span class="sc">;</span>
         
        <span class="k">my</span> <span class="i">$smtp</span> = <span class="w">Net::SMTP</span><span class="w">-&gt;new</span><span class="s">(</span>
            <span class="i">$host</span><span class="cm">,</span>
            <span class="w">Timeout</span> <span class="cm">=&gt;</span> <span class="n">30</span><span class="cm">,</span>
            <span class="w">Debug</span>   <span class="cm">=&gt;</span> <span class="n">0</span><span class="cm">,</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="i">$smtp</span><span class="i">-&gt;auth</span><span class="s">(</span>
            <span class="i">$return_address</span><span class="cm">,</span>
            <span class="i">$password</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="c"># from address, the logged in address with override</span>
        <span class="i">$smtp</span><span class="i">-&gt;mail</span><span class="s">(</span><span class="i">$return_address</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># to address</span>
        <span class="i">$smtp</span><span class="i">-&gt;to</span><span class="s">(</span><span class="i">$email</span><span class="s">)</span><span class="sc">;</span>

        <span class="c"># maildata</span>
        <span class="i">$smtp</span><span class="i">-&gt;data</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$smtp</span><span class="i">-&gt;datasend</span><span class="s">(</span><span class="q">&quot;To: $email\n&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$smtp</span><span class="i">-&gt;datasend</span><span class="s">(</span><span class="q">&quot;Subject: $subject\n&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$smtp</span><span class="i">-&gt;datasend</span><span class="s">(</span><span class="q">&quot;\n&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$smtp</span><span class="i">-&gt;datasend</span><span class="s">(</span><span class="q">&quot;$message\n&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$smtp</span><span class="i">-&gt;dataend</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="i">$smtp</span><span class="i">-&gt;quit</span><span class="sc">;</span>
        
    <span class="s">}</span> <span class="sc">;</span> <span class="c"># end of Net::SMTP eval</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

        <span class="k">eval</span> <span class="s">{</span>

            <span class="k">my</span> <span class="i">%mail</span> = <span class="s">(</span>
                <span class="w">To</span>      <span class="cm">=&gt;</span> <span class="i">$email</span><span class="cm">,</span>
                <span class="w">From</span>    <span class="cm">=&gt;</span> <span class="i">$from</span><span class="cm">,</span>
                <span class="w">Subject</span> <span class="cm">=&gt;</span> <span class="i">$subject</span><span class="cm">,</span>
                <span class="w">Message</span> <span class="cm">=&gt;</span> <span class="i">$message</span><span class="cm">,</span>
            <span class="s">)</span><span class="sc">;</span>

            <span class="i">sendmail</span><span class="s">(</span><span class="i">%mail</span><span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="i">$Mail::Sendmail::error</span><span class="sc">;</span>

        <span class="s">}</span><span class="sc">;</span>

    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;error</span><span class="s">(</span><span class="q">&quot;mail error is: $@ $message&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$@</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>

</pre><p></p>
<h3><a name="windows_notifybymail">windows_notifybymail</a></h3>
<p>Give activation URL for new account or new password for account via email. This will only normally work
on Windows based systems. Note that the forged header needs to be changed
and may be a current problem</p>
<p>notification type is 1 for new users
                      2 for forgotten password</p>
<p>This hasn't been tested for about a year as of 2005 and is certainly probably broken</p>
<pre>
<a name="windows_notifybymail-"></a><span class="k">sub </span><span class="m">windows_notifybymail</span> <span class="s">{</span>

    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$name</span><span class="cm">,</span>           <span class="i">$email</span><span class="cm">,</span>            <span class="i">$systemfrom</span><span class="cm">,</span>
        <span class="i">$return_address</span><span class="cm">,</span> <span class="i">$accountname</span><span class="cm">,</span>      <span class="i">$urlstring</span><span class="cm">,</span>
        <span class="i">$text</span><span class="cm">,</span>           <span class="i">$notificationtype</span><span class="cm">,</span> <span class="i">$hash</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$return_code</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c"># Create the object without any arguments,</span>
    <span class="c"># i.e. localhost is the default SMTP server.</span>
    <span class="c">#</span>
    <span class="k">my</span> <span class="i">$sm</span> = <span class="w">new</span> <span class="i">SendMail</span><span class="s">(</span><span class="q">&quot;smtp.dsl.pipex.com&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c"># Set SMTP AUTH login profile.</span>
    <span class="c"># Uncomment the following line if you like to try SMTP AUTH.</span>
    <span class="c">#</span>
    <span class="c">#$sm-&gt;setAuth($sm-&gt;AUTHLOGIN, &quot;username&quot;, &quot;password&quot;);</span>
    <span class="c">#$sm-&gt;setAuth($sm-&gt;AUTHPLAIN, &quot;username&quot;, &quot;password&quot;);</span>
    <span class="c">#</span>
    <span class="c"># We set the debug mode &quot;ON&quot;.</span>
    <span class="c">#</span>
    <span class="i">$sm</span><span class="i">-&gt;setDebug</span><span class="s">(</span> <span class="i">$sm</span><span class="i">-&gt;OFF</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Set the sender.</span>
    <span class="i">$sm</span><span class="i">-&gt;From</span><span class="s">(</span><span class="i">$return_address</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># Set the subject.</span>
    <span class="i">$sm</span><span class="i">-&gt;Subject</span><span class="s">(</span><span class="q">&quot;cclite account confirmation&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># We set the recipient.</span>
    <span class="i">$sm</span><span class="i">-&gt;To</span><span class="s">(</span><span class="q">&quot;Recipient &lt;$email&gt;&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$sm</span><span class="i">-&gt;setMailHeader</span><span class="s">(</span> <span class="q">&#39;content-type&#39;</span><span class="cm">,</span> <span class="q">&#39;text/html&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$mail_string</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$mail_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">From:cclite new account &lt;$return_address&gt;</span>
<span class="hh">Subject: $messages{pleaseactivate}\r\n\r\n</span>
<span class="hh">$messages{hi} $name, </span>
<span class="hh">$messages{pleasenote}</span>

<span class="hh">$urlstring</span>

<span class="hh">$messages{usernameis} $accountname $messages{suppliedwhen}</span>
<span class="hh">.</span>


<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$mail_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">From:cclite new password &lt;$return_address&gt;</span>
<span class="hh">Subject: $messages{newpassword}\r\n\r\n</span>
<span class="hh">$messages{hi} $name, </span>


<span class="hh">$urlstring</span>

<span class="hh">$messages{usernameis} $accountname </span>
<span class="hh">.</span>


<span class="h">EOT</span>

        <span class="c"># type 3 is general letters to everyone within a registry</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$notificationtype</span> == <span class="n">3</span> <span class="s">)</span> <span class="s">{</span>

        <span class="i">$mail_string</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">From:member mailing &lt;$return_address&gt;</span>
<span class="hh">Subject: $messages{generalmailing}\r\n\r\n</span>
<span class="hh">$messages{hi} $name, </span>

<span class="hh">$text</span>

<span class="hh">$messages{usernameis} $accountname </span>
<span class="hh">.</span>


<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="c"># Set the content of the mail.</span>
    <span class="i">$sm</span><span class="i">-&gt;setMailBody</span><span class="s">(</span><span class="i">$mail_string</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># Attach a testing image.</span>
<span class="c">### $sm-&gt;Inline($urlstring);</span>
    <span class="c"># Check if the mail sent successfully or not.</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$sm</span><span class="i">-&gt;sendMail</span><span class="s">(</span><span class="s">)</span> != <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$return_code</span> = <span class="i">$sm</span>-&gt;{<span class="q">&#39;error&#39;</span>}<span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$return_code</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Mail sent successfully.</span>
    <span class="k">return</span> <span class="i">$return_code</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="forgotten_password">forgotten_password</a></h3>
<p>Create and send a password to a person that forgot it
Checks that the email address is in the db and corresponds to an
active user. Generates a new password, sends it, dispays a result
and returns</p>
<pre>
<a name="forgotten_password-"></a><span class="k">sub </span><span class="m">forgotten_password</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">%cookie</span><span class="cm">,</span> <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># get the user record from the database, depending on login type</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$status</span><span class="cm">,</span> <span class="i">$userref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="q">&quot;userEmail&quot;</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="w">userEmail</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no user found for this email</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userId</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$html</span> =
<span class="q">&quot;email not found $$fieldsref{userEmail} at $$fieldsref{registry}: $status&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$userref</span>{<span class="w">userStatus</span>} <span class="k">ne</span> <span class="q">&#39;active&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$html</span> = <span class="q">&quot;user $$fieldsref{userLogin} at $db is not active&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;1&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span>
            <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$password</span> = <span class="i">random_password</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># get a random password</span>
        <span class="i">$$userref</span>{<span class="w">userPassword</span>} = <span class="i">$password</span><span class="sc">;</span> <span class="c"># don&#39;t hash it done at update time</span>
        <span class="k">my</span> <span class="i">$passwordstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh"> $messages{heresyourpassword} $$fieldsref{registry}, $messages{pleasechangeit}\n\n</span>
<span class="hh">  $password</span>
<span class="h">EOT</span>

        <span class="c"># update the database with old record + new password field</span>
        <span class="c"># type 2 notification for forgotten password</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$a</span><span class="cm">,</span> <span class="i">$b</span><span class="cm">,</span> <span class="i">$c</span><span class="cm">,</span> <span class="i">$d</span> <span class="s">)</span> =
          <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span>
            <span class="i">$userref</span><span class="cm">,</span> <span class="i">$$userref</span>{<span class="w">language</span>}<span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># ....and mail it</span>

        <span class="k">my</span> <span class="i">$mail_return</span> = <span class="i">notify_by_mail</span><span class="s">(</span>
            <span class="i">$class</span><span class="cm">,</span>
            <span class="i">$db</span><span class="cm">,</span>
            <span class="i">$$userref</span>{<span class="w">userName</span>}<span class="cm">,</span>
            <span class="i">$$userref</span>{<span class="w">userEmail</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">systemMailAddress</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">systemMailReplyAddress</span>}<span class="cm">,</span>
            <span class="i">$$userref</span>{<span class="w">userLogin</span>}<span class="cm">,</span>
            <span class="i">$$fieldsref</span>{<span class="w">smtp</span>}<span class="cm">,</span>
            <span class="i">$passwordstring</span><span class="cm">,</span>
            <span class="k">undef</span><span class="cm">,</span>
            <span class="n">2</span><span class="cm">,</span>
            <span class="q">&quot;&quot;</span>
        <span class="s">)</span><span class="sc">;</span>

        <span class="i">$html</span> = <span class="i">$messages</span>{<span class="w">passwordsent</span>}<span class="sc">;</span>
        <span class="c">###return;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span>
            <span class="i">$cookieheader</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_balance_and_volume">show_balance_and_volume</a></h3>
<p>Create and display balances. For a given user calculate volume of trade activity
and current balance for each currency for which they participate
</p>
<pre>

Necessary anyway for user, also for transaction fees and demurrage, perhaps
Same signature as get many items</pre>
<p>FIXME: Needs to move to hash style fetch to become more robust

</p>
<p>This is array based so it will break if the transactions table changes
Should be templated soon, titles already multilingual

</p>
<p>Modified to display only the last six months of trading
Modified so that only balance shows red if in debit, volumes are unsigned anyway

</p>
<p>As of 07/2006 now uses  $mode to return balance and volume without html,
this is more mvc work 

</p>

<pre>
<a name="show_balance_and_volume-"></a><span class="k">sub </span><span class="m">show_balance_and_volume</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>   <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$name</span><span class="cm">,</span>  <span class="i">$mode</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>    <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="c"># find all transactions for a given name</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$type</span> = <span class="q">&quot;active&quot;</span><span class="sc">;</span>
    <span class="i">$type</span> = <span class="q">&quot;all&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">is_admin</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># hack for large limit clause...</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registry_error</span><span class="cm">,</span> <span class="i">$total_count</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
      <span class="i">get_trades</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span>
        <span class="n">99999999</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%balances</span><span class="sc">;</span>    <span class="c">#  hash of balances keyed on currency</span>
    <span class="k">my</span> <span class="i">%volumes</span><span class="sc">;</span>     <span class="c">#  hash of volumes keyed on currency</span>
                     <span class="c"># phase one: accumulate</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row</span> <span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$month</span> = <span class="k">substr</span><span class="s">(</span> <span class="i">$$row</span>[<span class="n">2</span>]<span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>   <span class="c"># this is the month in tradeDate</span>
        <span class="k">my</span> <span class="i">$year</span>  = <span class="k">substr</span><span class="s">(</span> <span class="i">$$row</span>[<span class="n">2</span>]<span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">4</span> <span class="s">)</span><span class="sc">;</span>   <span class="c"># this is the month in tradeDate</span>

<span class="c"># now just adds everything in line with LETS received wisdom about volumes</span>
<span class="c"># but the total balance for each currency is preserved, declined and cancelled are not counted</span>
<span class="c"># 2/12/2005</span>
<span class="c"># 1/7/2007 only include active and waiting</span>
        <span class="c">###     next  if ( $$row[1] ne &quot;active&quot; &amp;&amp; $$row[1] ne &quot;waiting&quot; );</span>

        <span class="c"># don&#39;t count declined, cancelled or error trades in totals</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$$row</span>[<span class="n">8</span>] <span class="k">eq</span> <span class="q">&#39;credit&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$balances</span>{ <span class="i">$$row</span>[<span class="n">7</span>] } += <span class="i">$$row</span>[<span class="n">9</span>]<span class="sc">;</span> <span class="c"># add to the currency accumulator</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$row</span>[<span class="n">8</span>] <span class="k">eq</span> <span class="q">&#39;debit&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$balances</span>{ <span class="i">$$row</span>[<span class="n">7</span>] } -=
              <span class="i">$$row</span>[<span class="n">9</span>]<span class="sc">;</span>    <span class="c"># subtract from the currency accumulator</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$row</span>[<span class="n">8</span>] <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$balances</span>{ <span class="i">$$row</span>[<span class="n">7</span>] } +=
              <span class="i">$$row</span>[<span class="n">9</span>]<span class="sc">;</span>    <span class="c"># add to the currency accumulator: signed</span>
        <span class="s">}</span>

<span class="c"># cumulate month also, add only, to give &#39;volume&#39;: abs is used because balances are signed</span>
        <span class="i">$balances</span>{<span class="q">&quot;$year-$month-$$row[7]&quot;</span>} += <span class="k">abs</span><span class="s">(</span> <span class="i">$$row</span>[<span class="n">9</span>] <span class="s">)</span><span class="sc">;</span>
        <span class="i">$volumes</span>{ <span class="i">$$row</span>[<span class="n">7</span>] }++<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># phase two accumulate trading history by month and report it</span>
    <span class="c"># these aren&#39;t really -all- currencies, they&#39;re various hash keys</span>
    <span class="c"># reverse sort, most recent entries first 2005 before 2004 etc.</span>

    <span class="c"># maxreport can be passed in to give a &#39;little&#39; sidebar display</span>
    <span class="k">my</span> <span class="i">$maxreport</span> = <span class="i">$$fieldsref</span>{<span class="w">maxreport</span>} || <span class="n">6</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%counts</span><span class="sc">;</span>    <span class="c"># count history for each currency</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$currency</span> <span class="s">(</span> <span class="k">reverse</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%balances</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$currency</span> !~ <span class="q">/^\d/</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># not a month balance record, anyway</span>
        <span class="i">$currency</span> =~ <span class="q">/(\d{4})-(\d{2})-(.*)/</span><span class="sc">;</span>  <span class="c"># parse 2005-04-ducket for example</span>
             <span class="c"># count and report only most recent maxreport months reported</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$counts</span>{<span class="i">$3</span>} &lt; <span class="i">$maxreport</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$balances</span>{<span class="q">&quot;history-$3&quot;</span>} .=
              <span class="q">&quot;$balances{$currency} $messages{in} $2/$1 &amp;nbsp;&amp;nbsp;&quot;</span><span class="sc">;</span>
            <span class="i">$counts</span>{<span class="i">$3</span>}++<span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">delete</span> <span class="i">$balances</span>{<span class="i">$currency</span>}<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># phase three: report</span>
    <span class="k">my</span> <span class="i">$record_counter</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$currency</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%balances</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$currency</span> =~ <span class="q">s/history\-//</span> &amp;&amp; <span class="k">next</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$line</span> = <span class="k">join</span><span class="s">(</span>
            <span class="q">&quot;&lt;/td&gt;&lt;td class=\&quot;pme-key-1\&quot;&gt;&quot;</span><span class="cm">,</span>
            <span class="q">&quot;\u$currency&quot;</span><span class="cm">,</span>       <span class="i">$balances</span>{<span class="i">$currency</span>}<span class="cm">,</span>
            <span class="i">$volumes</span>{<span class="i">$currency</span>}<span class="cm">,</span> <span class="i">$balances</span>{<span class="q">&quot;history-$currency&quot;</span>}
        <span class="s">)</span><span class="sc">;</span>

<span class="c"># kludge for debits, only substitute first class because that&#39;s the -balance- report</span>
<span class="c"># volumes are, by their nature, unsigned, just add up everything...</span>
<span class="c"># make stripey styles</span>
        <span class="k">my</span> <span class="i">$row_style</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$record_counter</span> % <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$row_style</span> = <span class="q">&quot;odd&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$row_style</span> = <span class="q">&quot;even&quot;</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$line</span> =~ <span class="q">s/key-1/key-debit/</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$balances</span>{<span class="i">$currency</span>} &lt; <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$html</span> .=
<span class="q">&quot;&lt;tr class=\&quot;$row_style\&quot;&gt;&lt;td class=\&quot;pme-key-title\&quot;&gt;$line&lt;/td&gt;&lt;/tr&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$record_counter</span>++<span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$title</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">&lt;tr&gt;&lt;td class=\&quot;pme-key-title\&quot;&gt;$messages{currency}&lt;/td&gt;</span>
<span class="hh">&lt;td class=\&quot;pme-key-title\&quot;&gt;$messages{balance}&lt;/td&gt;</span>
<span class="hh">&lt;td class=\&quot;pme-key-title\&quot;&gt;$messages{trades}&lt;/td&gt;</span>
<span class="hh">&lt;td class=\&quot;pme-key-title\&quot;&gt;$messages{tradevolumes}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$title$html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>

    <span class="c"># default behaviour is to return html</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$mode</span> <span class="k">eq</span> <span class="q">&#39;html&#39;</span> || !<span class="k">length</span><span class="s">(</span><span class="i">$mode</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span>
          <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$mode</span> <span class="k">eq</span> <span class="q">&#39;values&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> \<span class="i">%balances</span><span class="cm">,</span> \<span class="i">%volumes</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
