<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccsmsgateway.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccsmsgateway.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#gateway_sms_transaction">gateway_sms_transaction</a></li>
			<li><a href="#_gateway_sms_pin_change">_gateway_sms_pin_change</a></li>
			<li><a href="#_gateway_sms_pay">_gateway_sms_pay</a></li>
			<li><a href="#_gateway_sms_send_balance">_gateway_sms_send_balance</a></li>
			<li><a href="#sms_message_parse">sms_message_parse</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccsmsgateway-">package Ccsmsgateway</a>
<ul>
<li><a href="#gateway_sms_transaction-">gateway_sms_transaction</a></li>
<li><a href="#_gateway_sms_pin_change-">_gateway_sms_pin_change</a></li>
<li><a href="#_gateway_sms_pay-">_gateway_sms_pay</a></li>
<li><a href="#_gateway_sms_send_balance-">_gateway_sms_send_balance</a></li>
<li><a href="#_sms_message_parse-">_sms_message_parse</a></li>
<li><a href="#_check_pin-">_check_pin</a></li>
<li><a href="#_send_sms_mail_message-">_send_sms_mail_message</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccsmsgateway.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for sms, mail etc.
via commercial sms gateway this will have to be modified
for any new gateway supplier</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains the interface for a complete sms based payment
system with pins supplied in the sms messages. The allowed messages are:</p>
<p>This does a small parse of the incoming message:</p>
<p><table cellspacing="0" cellpadding="0"><tr><td>gwNumber  <td>The destination number
<tr><td>originator <td>The sender's number in format 447779159452
<tr><td>message <td>The message body
<tr><td>smsTime <td>Time when the sms was sent
<tr><td><td>Format: YYYY-MM-DD HH:MM:SS
<tr><td>timeZone <td>An integer, indicating time zone
<tr><td><td>(eg: if timeZone is 1 then it means smsTime is GMT + 1)
<tr><td>network <td>Name of the originating network.
<tr><td><td>Will be replaced with an SMSC reference number if the network is not recognised
<tr><td>id <td>A unique identifier for the message
<tr><td>time <td>Time the message received by gateway (UK time)
<tr><td><td>Format: YYYY-MM-DD HH:MM:SS
<tr><td>coding <td>Message coding 7 (normal), 8 (binary) or 16 (unicode)
<tr><td>status <td>0 - Normal Message
<tr><td><td>1 - Concatenated message, sent unconcatenated
<tr><td><td>2 - Indecipherable UDH (possibly corrupt message)</table></p>
<p>status added for error messages</p>
<p>and dispatches to the appropriate internal function</p>
<p>Pin number is always first thing...</p>
<p>SMS Transactions
-&gt; Confirm pin         p123456 confirm
-&gt; Change pin          p123456 change p345678
-&gt; Pay                 p123456 pay 5 to 07855 524667 for stuff (note need to change strip regex)
                       p123456 pay 5 to 07855524667 for other stuff
                       p123456 pay 5 to 4407855 524667 for stuff</p>
<p>-&gt; Query Balance       p123456 balance (not implemented yet will use one credit!)</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 - 2008 GPL Licenced
</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccsmsgateway-"></a><span class="k">package </span><span class="i">Ccsmsgateway</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>    <span class="c"># new style configuration method</span>

<span class="k">use</span> <span class="w">Net::SMTP::SSL</span><span class="sc">;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(</span>
  <span class="q">gateway_sms_transaction</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash
</p>
<pre>

=cut</pre>
<pre>
<span class="c"># application specific globals</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$registry</span> = <span class="q">&#39;totnes&#39;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$currency</span> = <span class="q">&#39;tpound&#39;</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$log</span>      = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;Ccsmsgateway&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="gateway_sms_transaction">gateway_sms_transaction</a></h3>
<p>This does a validation (could move to ccvalidate) and
an initial parse of the incoming message and
then dispatches to the appropriate internal function</p>
<pre>
<a name="gateway_sms_transaction-"></a><span class="k">sub </span><span class="m">gateway_sms_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$x</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;|&quot;</span><span class="cm">,</span> <span class="i">%$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span>
<span class="q">&quot;\n---------------------------------------------------\nentering gateway:\n $x&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># log and exit if there&#39;s a problem with the received messaged</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;status&#39;</span>} <span class="s">)</span> &amp;&amp; <span class="i">$$fieldsref</span>{<span class="q">&#39;status&#39;</span>} &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;$$fieldsref{&#39;message&#39;} from $$fieldsref{&#39;originator&#39;} rejected with status $$fieldsref{&#39;status&#39;}&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># no originator, so no lookup or no message...reject</span>
    <span class="k">if</span> <span class="s">(</span>   !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>} <span class="s">)</span>
        || !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;$$fieldsref{&#39;message&#39;} from $$fieldsref{&#39;originator&#39;} rejected message or originator is blank&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># initial parse to get transaction type</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="k">my</span> <span class="i">$pin</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$transaction_type</span><span class="sc">;</span>

    <span class="c"># if it hasn&#39;t got a pin, not worth carrying on</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~ <span class="q">m/^\s*p*(\d+)\s+(\w+)/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pin</span>              = <span class="i">$1</span><span class="sc">;</span>
        <span class="i">$transaction_type</span> = <span class="i">$2</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
            <span class="q">&quot;from: $$fieldsref{&#39;originator&#39;} $input -malformed transaction&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
          <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span>
            <span class="q">&quot;from: $$fieldsref{&#39;originator&#39;} $input -malformed transaction&quot;</span><span class="cm">,</span>
            <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># numbers are stored in database as 7855 667524 for example, no zero, no 44</span>
    <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>} =
      <span class="i">format_for_uk_mobile</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># can be ok, locked, waiting, fail</span>
    <span class="k">my</span> <span class="i">$pin_status</span> = <span class="i">_check_pin</span><span class="s">(</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span><span class="q">&quot;$pin $pin_status transaction type is $transaction_type&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$pin_status</span> <span class="k">ne</span> <span class="q">&#39;ok&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># activation is done in _check_pin</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">{</span>    <span class="c">#  p123456 confirm</span>
        <span class="k">return</span> <span class="i">$pin_status</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;change&#39;</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># change pin</span>
        <span class="i">_gateway_sms_pin_change</span><span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;pay&#39;</span> <span class="s">)</span> <span class="s">{</span>       <span class="c"># payment transaction</span>
        <span class="i">_gateway_sms_pay</span><span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;balance&#39;</span> <span class="s">)</span>
    <span class="s">{</span>    <span class="c"># balance transaction not implemented</span>
            <span class="c"># fully yet</span>
        <span class="i">_gateway_sms_send_balance</span><span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
            <span class="q">&quot;from: $$fieldsref{&#39;originator&#39;} $input -unrecognised transaction&quot;</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&#39;unrecognisable transaction&#39;</span><span class="sc">;</span>

        <span class="c"># this is a &#39;bad&#39; transaction of some kind...</span>
    <span class="s">}</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_pin_change_change_pin__same_rules__three_tries__about_pin_locking__cut">_gateway_sms_pin_change
Change pin, same rules (three tries) about pin locking
=cut</a></h3>
<pre>
<a name="_gateway_sms_pin_change-"></a><span class="k">sub </span><span class="m">_gateway_sms_pin_change</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>
    <span class="i">$input</span> =~ <span class="q">m/^\s*p*(\d+)\s+change\s+p(\d+)\s*$/</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$new_pin</span>    = <span class="i">$2</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hashed_pin</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$new_pin</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;smspinchanged&#39;</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$$fromuserref</span>{<span class="q">&#39;userPin&#39;</span>}      = <span class="i">$hashed_pin</span><span class="sc">;</span>
    <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$dummy</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="i">$dummy1</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$dummy2</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fromuserref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_pay">_gateway_sms_pay</a></h3>
<p>Specific transaction written for the pound
using the gateway messaging gateway</p>
<pre>
<a name="_gateway_sms_pay-"></a><span class="k">sub </span><span class="m">_gateway_sms_pay</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$configurationref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%fields</span><span class="cm">,</span> <span class="i">%transaction</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$fields</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># begin parse on whitespace</span>
    <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$fields</span>{<span class="q">&#39;message&#39;</span>} <span class="s">)</span><span class="sc">;</span>    <span class="c"># canonical is lower case</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
      <span class="i">_sms_message_parse</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># sms pay message didn&#39;t parse, not worth proceeding</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$parse_type</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$message</span> =
<span class="q">&quot;pay attempt from $fields{&#39;originator&#39;} to $$transaction_description_ref{&#39;tomobilenumber&#39;} : $messages{&#39;smsinvalidsyntax&#39;}&quot;</span><span class="sc">;</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
          <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span><span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># numbers are stored as 7855 667524 for example, no zero, no 44</span>
    <span class="i">$$transaction_description_ref</span>{<span class="q">&#39;tomobilenumber&#39;</span>} =
      <span class="i">format_for_uk_mobile</span><span class="s">(</span> <span class="i">$$transaction_description_ref</span>{<span class="q">&#39;tomobilenumber&#39;</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error1</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$$transaction_description_ref</span>{<span class="q">&#39;tomobilenumber&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span>
<span class="q">&quot; $$transaction_description_ref{&#39;tomobilenumber&#39;} pin status is $$touserref{&#39;userPinStatus&#39;}&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># one of the above lookups fails, reject the whole transaction</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;smsnoorigin&#39;</span>}      <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="q">&#39;smsnodestination&#39;</span>} <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># recipient didn&#39;t confirm pin yet, transaction invalid</span>
    <span class="k">push</span> <span class="i">@status</span><span class="cm">,</span> <span class="q">&#39;receiving user has not confirmed&#39;</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$$touserref</span>{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">ne</span> <span class="q">&#39;active&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span>
        <span class="q">&quot;$$touserref{&#39;userPinStatus&#39;} $$touserref{&#39;userId&#39;} no confirmation bug&quot;</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$errors</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;:&#39;</span><span class="cm">,</span> <span class="i">@status</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@status</span><span class="s">)</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span><span class="i">$registry</span><span class="cm">,</span> <span class="q">&quot;$errors $input&quot;</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;pay attempt from $fields{&#39;originator&#39;} to $$transaction_description_ref{&#39;tomobilenumber&#39;} : $errors&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$registry</span><span class="sc">;</span>

    <span class="c"># no home, not a web transaction</span>
    <span class="i">$transaction</span>{<span class="w">home</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>

    <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$registry</span><span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$$transaction_description_ref</span>{<span class="q">&#39;quantity&#39;</span>}<span class="sc">;</span>

 <span class="c">#tradeCurrency : if mentioned in sms overrides default: may not be a good idea?</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$transaction_description_ref</span>{<span class="q">&#39;currency&#39;</span>}
      || <span class="i">$currency</span><span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#tradeTitle : added by this routine: now improved 12/2008</span>
    <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} =
<span class="q">&quot;$messages{&#39;smstransactiontitle&#39;} $$fromuserref{&#39;userLogin&#39;} -&gt; $$touserref{&#39;userLogin&#39;}&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDescription</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} =
      <span class="i">$$transaction_description_ref</span>{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$$touserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c"># tradestatus from configured initial status</span>
    <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$fields</span>{<span class="w">initialPaymentStatus</span>}<span class="sc">;</span>

    <span class="c"># FIXME: tradeItem not really identifiable from sms message</span>
    <span class="i">$transaction</span>{<span class="w">tradeItem</span>} = <span class="q">&#39;other&#39;</span><span class="sc">;</span>

    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>

    <span class="c">#build explicative message</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   $messages{&#39;transactionaccepted&#39;} to $transaction{tradeDestination} for value $transaction{tradeAmount}</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error3</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span><span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="_gateway_sms_send_balance">_gateway_sms_send_balance</a></h3>
<p>Send balance, via email at present, sms later...
To be done...</p>
<pre>
<a name="_gateway_sms_send_balance-"></a><span class="k">sub </span><span class="m">_gateway_sms_send_balance</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%fields</span> = <span class="s">(</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userLogin&#39;</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

    <span class="c"># html to return html, values to return raw balances and volumes</span>
    <span class="c"># for each currency</span>
    <span class="s">(</span> <span class="i">$balance_ref</span><span class="cm">,</span> <span class="i">$volume_ref</span> <span class="s">)</span> =
      <span class="i">show_balance_and_volume</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span>
        <span class="i">$$fromuserref</span>{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;values&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># current balance for this particular currency</span>
    <span class="k">my</span> <span class="i">$balance</span> = <span class="i">$$balance_ref</span>{<span class="i">$currency</span>}<span class="sc">;</span>
    <span class="k">my</span> <span class="i">$balance_message</span> =
      <span class="q">&quot;The balance for $fromuserref-&gt;{userLogin} is $balance $currency&quot;</span> . <span class="q">&quot;s&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$mail_error</span><span class="s">)</span> =
      <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span><span class="i">$registry</span><span class="cm">,</span> <span class="i">$balance_message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span><span class="i">$balance_message</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sms_message_parse">sms_message_parse</a></h3>
<p>This is now distinct from the transaction preparation etc.</p>
<p>Also, it returns a status, if the parse doesn't contain one
of the necessary elements for a successful transaction. In that
case the transaction -must- fail and it's not worth continuing</p>
<pre>
<a name="_sms_message_parse-"></a><span class="k">sub </span><span class="m">_sms_message_parse</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction_description</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$parse_type</span> = <span class="n">0</span><span class="sc">;</span>

<span class="c"># parse does not include currency word, single currency only, no description also allowed</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$input</span> =~
<span class="q">m/^\s*p*(\d+)\s+pay\s+(\d+)\s+to\s+(\d{10}|\d{4}\s+\d{6})\s+for\s+(.*)$/i</span>
      <span class="s">)</span>
    <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}       = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;tomobilenumber&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}    = <span class="i">$4</span><span class="sc">;</span>
        <span class="i">$parse_type</span>                                = <span class="n">1</span><span class="sc">;</span>    <span class="c"># no currency word</span>
             <span class="c"># multiple currencies and currency word included,</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$input</span> =~
<span class="q">m/^\s*p*(\d+)\s+pay\s+(\d+)\s+(\w+)\s+to\s+(\d{10}|\d{4}\s+\d{6})\s+for\s+(.*)$/i</span>
      <span class="s">)</span>
    <span class="s">{</span>

        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}       = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>}       = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;tomobilenumber&#39;</span>} = <span class="i">$4</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}    = <span class="i">$5</span><span class="sc">;</span>
        <span class="i">$parse_type</span>                                = <span class="n">2</span><span class="sc">;</span>    <span class="c"># currency word</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$input</span> =~
        <span class="q">m/^\s*p*(\d+)\s+pay\s+(\d+)\s+to\s+(\d{10}|\d{4}\s+\d{6})\s*$/i</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}       = <span class="i">$2</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;tomobilenumber&#39;</span>} = <span class="i">$3</span><span class="sc">;</span>
        <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>} =
          <span class="q">&#39;sms transaction:no description&#39;</span><span class="sc">;</span>
        <span class="i">$parse_type</span> = <span class="n">3</span><span class="sc">;</span>    <span class="c"># no description/no currency word</span>

    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span><span class="q">&quot;unparsed pay transaction is: $input&quot;</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$x</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;|&quot;</span><span class="cm">,</span> <span class="i">%transaction_description</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span><span class="q">&quot;parsed transaction is: $x parse type is $parse_type&quot;</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$parse_type</span><span class="cm">,</span> \<span class="i">%transaction_description</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

</pre><dl><dt><strong><a name="item__check_pin">_check_pin</a></strong></dt>

<dd>
<p>put the pin checking and locking processing into one place
used by every transansaction</p>
<p>returns:
ok 	- pin checks
locked 	- account is locked
waiting - account is not activated/transaction attempt
fail	- pin fail, counts down one off counter/locks if zero</p>
<p>less than 1 is test for try count, just-in-case
=cut</p>
<pre>
<a name="_check_pin-"></a><span class="k">sub </span><span class="m">_check_pin</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$pin</span><span class="cm">,</span> <span class="i">$transaction_type</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$mail_error</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$pin_status</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$hashed_pin</span> = <span class="i">text_to_hash</span><span class="s">(</span><span class="i">$pin</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span>
        <span class="i">$$fieldsref</span>{<span class="q">&#39;originator&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># already locked</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">eq</span> <span class="q">&#39;locked&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
        <span class="i">$mail_error</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># ok, maybe need to reset pin tries though</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">ne</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPin&#39;</span>} <span class="k">eq</span> <span class="i">$hashed_pin</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="i">$pin_status</span>
              <span class="k">if</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} == <span class="n">3</span> <span class="s">)</span><span class="sc">;</span> <span class="c"># this is the main case</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>    <span class="c"># reset to three otherwise</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;fail&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="q">&#39;smspinfail&#39;</span>}<span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>}--<span class="sc">;</span>      <span class="c"># used one pin attempt</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span>                    = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>                       = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># waiting and confirm</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinStatus&#39;</span>} <span class="k">ne</span> <span class="q">&#39;locked&#39;</span> <span class="s">)</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$transaction_type</span> <span class="k">eq</span> <span class="q">&#39;confirm&#39;</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPin&#39;</span>} <span class="k">eq</span> <span class="i">$hashed_pin</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;ok&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="w">smspinactive</span>}<span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} = <span class="n">3</span><span class="sc">;</span>    <span class="c"># reset or set pin tries to 3</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} &gt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span> = <span class="q">&#39;fail&#39;</span><span class="sc">;</span>
            <span class="i">$message</span>    = <span class="i">$messages</span>{<span class="q">&#39;smspinfail&#39;</span>}<span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>}--<span class="sc">;</span>      <span class="c"># used one pin attempt</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>} &lt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pin_status</span>                    = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinTries&#39;</span>}  = <span class="n">0</span><span class="sc">;</span>
            <span class="i">$message</span>                       = <span class="i">$messages</span>{<span class="q">&#39;smslocked&#39;</span>}<span class="sc">;</span>
            <span class="i">$$fromuserref</span>{<span class="q">&#39;userPinStatus&#39;</span>} = <span class="q">&#39;locked&#39;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="i">$log</span><span class="i">-&gt;debug</span><span class="s">(</span>
<span class="q">&quot;in pin checking for user: $$fromuserref{&#39;userId&#39;} $$fromuserref{&#39;userLogin&#39;}&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># anything getting to here, needs to update the user record</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$dummy</span><span class="cm">,</span> <span class="i">$home_ref</span><span class="cm">,</span> <span class="i">$dummy1</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$dummy2</span> <span class="s">)</span> =
      <span class="i">update_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fromuserref</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$message</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$mail_error</span> = <span class="i">_send_sms_mail_message</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span><span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="i">$pin_status</span><span class="sc">;</span>
<span class="s">}</span>

</pre></dd><dt><strong><a name="item__send_sms_mail_message">_send_sms_mail_message</a></strong></dt>

<dd>
<p>wrapper for notify_by_mail in package Cclite
with notification type 4

</p>
</dd>
</dl>

<pre>
<a name="_send_sms_mail_message-"></a><span class="k">sub </span><span class="m">_send_sms_mail_message</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$registry</span><span class="cm">,</span> <span class="i">$message</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$mail_error</span><span class="cm">,</span> <span class="i">$urlstring</span><span class="cm">,</span> <span class="i">$hash</span><span class="cm">,</span> <span class="i">$smtp</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c">###return ;</span>

    <span class="k">my</span> <span class="i">$mail_error</span> = <span class="i">notify_by_mail</span><span class="s">(</span>
	<span class="i">$class</span><span class="cm">,</span>
	<span class="i">$registry</span><span class="cm">,</span>
        <span class="i">$$fromuserref</span>{<span class="q">&#39;userName&#39;</span>}<span class="cm">,</span>
        <span class="i">$$fromuserref</span>{<span class="q">&#39;userEmail&#39;</span>}<span class="cm">,</span>
        <span class="i">$configuration</span>{<span class="q">&#39;systemmailaddress&#39;</span>}<span class="cm">,</span>
        <span class="i">$configuration</span>{<span class="q">&#39;systemmailreplyaddress&#39;</span>}<span class="cm">,</span>
        <span class="i">$$fromuserref</span>{<span class="q">&#39;userLogin&#39;</span>}<span class="cm">,</span>
        <span class="i">$smtp</span><span class="cm">,</span>
        <span class="i">$urlstring</span><span class="cm">,</span>
        <span class="i">$message</span><span class="cm">,</span>
        <span class="n">4</span><span class="cm">,</span>
        <span class="i">$hash</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="i">$mail_error</span><span class="sc">;</span>

<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
