<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccinterfaces.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccinterfaces.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
			<li><a href="#sms_transaction">sms_transaction</a></li>
			<li><a href="#sms_message_parse">sms_message_parse</a></li>
			<li><a href="#read_mail_transactions">read_mail_transactions</a></li>
			<li><a href="#read_csv_transactions">read_csv_transactions</a></li>
			<li><a href="#prepare_tone_transaction">prepare_tone_transaction</a></li>
			<li><a href="#oscommerce_transaction">oscommerce_transaction</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccinterfaces-">package Ccinterfaces</a>
<ul>
<li><a href="#sms_transaction-">sms_transaction</a></li>
<li><a href="#read_mail_transactions-">read_mail_transactions</a></li>
<li><a href="#read_csv_transactions-">read_csv_transactions</a></li>
<li><a href="#prepare_tone_transaction-">prepare_tone_transaction</a></li>
<li><a href="#oscommerce_transaction-">oscommerce_transaction</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccinterfaces.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for sms, mail etc.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This contains interfaces for mail and SMS to be used by demons
It also contains currently abandoned work for touch-tone
If there's smart card, it'll go here</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced
</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccinterfaces-"></a><span class="k">package </span><span class="i">Ccinterfaces</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="c">###use Encode qw(encode decode);</span>

<span class="i">@EXPORT</span> = <span class="q">qw(sms_transaction</span>
  <span class="q">sms_message_parse</span>
  <span class="q">oscommerce_transaction</span>
  <span class="q">read_mail_transactions</span>
  <span class="q">read_csv_transactions</span>
  <span class="q">prepare_tone_transaction</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash
</p>
<pre>

=cut</pre>
<pre>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="sms_transaction">sms_transaction</a></h3>
<p>This accepts an SMS  transaction and reformats it into
an ordinary one. It therefore has to do a mobile phone to user name
look up, data reformatting etc.</p>
<p>Mobile phone numbers must have the internation prefix 44.... etc.
This is to enable wide-area registries at some stage...</p>
<p>This will use up a credit, so mabye it should be configured.
This will only go registry-a to registry-a, at present
when you say 'at' it's assumed that the to and from registries
at the same</p>
<p>Text messaging transfer is allowed home -&gt; remote
more expressivity in the message and auth via phone number
For example mobile number 1234 text message:
--------------------------------------------------------------
  1234: [send|snd] 4 duckets to ddawg at dalston for
         advertising and computer help
--------------------------------------------------------------</p>
<pre>
<a name="sms_transaction-"></a><span class="k">sub </span><span class="m">sms_transaction</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$mobilenumber</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c"># mobile number + raw string</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># return values for screen, not really used by scripts</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c">### $input = decode( &#39;UCS-2&#39;, lc($input) );  # if sms is stored as unicode</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$found_count</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span> <span class="s">)</span> =
      <span class="i">sms_message_parse</span><span class="s">(</span><span class="i">$input</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="q">&#39;sms incomplete message error&#39;</span><span class="cm">,</span>
        <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span>
      <span class="k">if</span> <span class="s">(</span> <span class="i">$found_count</span> &lt; <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction_description</span> = <span class="i">%$transaction_description_ref</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userMobile&#39;</span><span class="cm">,</span> <span class="i">$mobilenumber</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;toregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;touser&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> = <span class="i">get_where</span><span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>}<span class="cm">,</span>
        <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$transaction_description</span>{<span class="q">&#39;currency&#39;</span>}<span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># one of the above lookups fails, reject the whole transaction</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
        || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
        || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="q">&#39;sms database lookup error&#39;</span><span class="cm">,</span>
            <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;fromregistry&#39;</span>}<span class="sc">;</span>

    <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
    <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>            <span class="c"># no home, not a web transaction</span>
                                             <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;toregistry&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;quantity&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeCurrency : ducket</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#FIXME: should be multilingual tradeTitle : added by this routine</span>
    <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="q">&quot;SMS transaction: see description&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDescription</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$transaction_description</span>{<span class="q">&#39;description&#39;</span>}<span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$$touserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#tradeItem : test to see variables</span>
    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#FIXME: this should be taken from a configuration file</span>
    <span class="i">$transaction</span>{<span class="w">initialPaymentStatus</span>} = <span class="q">&#39;waiting&#39;</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
      <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;sms&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
        <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="sms_message_parse">sms_message_parse</a></h3>
<p>This is now distinct from the transaction preparation etc.
It can be used to do an 'initial' parse on the message during
data validation.</p>
<p>Also, it returns a status, if the parse doesn't contain one
of the necessary elements for a successful transaction. In that
case the transaction -must- fail and it's not worth continuing</p>
<p>This is being replace by Ccsmsgateway now...</p>
<p>sub sms_message_parse {</p>
<pre>
    my ($input) = @_;</pre>
<pre>
    # begin parse on whitespace
    my ( %transaction_description, $status );
    my $found_count = 0;    # used to count elements parsed
    $input = lc($input);    # canonical is lower case
    my @words = split( /\s+/, $input );</pre>
<pre>
    # fuzzy ark parsing the terms mainly go two-by-two!
    # count of found elements should be 5 in a valid transaction</pre>
<pre>
    my $counter = 0;        # used for term lookahead
    my (
        $description, $fromregistry, $toregistry,
        $currency,    $quantity,     $touser
    );
    foreach my $word (@words) {
        if ( $word =~ /^(\d+)$/ ) {
            $transaction_description{'quantity'} =
              $word;        # quantity is the only numeric thing
            $found_count++;
            $transaction_description{'currency'} =
              $words[ ( $counter + 1 ) ];    # currency is next to quantity
            $transaction_description{'currency'} =~
              s/s$//;                        # singulate or deplural...
            $found_count++
              if ( length( $transaction_description{'currency'} ) );</pre>
<pre>
        }
        if ( $word eq &quot;to&quot; ) {               # found 'to'
            $transaction_description{'touser'} =
              $words[ ( $counter + 1 ) ];    # touser is next
            $found_count++ if ( length( $transaction_description{'touser'} ) );</pre>
<pre>
        }
        if ( $word eq &quot;at&quot; ) {               # found 'at'
            $transaction_description{'fromregistry'} =
              $transaction_description{'toregistry'} =
              $words[ ( $counter + 1 ) ];    # toregistry is next
            $found_count++
              if ( length( $transaction_description{'fromregistry'} ) );</pre>
<pre>
        }
        $counter++;
    }</pre>
<pre>
    $input =~ /for\s+(\w.*)$/i;              # description is everything at end
         # look up sending user, receiving user and currency
    $transaction_description{'description'} = $1;
    $found_count++ if ( length( $transaction_description{'description'} ) );</pre>
<pre>
    return ( $found_count, \%transaction_description );</pre>
<p>}</p>
<p>
</p>
<h3><a name="read_mail_transactions">read_mail_transactions</a></h3>
<p>This accepts a /var/spool/mail/xxx and reformats it into
a set of transactions. It therefore has to do a email address to user name
look up, data reformatting etc.</p>
<p>This will only go registry-a to registry-a, at present
when you say 'at' it's assumed that the to and from registries
are the same
</p>
<pre>

example mail text
--------------------------------------------------------------
        [send|snd] 4 duckets to ddawg at dalston for
         advertising and computer help
--------------------------------------------------------------</pre>
<p>This will move to GPG encoded mail at -some- stage, real soon now...</p>
<pre>
<a name="read_mail_transactions-"></a><span class="k">sub </span><span class="m">read_mail_transactions</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$mail_file</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$messages</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c"># parse the mail file into messages</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">%subject</span><span class="cm">,</span> <span class="i">%from</span><span class="cm">,</span> <span class="i">%message</span><span class="cm">,</span> <span class="i">$fromregistry</span><span class="cm">,</span> <span class="i">$toregistry</span><span class="cm">,</span> <span class="i">$counter</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">### From: &quot;Hugh Barnard&quot; &lt;hugh.barnard@hughbarnard.org&gt;</span>

    <span class="c"># mail file format is &lt;toregistry&gt;.cclite, registry is parsed out</span>
    <span class="i">$mail_file</span> =~ <span class="q">/\057([^\057]+)\056cclite$/</span><span class="sc">;</span>
    <span class="i">$fromregistry</span> = <span class="i">$toregistry</span> = <span class="i">$1</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="w">MAIL</span><span class="cm">,</span> <span class="i">$mail_file</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$/</span> = <span class="q">&#39;&#39;</span><span class="sc">;</span>    <span class="c"># read paragraphs</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;MAIL&gt;</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span><span class="q">/^From/</span><span class="s">)</span> <span class="s">{</span>
            <span class="q">/^Subject:\s*(?:Re:\s*)*(.*)/mi</span><span class="sc">;</span>
            <span class="i">$counter</span>++<span class="sc">;</span>
            <span class="i">$subject</span>{<span class="i">$counter</span>} = <span class="i">$1</span><span class="sc">;</span>
            <span class="q">/From\:.*\&lt;(.*)\&gt;/m</span><span class="sc">;</span>
            <span class="i">$from</span>{<span class="i">$counter</span>} = <span class="i">$1</span><span class="sc">;</span>
        <span class="s">}</span>       <span class="c"># endif</span>
        <span class="i">$message</span>{<span class="i">$counter</span>} .= <span class="i">$_</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># endwhile</span>
    <span class="k">close</span><span class="s">(</span><span class="w">MAIL</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%subject</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$input</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$message</span>{<span class="i">$key</span>} <span class="s">)</span><span class="sc">;</span>      <span class="c"># canonical is lower case</span>
        <span class="k">my</span> <span class="i">@words</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\s+/m</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># fuzzy ark parsing the terms mainly go two-by-two!</span>

        <span class="k">my</span> <span class="i">$counter</span> = <span class="n">0</span><span class="sc">;</span>                       <span class="c"># used for term lookahead</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$description</span><span class="cm">,</span> <span class="i">$currency</span><span class="cm">,</span> <span class="i">$quantity</span><span class="cm">,</span> <span class="i">$touser</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$word</span> <span class="s">(</span><span class="i">@words</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> =~ <span class="q">/^(\d+)$/</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$quantity</span> = <span class="i">$word</span><span class="sc">;</span>    <span class="c"># quantity is the only numeric thing</span>
                <span class="i">$currency</span> =
                  <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>    <span class="c"># currency is next to quantity</span>
                <span class="i">$currency</span> =~ <span class="q">s/s$//</span><span class="sc">;</span>             <span class="c"># singulate or deplural...</span>
            <span class="s">}</span>

            <span class="c"># deals with yahoo footer etc. stupid format though</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$word</span> <span class="k">eq</span> <span class="q">&quot;to&quot;</span> &amp;&amp; !<span class="k">length</span><span class="s">(</span><span class="i">$touser</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># found &#39;to&#39;</span>
                <span class="i">$touser</span> = <span class="i">$words</span>[ <span class="s">(</span> <span class="i">$counter</span> + <span class="n">1</span> <span class="s">)</span> ]<span class="sc">;</span>     <span class="c"># touser is next</span>
            <span class="s">}</span>
            <span class="i">$counter</span>++<span class="sc">;</span>
        <span class="s">}</span>
        <span class="s">(</span><span class="i">$description</span><span class="s">)</span> =
          <span class="i">$input</span> =~ <span class="q">/for\s+(\w.*)$/mi</span><span class="sc">;</span>    <span class="c"># description is everything at end</span>
             <span class="c"># look up sending user, receiving user and currency</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fromregistry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span>
            <span class="i">$from</span>{<span class="i">$key</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$toregistry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$touser</span><span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fromregistry</span><span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$currency</span><span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># one of the above lookups fails, reject the whole transaction</span>
        <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
            || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
            || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="c">###send_mail_message($from{$key},&quot;transaction invalid: $input&quot;) ;</span>
        <span class="s">}</span>

        <span class="c"># convert to standard transaction input format, fields etc.</span>
        <span class="c">#fromregistry : chelsea</span>
        <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$fromregistry</span><span class="sc">;</span>

        <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
        <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>           <span class="c"># no home, not a web transaction</span>
                                                <span class="c">#subaction : om_trades</span>
        <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$toregistry</span><span class="sc">;</span>

        <span class="c">#tradeAmount : 23</span>
        <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$quantity</span><span class="sc">;</span>

        <span class="c">#tradeCurrency : ducket</span>
        <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

        <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

        <span class="c">#tradeTitle : added by this routine</span>
        <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="q">&quot;Mail transaction: see description&quot;</span><span class="sc">;</span>

        <span class="c">#tradeDescription</span>
        <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$description</span><span class="sc">;</span>

        <span class="c">#tradeDestination : ddawg</span>
        <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$$touserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

        <span class="c">#tradeItem : test to see variables</span>
        <span class="c">#tradeSource : manager</span>
        <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

        <span class="c"># call ordinary transaction</span>
        <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
          <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;mail&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
            <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>                     <span class="c"># end of each on letters</span>
    <span class="k">unlink</span> <span class="i">$mail_file</span><span class="sc">;</span>    <span class="c"># delete mail file when read</span>

    <span class="c"># need to decide how this returns, processes multiple transactions</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$messages</span><span class="cm">,</span> <span class="q">&#39;result.html&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>






</pre><p></p>
<h3><a name="read_csv_transactions">read_csv_transactions</a></h3>
<p>This accepts a /var/cclite/xxx.csv and reformats it into
a set of transactions.</p>
<p>Prints a new file showing accepted transactions and rejected ones</p>
<p>example text
   0 date     1 from 2 to	3 fromreg 4 toreg  5 currency 6 type 7 taxflag  8 amount   9 description
``10-04-2005'',``ddawg'',``manager'',``dalston'',``dalston'',``ducket'',``credit'',``N'',345,``test1''
This will move to GPG encoded at -some- stage</p>
<p>Note that $db is empty, the registries are declared in the transactions
themselves. It has remained to keep the function signatures consistent.</p>
<p>Skip # lines which are expected to be comments. Only allow debits, currently.</p>
<pre>
<a name="read_csv_transactions-"></a><span class="k">sub </span><span class="m">read_csv_transactions</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$csv_file</span><span class="cm">,</span> <span class="i">$configuration_ref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>
        <span class="i">$limit</span> <span class="s">)</span>
      = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$messages</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">@errors</span><span class="sc">;</span>    <span class="c"># contains cumulated validation problems</span>
    <span class="k">my</span> <span class="i">$ok</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">CSV</span><span class="cm">,</span> <span class="i">$csv_file</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># timestamp output files so that they don&#39;t get confused</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$numeric_date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># results written per registry now...</span>
    <span class="k">my</span> <span class="i">$results_out</span> =
<span class="q">&quot;$$configuration_ref{htmlpath}/$db/out/$csv_file\056out\056$numeric_date$time&quot;</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="w">OUT</span><span class="cm">,</span> <span class="q">&quot;&gt;$results_out&quot;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span><span class="q">&lt;CSV&gt;</span><span class="s">)</span> <span class="s">{</span>

        <span class="q">s/&quot;//g</span><span class="sc">;</span>    <span class="c"># remove quotes</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span><span class="q">/^#|^\s/</span><span class="s">)</span><span class="sc">;</span>    <span class="c"># skip comment lines and space lines</span>
        <span class="k">chop</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">@transaction_array</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\,/</span><span class="cm">,</span> <span class="i">$_</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$ok</span> = <span class="n">1</span><span class="sc">;</span>    <span class="c"># turned off for non-ok transaction</span>
                       <span class="c"># look up sending user, receiving user and currency</span>
                       <span class="c"># fail on from user not within this registry, policy</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_array</span>[<span class="n">3</span>]<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_array</span>[<span class="n">1</span>]<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># don&#39;t fail on destination registry, could be remote...</span>
<span class="c">#my ($error,$touserref)   = get_where($class,$transaction_array[4],&#39;om_users&#39;,&#39;userLogin&#39;,$transaction_array[2],$token,$offset,$limit) ;</span>
<span class="c"># fail on currency not within this registry, cannot succeed</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_array</span>[<span class="n">3</span>]<span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_array</span>[<span class="n">5</span>]<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># one of the above lookups fails, reject the whole transaction</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">invalidsending</span>}<span class="sc">;</span>
            <span class="i">$ok</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># removed, user can be a remote user</span>
        <span class="c">###if (! length($touserref) ) {</span>
        <span class="c">###  push @errors, $messages{invalidreceiving} ;</span>
        <span class="c">###  $ok  = 0;</span>
        <span class="c">###}</span>

        <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">invalidcurrency</span>}<span class="sc">;</span>
            <span class="i">$ok</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># only debit transactions allowed at present</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$transaction_array</span>[<span class="n">6</span>] <span class="k">ne</span> <span class="q">&quot;debit&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">notadebit</span>}<span class="sc">;</span>
            <span class="i">$ok</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># convert to standard transaction input format, fields etc.</span>
        <span class="c">#fromregistry : chelsea</span>
        <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$transaction_array</span>[<span class="n">3</span>]<span class="sc">;</span>

        <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
        <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>           <span class="c"># no home, not a web transaction</span>
                                                <span class="c">#subaction : om_trades</span>
        <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

        <span class="c">#toregistry : dalston</span>
        <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$transaction_array</span>[<span class="n">4</span>]<span class="sc">;</span>

        <span class="c">#tradeAmount : 23</span>
        <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$transaction_array</span>[<span class="n">8</span>]<span class="sc">;</span>

        <span class="c">#tradeCurrency : ducket</span>
        <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$transaction_array</span>[<span class="n">5</span>]<span class="sc">;</span>

        <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># read from configuration file in cron job</span>
        <span class="i">$transaction</span>{<span class="w">initialPaymentStatus</span>} =
          <span class="i">$$configuration_ref</span>{<span class="w">initialpaymentstatus</span>}<span class="sc">;</span>

        <span class="c"># reformat date if necessary ;</span>
        <span class="i">$transaction_array</span>[<span class="n">0</span>] =~ <span class="q">m/(\d\d)\D(\d\d)\D(\d\d\d\d)/</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$tdate</span> = <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$3</span><span class="s">)</span> == <span class="n">0</span> <span class="s">)</span> ? <span class="i">$transaction_array</span>[<span class="n">0</span>] <span class="co">:</span> <span class="q">&quot;$3-$2-$1&quot;</span><span class="sc">;</span>

        <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$tdate</span><span class="sc">;</span>

        <span class="c">#tradeTitle : added by this routine</span>
        <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} = <span class="i">$messages</span>{<span class="w">batchtransaction</span>}<span class="sc">;</span>

        <span class="c">#tradeDescription</span>
        <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="i">$transaction_array</span>[<span class="n">9</span>]<span class="sc">;</span>

        <span class="c">#tradeDestination : ddawg</span>
        <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$transaction_array</span>[<span class="n">2</span>]<span class="sc">;</span>

        <span class="c">#tradeItem : test to see variables</span>
        <span class="c">#tradeSource : manager</span>
        <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$transaction_array</span>[<span class="n">1</span>]<span class="sc">;</span>

        <span class="c"># this is new 01/2006 and needs adding everywhere</span>
        <span class="i">$transaction</span>{<span class="w">tradeTaxflag</span>} = <span class="i">$transaction_array</span>[<span class="n">7</span>]<span class="sc">;</span>

        <span class="c"># call ordinary transaction</span>
        <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
            <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
              <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;batch&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
                <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="c"># add a message to the output transaction and print in output file</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span><span class="i">$error</span><span class="s">)</span> || !<span class="i">$ok</span> &amp;&amp; <span class="k">length</span><span class="s">(</span><span class="i">$_</span><span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">push</span> <span class="i">@errors</span><span class="cm">,</span> <span class="i">$error</span><span class="sc">;</span>
            <span class="k">my</span> <span class="i">$error_messages</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;,&quot;</span><span class="cm">,</span> <span class="i">@errors</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$_</span> .= <span class="q">&quot;,$error_messages\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$_</span> .= <span class="q">&quot;,$messages{accepted}\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">undef</span> <span class="i">$error</span><span class="sc">;</span>
        <span class="i">@errors</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">OUT</span> <span class="i">$_</span><span class="sc">;</span>
    <span class="s">}</span>    <span class="c"># end of while on csv files</span>

    <span class="c"># need to decide how this returns, processes multiple transactions</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$messages</span><span class="cm">,</span> <span class="q">&#39;result.html&#39;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="prepare_tone_transaction">prepare_tone_transaction</a></h3>
<p>This accepts a touch-tone transaction and reformats it into
an ordinary one. It therefore has to do a id (was mobile phone but
that changes!) to user name
look up, data reformatting etc.</p>
<p>This will use up a credit, so mabye it should be configured.</p>
<p>The transaction comes in as one long string with a separator</p>
<p>For example 7-1-23-4-77-1234
------------------------------
which is transfer: at registry 7 - from user id 1 - to user id 23 - currency 4 - 77 units- pin number 1234
tone type transfer is only allowed
on 'home' registry to 'home' registry at present</p>
<p>Development on hold at present 08/2005, will use asterisk, SMS and email first</p>
<pre>
<a name="prepare_tone_transaction-"></a><span class="k">sub </span><span class="m">prepare_tone_transaction</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span><span class="i">$input</span><span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c"># raw string</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$class</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%dblookup</span> = <span class="q">qw(1 dalston)</span><span class="sc">;</span>    <span class="c"># kludged, needs to be changed at setup</span>
    <span class="k">my</span> <span class="i">%transaction</span><span class="sc">;</span>

    <span class="c"># allow parse on most common separators</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryid</span><span class="cm">,</span> <span class="i">$fromuserid</span><span class="cm">,</span> <span class="i">$touserid</span><span class="cm">,</span> <span class="i">$currencyid</span><span class="cm">,</span> <span class="i">$quantity</span><span class="cm">,</span> <span class="i">$pin</span> <span class="s">)</span> =
      <span class="k">split</span><span class="s">(</span> <span class="q">/[\072\073\054\057\056]+/</span><span class="cm">,</span> <span class="i">$input</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># look up sending user, receiving user and currency</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$dblookup</span>{<span class="i">$registryid</span>}<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userId&#39;</span><span class="cm">,</span>
        <span class="i">$fromuserid</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$dblookup</span>{<span class="i">$registryid</span>}<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userId&#39;</span><span class="cm">,</span>
        <span class="i">$touserid</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$dblookup</span>{<span class="i">$registryid</span>}<span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span>
        <span class="i">$currencyid</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># convert to standard transaction input format, fields etc.</span>
    <span class="c">#fromregistry : chelsea</span>
    <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$dblookup</span>{<span class="i">$registryid</span>}<span class="sc">;</span>

    <span class="c">#home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi</span>
    <span class="i">$transaction</span>{<span class="w">home</span>}      = <span class="q">&quot;&quot;</span><span class="sc">;</span>            <span class="c"># no home, not a web transaction</span>
                                             <span class="c">#subaction : om_trades</span>
    <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

    <span class="c">#toregistry : dalston</span>
    <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$dblookup</span>{<span class="i">$registryid</span>}<span class="sc">;</span>

    <span class="c">#tradeAmount : 23</span>
    <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$quantity</span><span class="sc">;</span>

    <span class="c">#tradeCurrency : ducket</span>
    <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

    <span class="c">#tradeDate : this is date of reception and processing, in fact</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$transaction</span>{<span class="w">tradeDate</span>} = <span class="i">$date</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="c">#tradeDescription : test</span>
    <span class="i">$transaction</span>{<span class="w">tradeDescription</span>} = <span class="q">&quot;sms or touchtone transfer&quot;</span><span class="sc">;</span>

    <span class="c">#tradeDestination : ddawg</span>
    <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$$touserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c">#tradeItem : test to see variables</span>
    <span class="c">#tradeSource : manager</span>
    <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

    <span class="c"># make a reference to the transaction hash and</span>
    <span class="c"># call ordinary transaction</span>
    <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="oscommerce_transaction">oscommerce_transaction</a></h3>
<p>transaction from oscommerce, authorised with merchantkey
this is a work in progress at present.</p>
<p>Several transactions are generated depending on the (Cclite) user
in the OsCommerce manufacturer fields. This is the 'link' between the two systems

</p>
<p>Currently there's still work to be
done to generate a merchant key: hotbits + hashing probably for the moment.

</p>

<pre>
<a name="oscommerce_transaction-"></a><span class="k">sub </span><span class="m">oscommerce_transaction</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$ok</span><span class="cm">,</span> <span class="i">%transaction</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%fields</span> = <span class="i">%$fieldsref</span><span class="sc">;</span>    <span class="c"># for code simplicity, really</span>

<span class="c"># test whether the merchant key from the interface = that stored in the registry</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$merror</span><span class="cm">,</span> <span class="i">$registryref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;om_registry&#39;</span><span class="cm">,</span> <span class="q">&#39;merchant_key&#39;</span><span class="cm">,</span>
        <span class="i">$fields</span>{<span class="w">merchant_key</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># deduce paying &#39;shopper&#39; from email address sent from osCommerce</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$uerror</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span>
        <span class="i">$fields</span>{<span class="w">email</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># (new 2007) get list of allowed IP addresses for oscommerce and</span>
    <span class="c"># for straight through RESTful transactions. no list = anything goes!</span>

    <span class="k">my</span> <span class="i">@allowed_ips</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/\s+/</span><span class="cm">,</span> <span class="i">$$registryref</span>{<span class="w">allowed_ip_list</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># loop through allowed ips</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">scalar</span><span class="s">(</span><span class="i">@allowed_ips</span><span class="s">)</span> &gt;= <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$found</span> = <span class="n">0</span><span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$ip</span> <span class="s">(</span><span class="i">@allowed_ips</span><span class="s">)</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$ip</span> <span class="k">eq</span> <span class="i">$$fieldsref</span>{<span class="w">client_ip</span>} <span class="s">)</span> <span class="s">{</span>
                <span class="i">$found</span> = <span class="n">1</span><span class="sc">;</span>
                <span class="k">last</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
        <span class="k">print</span> <span class="q">&quot;Location: $fields{cancel_url}&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="i">$found</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># deduce currency from currency symbol sent from osCommerce : only one allowed at present</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$cerror</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
      <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;code&#39;</span><span class="cm">,</span>
        <span class="i">$fields</span>{<span class="w">currency_code</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="q">&quot;cclite $fields{version} gateway &quot;</span><span class="sc">;</span>

    <span class="c"># invalid &#39;from&#39; user or invalid currency, returns straight away</span>
    <span class="k">if</span> <span class="s">(</span>   !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span>
        || !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span>
        || !<span class="k">length</span><span class="s">(</span><span class="i">$registryref</span><span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$message</span> .= <span class="q">&quot;$messages{merchantkeyerror}:&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$registryref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;$messages{notregisterederror}-&gt;$fields{email}:&quot;</span>
          <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$message</span> .= <span class="q">&quot;$messages{currencysymbolerror}-&gt;$fields{currency_code}:&quot;</span>
          <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">print</span>
<span class="q">&quot;Location: $fields{cancel_url}?$fields{osCsid}&amp;payment_error=1&amp;error_message=$message\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="c"># now construct and do a transaction for each &#39;manufacturer&#39; who is, in fact a Cclite &#39;userLogin&#39;</span>
<span class="c"># from om_users, each to payment is of form &quot;to:userLogin&quot;</span>
<span class="c"># this is two-pass, it needs to make sure that ALL the users (manufacturers) are</span>
<span class="c"># present otherwise it won&#39;t process ANY of the order. This is cleaner than</span>
<span class="c"># partially processing the order.</span>
<span class="c">#</span>
    <span class="i">$ok</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/^to:(\w+)/</span> &amp;&amp; <span class="i">$fields</span>{<span class="w">onlinestatus</span>} <span class="k">eq</span> <span class="q">&quot;live&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$touser</span> = <span class="i">$1</span><span class="sc">;</span>    <span class="c"># payment destination</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$terror</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> =
              <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">registry</span>}<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span>
                <span class="i">$touser</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$ok</span> = <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$message</span> .= <span class="q">&quot;$messages{manufacturererror}-&gt;$touser&quot;</span>
              <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># don&#39;t go on if even one &#39;manufacturer&#39; is not found</span>
    <span class="k">print</span>
<span class="q">&quot;Location: $fields{cancel_url}?$fields{osCsid}&amp;payment_error=1&amp;error_message=$message\n\n&quot;</span>
      <span class="k">if</span> <span class="s">(</span> !<span class="i">$ok</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%fields</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$html</span> .= <span class="q">&quot;$key:$fields{$key}&lt;br/&gt;&quot;</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$key</span> =~ <span class="q">/^to:(\w+)/</span> &amp;&amp; <span class="i">$fields</span>{<span class="w">onlinestatus</span>} <span class="k">eq</span> <span class="q">&quot;live&quot;</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$touser</span> = <span class="i">$1</span><span class="sc">;</span>    <span class="c"># payment destination</span>
                 <span class="c"># convert to standard transaction input format, fields etc.</span>
                 <span class="c">#fromregistry : chelsea</span>
            <span class="i">$transaction</span>{<span class="w">fromregistry</span>} = <span class="i">$fields</span>{<span class="w">registry</span>}<span class="sc">;</span>
            <span class="i">$transaction</span>{<span class="w">home</span>} = <span class="q">&quot;&quot;</span><span class="sc">;</span>    <span class="c"># no home, not a web transaction</span>
                                        <span class="c">#subaction : om_trades</span>
            <span class="i">$transaction</span>{<span class="w">subaction</span>} = <span class="q">&#39;om_trades&#39;</span><span class="sc">;</span>

            <span class="c">#toregistry : chelsea, single registry only, currently</span>
            <span class="i">$transaction</span>{<span class="w">toregistry</span>} = <span class="i">$fields</span>{<span class="w">registry</span>}<span class="sc">;</span>

           <span class="c">#tradeAmount : 23 : this value is in the to:userLogin key is quantity</span>
            <span class="i">$transaction</span>{<span class="w">tradeAmount</span>} = <span class="i">$fields</span>{<span class="i">$key</span>}<span class="sc">;</span>

            <span class="c">#tradeCurrency : ducket</span>
            <span class="i">$transaction</span>{<span class="w">tradeCurrency</span>} = <span class="i">$$currencyref</span>{<span class="w">name</span>}<span class="sc">;</span>

            <span class="c">#tradeDate : 20050423</span>
            <span class="c"># added by transaction routine at point of processing</span>
            <span class="c"># configured intial status in cclite.cf</span>
            <span class="i">$transaction</span>{<span class="w">tradeStatus</span>} = <span class="i">$fields</span>{<span class="w">initialPaymentStatus</span>}<span class="sc">;</span>

            <span class="c">#tradeDescription : test</span>
            <span class="i">$transaction</span>{<span class="w">tradeTitle</span>} =
              <span class="q">&quot;store payment from osc: $fields{item_id}&quot;</span><span class="sc">;</span>

            <span class="c">#tradeDestination : ddawg</span>
            <span class="i">$transaction</span>{<span class="w">tradeDestination</span>} = <span class="i">$touser</span><span class="sc">;</span>

            <span class="c">#tradeItem : test to see variables</span>
            <span class="c">#tradeSource : manager</span>
            <span class="i">$transaction</span>{<span class="w">tradeSource</span>} = <span class="i">$$fromuserref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>

            <span class="c"># trade tax flag</span>
            <span class="i">$transaction</span>{<span class="w">tradeTaxflag</span>} = <span class="i">$fields</span>{<span class="w">taxflag</span>}<span class="sc">;</span>

            <span class="c"># make a reference to the transaction hash and</span>
            <span class="c"># call ordinary transaction</span>
            <span class="k">my</span> <span class="i">$transaction_ref</span> = \<span class="i">%transaction</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span><span class="i">$ok</span><span class="s">)</span> <span class="s">{</span>
                <span class="k">my</span> <span class="s">(</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$home</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$output_message</span><span class="cm">,</span> <span class="i">$page</span><span class="cm">,</span> <span class="i">$c</span> <span class="s">)</span> =
                  <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;osc&#39;</span><span class="cm">,</span> <span class="i">$transaction</span>{<span class="w">fromregistry</span>}<span class="cm">,</span>
                    <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$transaction_ref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>    <span class="c"># endif</span>
        <span class="s">}</span>    <span class="c"># endif: search for manufacturers</span>
    <span class="s">}</span>    <span class="c"># end foreach</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$fields</span>{<span class="w">onlinestatus</span>} <span class="k">eq</span> <span class="q">&quot;live&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;Location: $fields{return_url}?$fields{osCsid}\n\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;0&quot;</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
