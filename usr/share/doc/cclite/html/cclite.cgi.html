<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>cclite.cgi</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>cclite.cgi</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#readconfiguration">readconfiguration</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->

<hr />
<pre>#!/usr/bin/perl
<span class="k">my</span> <span class="i">$test</span> = <span class="n">0</span><span class="sc">;</span>
<span class="k">if</span> <span class="s">(</span><span class="i">$test</span><span class="s">)</span> <span class="s">{</span>
    <span class="k">print</span> <span class="i">STDOUT</span> <span class="q">&quot;Content-type: text/html\n\n&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$data</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&lt;DATA&gt;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">eval</span> <span class="i">$data</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span><span class="i">$@</span><span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="q">&quot;&lt;H1&gt;Syntax  error!&lt;/H1&gt;\n&lt;PRE&gt;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">print</span> <span class="q">&quot;&lt;/PRE&gt;\n&quot;</span><span class="sc">;</span>
        <span class="k">exit</span><span class="sc">;</span>
    <span class="s">}</span>
<span class="s">}</span>
<span class="c">###__END__</span>

</pre><p></p>
<hr />
<h1><a name="name">NAME</a></h1>
<pre>

cclite.cgi</pre>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Controller for user side Cclite</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>Controller to find and dispatch various actions
 this is the version 2 controller for cclite:</p>
<pre>
 - multiple registry, registry passed in %fields
 - multiple transaction, logon and transfer can be one operation
 - maximum simplicity,  
 - sha1, ip + user + value based hashing
 - internal key never transmitted over network
 - mysql based database + DBI + ODBC (can even be access, for example)
 - web services retained
 - multilingual elements provided by translating screens + cookie
 - maximum use of static html for lightweight running
 - Taint flag should be on in final version, anyway</pre>
<p>---------------------------------------------------------------------------
 THE cclite SOFTWARE IS PROVIDED TO YOU ``AS IS,'' AND WE MAKE NO EXPRESS
 OR IMPLIED WARRANTIES WHATSOEVER WITH RESPECT TO ITS FUNCTIONALITY,
 OPERABILITY, OR USE, INCLUDING, WITHOUT LIMITATION,
 ANY IMPLIED WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE, OR INFRINGEMENT.
 WE EXPRESSLY DISCLAIM ANY LIABILITY WHATSOEVER FOR ANY DIRECT,
 INDIRECT, CONSEQUENTIAL, INCIDENTAL OR SPECIAL DAMAGES,
 INCLUDING, WITHOUT LIMITATION, LOST REVENUES, LOST PROFITS,
 LOSSES RESULTING FROM BUSINESS INTERRUPTION OR LOSS OF DATA,
 REGARDLESS OF THE FORM OF ACTION OR LEGAL THEORY UNDER
 WHICH THE LIABILITY MAY BE ASSERTED,
 EVEN IF ADVISED OF THE POSSIBILITY OR LIKELIHOOD OF SUCH DAMAGES.
---------------------------------------------------------------------------</p>
<p>You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 GPL Licenced</p>
<p>
</p>
<h3><a name="readconfiguration">readconfiguration</a></h3>
<p>Read the configuration data and return a hash, this routine
also exists in ccserver.cgi</p>
<p>Skip comments marked with #
cgi parameters will override configuration file
information, always!</p>
<p>Included here, needs to be executed within BEGIN</p>
<p>Revised 1/2009 for Windows...</p>
<p>sub readconfiguration {</p>
<pre>
    my $os = $^O;
    my $dir;
    my $default_config;</pre>
<pre>
    # if it's windows use cd to find the directory
    if ( $os =~ /^ms/i ) {
        $dir = `cd`;
    } else {
        $dir = `pwd`;
    }</pre>
<pre>
    # make an informed guess at the config file not explictly supplied
    $dir =~ s/\bcgi-bin.*//;
    $default_config = &quot;$dir/config/cclite.cf&quot;;
    $default_config =~ s/\s//g;</pre>
<pre>
    # either supply it explicitly with full path or it will guess..
    my $configfile = $_[0] || $default_config;</pre>
<pre>
    my %configuration;
    if ( -e $configfile ) {
        open( CONFIG, $configfile );
        while (&lt;CONFIG&gt;) {
            s/\s$//g;
            next if /^#/;
            my ( $key, $value ) = split( /\=/, $_ );
            if ($value) {
                $key =~ lc($key);    #- make key canonic, all lower
                $configuration{$key} = $value if ( length($value) );
            }
            $key   = &quot;&quot;;
            $value = &quot;&quot;;
        }
        domain;
    } else {
        print &lt;&lt;EOT;
Content-type: text/html</pre>
<p>&lt;head&gt;
&lt;title&gt;No configuration file&lt;/title&gt;
&lt;link type=``text/css'' href=``/styles/cc.css'' rel=``stylesheet''&gt;
&lt;/head&gt;
&lt;br/&gt;&lt;br/&gt;
&lt;pre&gt; 
   Cannot find configuration file file:
    &lt;div class=``failedcheck''&gt; $configfile &lt;/div&gt; 
    may be missing? Please use &lt;a href=``/cgi-bin/protected/ccinstall.cgi''&gt;the installer&lt;/a&gt; to create it.
&lt;/pre&gt;
EOT</p>
<pre>
        exit 0;</pre>
<pre>
    }
    return %configuration;
}</pre>
<pre>
<span class="k">BEGIN</span> <span class="s">{</span>
    <span class="k">use</span> <span class="w">CGI::Carp</span> <span class="q">qw(fatalsToBrowser set_message)</span><span class="sc">;</span>
    <span class="i">set_message</span><span class="s">(</span>
<span class="q">&quot;Please use the &lt;a title=\&quot;cclite google group\&quot; href=\&quot;http://groups.google.co.uk/group/cclite\&quot;&gt;Cclite Google Group&lt;/a&gt; for help, if necessary&quot;</span>
    <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="k">use</span> <span class="w">lib</span> <span class="q">&#39;../lib&#39;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>    <span class="c"># all this code is strict</span>
<span class="k">use</span> <span class="w">locale</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">HTML::SimpleTemplate</span><span class="sc">;</span>    <span class="c"># templating for HTML</span>

<span class="k">use</span> <span class="w">Log::Log4perl</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>                     <span class="c"># utilities + config + multilingual messages</span>
<span class="k">use</span> <span class="w">Cccookie</span><span class="sc">;</span>                <span class="c"># use the cookie module</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>              <span class="c"># use the validation and javascript routines</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>                  <span class="c"># use the main motor</span>
<span class="k">use</span> <span class="w">Cchooks</span><span class="sc">;</span>                 <span class="c"># API hooks, pretty empty at present</span>
<span class="k">use</span> <span class="w">Ccdirectory</span><span class="sc">;</span>             <span class="c"># yellow pages directory etc.</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>                <span class="c"># security and hashing</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>                <span class="c"># this probably should be delegated</span>
<span class="k">use</span> <span class="w">Ccinterfaces</span><span class="sc">;</span>            <span class="c"># need this for oscommerce gateway</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>         <span class="c"># new way of doing configuration</span>

<span class="i">$ENV</span>{<span class="w">IFS</span>} = <span class="q">&quot; &quot;</span><span class="sc">;</span>             <span class="c"># modest security</span>

<span class="k">my</span> <span class="s">(</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$cookies</span><span class="cm">,</span>
    <span class="i">$templatename</span><span class="cm">,</span> <span class="i">$registry_private_value</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># for the moment</span>
<span class="k">my</span> <span class="i">%configuration</span> = <span class="i">readconfiguration</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="w">Log::Log4perl</span><span class="w">-&gt;init</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="q">&#39;loggerconfig&#39;</span>} <span class="s">)</span><span class="sc">;</span>
<span class="k">our</span> <span class="i">$log</span> = <span class="w">Log::Log4perl</span><span class="w">-&gt;get_logger</span><span class="s">(</span><span class="q">&quot;cclite&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$cookieref</span> = <span class="i">get_cookie</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">%fields</span>    = <span class="i">cgiparse</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

<span class="c"># no soap and associated modules required,</span>
<span class="c"># if you declare multiregistry=no in cclite.cf</span>
<span class="k">if</span> <span class="s">(</span> <span class="i">$configuration</span>{<span class="w">multiregistry</span>} <span class="k">eq</span> <span class="q">&quot;yes&quot;</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">require</span> <span class="w">SOAP::Lite</span><span class="sc">;</span>    <span class="c"># uses this for remote lookups etc.</span>
    <span class="w">import</span> <span class="w">SOAP::Lite</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#  this should use the version modules, but that makes life more</span>
<span class="c"># complex for intermediate users</span>

<span class="i">$fields</span>{<span class="w">version</span>} = <span class="q">&quot;0.6.0&quot;</span><span class="sc">;</span>

<span class="c">#  this is part of conversion to transaction engine use. web mode, which</span>
<span class="c">#  is the default will deliver html etc. engine mode will deliver data</span>
<span class="c">#  as hash references, for example. There are quite a few things called &#39;mode&#39;</span>
<span class="c">#  in Cclite.pm, needs sorting out. csv currently &#39;means&#39; Elgg and Drupal passthrough</span>

<span class="i">$fields</span>{<span class="w">mode</span>} ||= <span class="q">&#39;html&#39;</span><span class="sc">;</span>

<span class="c">#  this is the remote address from the client. It acts as a simple check in a direct</span>
<span class="c">#  pay transaction from the REST interface. This is obviously not sufficient and</span>
<span class="c">#  will get upgraded in the future</span>

<span class="i">$fields</span>{<span class="w">client_ip</span>} = <span class="i">$ENV</span>{<span class="w">REMOTE_ADDR</span>}<span class="sc">;</span>

<span class="c"># moved from template because other routines need it</span>
<span class="k">if</span> <span class="s">(</span>   <span class="i">$fields</span>{<span class="w">action</span>} <span class="k">ne</span> <span class="q">&quot;logoff&quot;</span>
    &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">userLogin</span>} <span class="s">)</span>
    &amp;&amp; <span class="i">$$cookieref</span>{<span class="w">userLevel</span>} <span class="k">ne</span> <span class="q">&quot;admin&quot;</span> <span class="s">)</span>
<span class="s">{</span>

    <span class="i">$fields</span>{<span class="w">userLogin</span>} = <span class="i">$$cookieref</span>{<span class="w">userLogin</span>}<span class="sc">;</span>
<span class="s">}</span>

<span class="c">#</span>
<span class="c">#---------------------------------------------------------------------------</span>
<span class="c"># change the language default here</span>
<span class="c">#</span>
<span class="k">my</span> <span class="i">$language</span> = <span class="i">$$cookieref</span>{<span class="w">language</span>}
  || <span class="i">$fields</span>{<span class="w">language</span>}
  || <span class="i">$configuration</span>{<span class="w">language</span>}<span class="sc">;</span>    <span class="c"># default is english in logon</span>

<span class="c">#---------------------------------------------------------------------------</span>

<span class="k">my</span> <span class="i">$pagename</span> = <span class="i">$fields</span>{<span class="w">name</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$action</span>   = <span class="i">$fields</span>{<span class="w">action</span>} || <span class="i">$configuration</span>{<span class="w">defaultaction</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$table</span>    = <span class="i">$fields</span>{<span class="w">subaction</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$db</span>       = <span class="i">$fields</span>{<span class="w">registry</span>} || <span class="i">$$cookieref</span>{<span class="w">registry</span>}<span class="sc">;</span>
<span class="k">my</span> <span class="i">$offset</span>   = <span class="i">$fields</span>{<span class="w">offset</span>}<span class="sc">;</span>

<span class="c"># now take these from configuration because of unreliable $ENV{SERVER_NAME} 11/2009</span>
<span class="i">$fields</span>{<span class="w">home</span>}   = <span class="i">$configuration</span>{<span class="w">home</span>}<span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">domain</span>} = <span class="i">$configuration</span>{<span class="w">domain</span>}<span class="sc">;</span>

<span class="c"># old style hash set type = 0</span>
<span class="k">my</span> <span class="i">$url_type</span> = <span class="n">0</span><span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">userHash</span>} = <span class="i">hash_password</span><span class="s">(</span> <span class="i">$url_type</span><span class="cm">,</span> <span class="i">$fields</span>{<span class="w">userPassword</span>} <span class="s">)</span><span class="sc">;</span>

<span class="c">#</span>
<span class="c">#--------------------------------------------------------------</span>
<span class="c"># number of records per page in displayed lists ex-db tables, change at will</span>
<span class="c"># 15 is about comfortable for full screen</span>
<span class="c">#</span>
<span class="k">my</span> <span class="i">$limit</span> = <span class="i">$fields</span>{<span class="w">limit</span>} || <span class="i">$configuration</span>{<span class="w">linesperpage</span>}<span class="sc">;</span>

<span class="c">#$log-&gt;debug(&quot;limit is $fields{limit}&quot;) ;</span>
<span class="c">#</span>
<span class="c">#--------------------------------------------------------------</span>
<span class="c">#--------------------------------------------------------------</span>
<span class="c"># means that multiregistry indication is accessible without passing</span>
<span class="c"># configuration information everywhere: used to turn off select</span>
<span class="c"># for partner registries etc.</span>
<span class="i">$fields</span>{<span class="w">multiregistry</span>} = <span class="i">$configuration</span>{<span class="w">multiregistry</span>}<span class="sc">;</span>

<span class="c">#--------------------------------------------------------------</span>

<span class="c">#--------------------------------------------------------------</span>
<span class="c"># initial user status for a user, if you want them to be active</span>
<span class="c"># without email confirmation, set up as &#39;active&#39;. If you want them</span>
<span class="c"># to be unconfirmed and activated by email set to &#39;unconfirmed&#39;</span>
<span class="c">#</span>
<span class="i">$fields</span>{<span class="w">initialUserStatus</span>} = <span class="i">$configuration</span>{<span class="w">initialuserstatus</span>}<span class="sc">;</span>

<span class="c">#---------------------------------------------------------------</span>
<span class="c">#--------------------------------------------------------------</span>
<span class="c"># initial payment status for a payment, if you want a payment to be accepted</span>
<span class="c"># immediately, set up as &#39;accepted&#39;.</span>
<span class="c">#</span>
<span class="i">$fields</span>{<span class="w">initialPaymentStatus</span>} = <span class="i">$configuration</span>{<span class="w">initialpaymentstatus</span>}<span class="sc">;</span>

<span class="c">#---------------------------------------------------------------</span>

<span class="c">#--------------------------------------------------------------</span>
<span class="c"># which mail address your notifications come from, this needs to be</span>
<span class="c"># a valid address. This header is currently forged with -f, this is</span>
<span class="c"># an area of concern to be re-coded/re-configured</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="i">$fields</span>{<span class="w">systemMailAddress</span>} = <span class="i">$configuration</span>{<span class="w">systemmailaddress</span>}<span class="sc">;</span>

<span class="c">#---------------------------------------------------------------</span>
<span class="c">#--------------------------------------------------------------</span>
<span class="c"># which mail address your replies go to, this is normally a dead address</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="i">$fields</span>{<span class="w">systemMailReplyAddress</span>} = <span class="i">$configuration</span>{<span class="w">systemmailreplyaddress</span>}<span class="sc">;</span>

<span class="c">#---------------------------------------------------------------</span>
<span class="c"># A template object referencing a particular directory</span>
<span class="c">#-------------------------------------------------------------------</span>
<span class="c"># Change this if you change where the templates are...</span>
<span class="c">#-------------------------------------------------------------------</span>
<span class="k">my</span> <span class="i">$pages</span> = <span class="w">new</span> <span class="i">HTML::SimpleTemplate</span><span class="s">(</span><span class="q">&quot;$configuration{templates}/$language&quot;</span><span class="s">)</span><span class="sc">;</span>

<span class="c">#--------------------------------------------------------------------</span>
<span class="c"># This is the token that is to be carried everywhere, preventing</span>
<span class="c"># session hijack etc. It&#39;s probably going to be a GnuPg public key</span>
<span class="c"># anyway it&#39;s a public key of some kind related to the cclite installations</span>
<span class="c"># private key, not transcclite.cgimitted and protected by passphrase</span>
<span class="c">#</span>
<span class="i">$token</span> = <span class="i">$registry_private_value</span> =
  <span class="i">$configuration</span>{<span class="w">registrypublickey</span>}<span class="sc">;</span>    <span class="c"># for the moment, calculated later</span>

<span class="c">#---------------------------------------------------------------------</span>
<span class="c"># elementary controller based on the action field</span>
<span class="c"># note that add database record also writes a record in the people file</span>
<span class="c"># for use by the calendar</span>

<span class="c"># these are generic actions which maintain the databases</span>
<span class="c"># will be split into more specific code later</span>
<span class="c">#</span>
<span class="c"># &#39;local&#39; is added to routines that are invoked locally to fill the class field</span>
<span class="c">#  when they are invoked via soaplite, this is filled automatically</span>
<span class="c">#</span>
<span class="c">#  this needs to become ! valid_token when the hashing works</span>
<span class="c">#  don&#39;t do anything except login and create new users</span>
<span class="c">#</span>
<span class="c">#  logon comes from auth in configuration or htaccess</span>
<span class="c">#  check database and provide logon via this method</span>
<span class="c">#  this will only do a single nominated registry though</span>
<span class="c">#</span>
<span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$ENV</span>{<span class="w">REMOTE_USER</span>} <span class="s">)</span> &amp;&amp; !<span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
    <span class="i">$fields</span>{<span class="w">logontype</span>} = <span class="q">&#39;remote&#39;</span><span class="sc">;</span>
    <span class="s">(</span>
        <span class="s">(</span>
            <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span>
            <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span>
        <span class="s">)</span>
        = <span class="i">logon_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c">#  no token, no remote user</span>
<span class="i">$fields</span>{<span class="w">menustyle</span>} = <span class="q">&#39;menu&#39;</span><span class="sc">;</span>
<span class="i">$fields</span>{<span class="w">logontype</span>} ||= <span class="q">&#39;form&#39;</span><span class="sc">;</span>

<span class="c">###my $debug = join (&#39;|&#39;,%fields) ;</span>
<span class="c">###$log-&gt;debug(&quot;fields are $debug\n&quot;) ;</span>

<span class="k">if</span> <span class="s">(</span>
       <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span>
    &amp;&amp; <span class="i">$action</span> <span class="k">ne</span> <span class="q">&#39;logon&#39;</span>
    &amp;&amp; <span class="i">$action</span> <span class="k">ne</span> <span class="q">&#39;forgotpassword&#39;</span>
    &amp;&amp; <span class="i">$action</span> <span class="k">ne</span> <span class="q">&#39;oscommerce_pay&#39;</span>
    &amp;&amp; <span class="i">$action</span> <span class="k">ne</span> <span class="q">&#39;confirmuser&#39;</span>
    &amp;&amp; <span class="i">$action</span> <span class="k">ne</span> <span class="q">&#39;adduser&#39;</span>
    &amp;&amp; <span class="s">(</span> <span class="i">$ENV</span>{<span class="w">QUERY_STRING</span>} <span class="k">ne</span> <span class="q">&quot;action=template&amp;name=newuser.html&quot;</span> <span class="s">)</span>
    &amp;&amp; <span class="s">(</span> <span class="i">$ENV</span>{<span class="w">QUERY_STRING</span>} <span class="k">ne</span> <span class="q">&quot;action=template&amp;name=forgotpass.html&quot;</span> <span class="s">)</span>

  <span class="s">)</span>

  <span class="c"># grey out all transaction menus and go back to login</span>
<span class="s">{</span>

    <span class="c"># grumble about installer and security problems etc.</span>
    <span class="i">$$fieldsref</span>{<span class="w">errors</span>} = <span class="i">install_grumble</span><span class="s">(</span> <span class="i">$configuration</span>{<span class="w">librarypath</span>} <span class="s">)</span><span class="sc">;</span>
    <span class="i">display_template</span><span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="q">&quot;logon.html&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span><span class="cm">,</span>
        <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>

<span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">userLogin</span>} <span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

    <span class="c"># calculate token to compare with cookie version</span>
    <span class="k">my</span> <span class="i">$compare_token</span><span class="sc">;</span>
    <span class="s">(</span> <span class="i">$compare_token</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span> =
      <span class="i">calculate_token</span><span class="s">(</span> <span class="i">$registry_private_value</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span>
        <span class="i">$ENV</span>{<span class="w">REMOTE_ADDR</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">token</span>} <span class="s">)</span>
        &amp;&amp; <span class="s">(</span> <span class="i">$compare_token</span> <span class="k">ne</span> <span class="i">$$cookieref</span>{<span class="w">token</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>
        <span class="i">$log</span><span class="i">-&gt;warn</span><span class="s">(</span>
<span class="q">&quot;corrupt token or spoofing attempt from: $$cookieref{userLogin} $ENV{REMOTE_ADDR}&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
<span class="c">###        $log-&gt;debug(&quot;in cclite: $compare_token\n  ne \n$$cookieref{token} \ntoken1:$$cookieref{token1}&quot;);</span>

        <span class="c"># attempt to exit cleanly</span>
        <span class="i">$action</span> = <span class="q">&#39;logoff&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

<span class="s">}</span>

<span class="k">my</span> <span class="i">$fieldsref</span> = \<span class="i">%fields</span><span class="sc">;</span>

<span class="c"># logon to a registry</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;logon&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">logon_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># logoff, doesn&#39;t return, exits</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;logoff&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="i">logoff_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
    <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># these are &#39;raw&#39; db actions, need a bit of work, except for find_records...</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;insert&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;find&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">find_records</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>    <span class="i">$db</span><span class="cm">,</span>    <span class="i">$table</span><span class="cm">,</span>  <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;delete&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">delete_database_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;modifyuser&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
    = <span class="i">modify_database_record</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;display&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">show_record</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;update&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">update_database_record</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$language</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># show a template</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;template&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> = <span class="i">display_template</span><span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
        <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># these are specific actions which belong to the application</span>
<span class="c"># show my current transactions</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showtrans&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">get_many_items</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="q">&#39;&#39;</span><span class="cm">,</span>      <span class="q">&#39;&#39;</span><span class="cm">,</span>  <span class="q">&#39;html&#39;</span><span class="cm">,</span>      <span class="i">$token</span><span class="cm">,</span>
        <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

</pre><dl><dt><strong><a name="item_holder">delete_trade
 one shouldn't do this, but it's left in here as a place holder
 ($action eq ``deletetrade'') 	&amp;&amp;  (($refresh,$metarefresh,$error,$html,$pagename,$cookies) 	
         = delete_trade('local',$db,'om_trades',$fieldsref,   $pages,$token)) ;
 this is now replaced by canceltrade, which modifies tradeStatus to cancelled
=cut</a></strong></dt>

</dl>

<pre>
<span class="c"># this mainly only modifies the status field</span>
<span class="c"># other parts of the trade should always remain integral</span>
<span class="c"># actually the hash should change at this point?!</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;confirmtrade&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">modify_trade</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;declinetrade&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">modify_trade</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;canceltrade&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">modify_trade</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_trades&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># show my yellow pages entries</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showmyyellow&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">get_many_items</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;fromuserid&#39;</span><span class="cm">,</span>
        <span class="i">$$cookieref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># show yellow pages entries following category selection</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showyellowbycat&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">find_records</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span>    <span class="i">$db</span><span class="cm">,</span>    <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>
        <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>          <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># this is 0.4.0 code and will be removed soon, replaced by showyellowdir1</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showyellowdir&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">show_yellow_dir</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&#39;fromuserid&#39;</span><span class="cm">,</span>
        <span class="i">$$cookieref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showyellowdir1&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">show_yellow_dir1</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;addyellow&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_yellow</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showyellow&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">show_yellow</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># make a newly created user active</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;confirmuser&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">confirm_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># add a user with status unconfirmed</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;adduser&quot;</span> <span class="s">)</span>

  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">add_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&quot;om_users&quot;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showuser&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span> =
    <span class="i">show_user</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># email password: to be done..</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;forgotpassword&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>

    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">forgotten_password</span><span class="s">(</span>
        <span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># pay another user</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;transaction&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">transaction</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># pay another user in two currencies</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;splittransaction&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">split_transaction</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># pay another user from oscommerce shop</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;oscommerce_pay&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">oscommerce_transaction</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># show balance and volume</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;showbalvol&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =

    <span class="c"># html to return html, values to return raw balances and volumes</span>
    <span class="i">show_balance_and_volume</span><span class="s">(</span>
        <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$$cookieref</span>{<span class="w">userLogin</span>}<span class="cm">,</span> <span class="q">&#39;html&#39;</span><span class="cm">,</span>
        <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># sms and touchtone</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;smsemulate&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
    <span class="i">sms_transaction</span><span class="s">(</span> <span class="i">$fields</span>{<span class="w">fromnumber</span>}<span class="cm">,</span> <span class="i">$fields</span>{<span class="w">smsmessage</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># change language</span>
<span class="s">(</span> <span class="i">$action</span> <span class="k">eq</span> <span class="q">&quot;lang&quot;</span> <span class="s">)</span>
  &amp;&amp; <span class="s">(</span>
    <span class="s">(</span>
        <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>     <span class="i">$html</span><span class="cm">,</span>
        <span class="i">$pages</span><span class="cm">,</span>   <span class="i">$pagename</span><span class="cm">,</span>    <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookies</span>
    <span class="s">)</span>
    = <span class="i">change_language</span><span class="s">(</span>
        <span class="i">$configuration</span>{<span class="w">templates</span>}<span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$cookieref</span><span class="cm">,</span> <span class="i">$token</span>
    <span class="s">)</span>
  <span class="s">)</span><span class="sc">;</span>

<span class="c"># get top line news for registry</span>

<span class="i">$$fieldsref</span>{<span class="w">news</span>} = <span class="i">get_news</span><span class="s">(</span> <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="c">#FIXME: Probably only to be done when logged on?</span>
<span class="c"># but nice to show a few &#39;public&#39; listings....</span>
<span class="c"># collect ad listing for bottom of screen, only want news field, don&#39;t disturb anything else</span>

<span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$cookieref</span>{<span class="w">userLogin</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$save</span> = <span class="i">$$fieldsref</span>{<span class="w">getdetail</span>}<span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">getdetail</span>} = <span class="n">1</span><span class="sc">;</span>
    <span class="s">(</span>
        <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">righthandside</span>}<span class="cm">,</span> <span class="k">undef</span><span class="cm">,</span> <span class="k">undef</span> <span class="s">)</span> =
          <span class="i">show_yellow_dir1</span><span class="s">(</span>
            <span class="q">&#39;local&#39;</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span>
          <span class="s">)</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">getdetail</span>} = <span class="i">$save</span><span class="sc">;</span>
<span class="s">}</span>

<span class="c"># display an action result, all actions are consumed</span>
<span class="i">display_template</span><span class="s">(</span>
    <span class="i">$refresh</span><span class="cm">,</span>  <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span>   <span class="i">$html</span><span class="cm">,</span> <span class="i">$pages</span><span class="cm">,</span>
    <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span>   <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$token</span>
<span class="s">)</span><span class="sc">;</span>
<span class="k">exit</span> <span class="n">0</span><span class="sc">;</span>
<span class="i">$$cookieref</span>{<span class="w">token</span>}
</pre></body>

</html>
