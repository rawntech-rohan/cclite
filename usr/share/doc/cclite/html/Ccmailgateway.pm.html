<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccmailgateway.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccmailgateway.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#see_also">SEE ALSO</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#messagehash">messagehash</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccmailgateway-">package Ccmailgateway</a>
<ul>
<li><a href="#_check_to_and_from-">_check_to_and_from</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccmailgateway.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Transaction conversion interfaces inwards for mail etc.</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is the second generation mail transaction logic:</p>
<p>- better checking
- provides some feedback
- remote mailboxes rather than local read of mail file
- in separate module to prepare for gpg etc. etc.</p>
<p>Mail Transactions
-&gt; Confirm pin         p123456 confirm (to be done)
-&gt; Change pin          p123456 change p345678 (to be done)
-&gt; Pay                 send 5 &lt;currencyname&gt; to &lt;username&gt; at &lt;registry_name&gt; for stuff
-&gt; Query Balance       balance (to be done, like sms mailed balance transaction)</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="see_also">SEE ALSO</a></h1>
<p>Cchooks.pm</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2005 - 2008 GPL Licenced
</p>
<pre>

=cut</pre>
<pre>
<a name="package-Ccmailgateway-"></a><span class="k">package </span><span class="i">Ccmailgateway</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span> = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclite</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccconfiguration</span><span class="sc">;</span>    <span class="c"># new style configuration method</span>
<span class="k">use</span> <span class="w">Net::POP3</span><span class="sc">;</span>
<span class="c">###use Net::SMTP;</span>

<span class="i">@EXPORT</span> = <span class="q">qw(</span>
  <span class="q">mail_message_parse</span>
<span class="q">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="messagehash">messagehash</a></h3>
<p>this is the provisional solution to the multilingual message fragments
later, it will go somewhere neater
to change these, just substitute a translated hash
</p>
<pre>

=cut</pre>
<pre>
<span class="c"># application specific globals</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>




</pre><dl><dt><strong><a name="item_use_in_0_2e7_2e1">use in 0.7.1</a></strong></dt>

<dd>
<p>sub notify_by_mail {</p>
<p>my $host = '10.0.0.10' ;
my $to = ``cclite.dalston\@cclite.cclite.k-hosting.co.uk'' ;</p>
<p>###my $host = 'cclite.cclite.k-hosting.co.uk' ;
###my $user = <a href="mailto:'cclite.dalston@cclite.cclite.k-hosting.co.uk'">'cclite.dalston@cclite.cclite.k-hosting.co.uk'</a> ;</p>
<p>my $smtp = Net::SMTP-&gt;new($host,
##                           Hello =&gt; '10.0.0.10',
                           Timeout =&gt; 30,
                           Debug   =&gt; 1,
                          );</p>
<pre>
    $smtp-&gt;auth($user,$password);</pre>
<p></p>
<pre>
    $smtp-&gt;mail('hbarnard\@3wave.co.uk');
    $smtp-&gt;to($to);
    $smtp-&gt;data();
    $smtp-&gt;datasend(&quot;To: $to\n&quot;);
    $smtp-&gt;datasend(&quot;Subject: Payment message\n&quot;);
    $smtp-&gt;datasend(&quot;\n&quot;);
    $smtp-&gt;datasend(&quot;send 42 hacks to test2 at dalston for dillying\n&quot;);
    $smtp-&gt;datasend(&quot;\.\n&quot;);
    $smtp-&gt;dataend();
    $smtp-&gt;quit;
    
    return ;
    
}

</pre>
</dd>
</dl>

<pre>

<a name="_check_to_and_from-"></a><span class="k">sub </span><span class="m">_check_to_and_from</span> <span class="s">{</span>
    
    <span class="k">my</span> <span class="s">(</span><span class="i">$transaction_description_ref</span><span class="s">)</span> = <span class="i">@_</span> <span class="sc">;</span>
    
    <span class="k">my</span> <span class="i">$message</span> <span class="sc">;</span>
    
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$fromuserref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$fromregistry</span><span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userEmail&#39;</span><span class="cm">,</span>
            <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;from&#39;</span>}<span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$touserref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span> <span class="q">&#39;om_users&#39;</span><span class="cm">,</span> <span class="q">&#39;userLogin&#39;</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;destination&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$currencyref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;registry&#39;</span>}<span class="cm">,</span> <span class="q">&#39;om_currencies&#39;</span><span class="cm">,</span> <span class="q">&#39;name&#39;</span><span class="cm">,</span> <span class="i">$transaction_description_ref</span>-&gt;{<span class="q">&#39;currency&#39;</span>}<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># one of the above lookups fails, reject the whole transaction</span>
        <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$fromuserref</span><span class="s">)</span> <span class="s">)</span>
            || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$touserref</span><span class="s">)</span> <span class="s">)</span>
            || <span class="s">(</span> !<span class="k">length</span><span class="s">(</span><span class="i">$currencyref</span><span class="s">)</span> <span class="s">)</span> <span class="s">)</span>
        <span class="s">{</span>
            <span class="i">$message</span> = <span class="q">&quot;$from{$key},&quot;</span><span class="w">transaction</span> <span class="w">invalid</span><span class="co">:</span> <span class="i">$input</span><span class="q">&quot; ;</span>
        <span class="q">        }</span>
    <span class="q">    return ($fromuserref{userLogin}, $message) ;</span>
<span class="q">}</span>


<span class="q">sub mail_message_parse {</span>

    <span class="q">    my ($class, $registry, $from, $to, $text) = @_;</span>

    <span class="q">    my %transaction_description;</span>
    <span class="q">    my $parse_type = 0;</span>
        
    <span class="q">    # need this later to deduce the payer...</span>
    <span class="q">    $transaction_description{from} = $from ;</span>
        
<span class="q"># send 4 duckets to unknown at dalston for barking lessons</span>
<span class="q"># parse does include currency word, single currency only, no description also allowed</span>
        
    <span class="q">    if ( $text =~ /send\s+(\d+)\s+(\w+)\s+to\s+(\w+)\s+at\s+(\w+)\s+for\s+(.*)/i</span>
      <span class="q">      )</span>
    <span class="q">    {</span>

        <span class="q">        $transaction_description{&#39;amount&#39;}         = $1;</span>
        <span class="q">        $transaction_description{&#39;currency&#39;}       = $2;</span>
        <span class="q">        $transaction_description{&#39;destination&#39;}    = $3;</span>
        <span class="q">        $transaction_description{&#39;registry&#39;}       = $4;</span>
        <span class="q">        $transaction_description{&#39;description&#39;}    = $5;</span>
        <span class="q">        $parse_type                                = 1;    # no currency word</span>
                
        <span class="q">        my $x = join( &quot;</span>|<span class="q">&quot;, %transaction_description );</span>
        <span class="q">        $transaction_description{debug} = &quot;</span><span class="w">parsed</span> <span class="w">mail</span> <span class="w">transaction</span> <span class="w">is</span><span class="co">:</span> <span class="i">$x</span> <span class="w">parse</span> <span class="w">type</span> <span class="w">is</span> <span class="i">$parse_type</span>\<span class="w">n</span>\<span class="w">n</span><span class="q">&quot;;</span>
                
    <span class="q">    } elsif ($text =~ /balance/i ) {</span>
        <span class="q">        $transaction_description{message} = &quot;</span><span class="w">parsed</span> <span class="w">mail</span> <span class="w">transaction</span> <span class="w">is</span><span class="co">:</span> <span class="w">request</span>-<span class="w">balance</span> \<span class="w">n</span>\<span class="w">n</span><span class="q">&quot;;</span>
    <span class="q">    }</span>
    <span class="q">    else {</span>
        <span class="q">        $transaction_description{error} = &quot;</span><span class="w">unparsed</span> <span class="w">pay</span> <span class="w">transaction</span> <span class="w">is</span><span class="co">:</span> <span class="i">$input</span><span class="q">&quot; ;</span>
    <span class="q">    }</span>

    <span class="q">    # check currency, registry and destination are OK, if not cumulate with errors</span>
    <span class="q">    # deduce tradeSource using &#39;from&#39; email</span>
    <span class="q">    ( $transaction_description{&#39;source&#39;},$error_message) = _check_to_and_from(\%transaction_description) ;     </span>
    <span class="q">    $transaction_description{error} .= $error_message if (length($error_message)) ;    </span>
        

    <span class="q">    return ( $parse_type, \%transaction_description );</span>

<span class="q">}</span>


<span class="q">sub mail_transaction {</span>

        <span class="q">        my ($transaction_description_ref) = @_ ;</span>
                
        <span class="q">        # convert to standard transaction input format, fields etc.</span>
        <span class="q">        #fromregistry : chelsea</span>
        <span class="q">        $transaction{fromregistry} = $transaction_description_ref-&gt;{&#39;registry&#39;};</span>


                

        <span class="q">        #home : http://cclite.caca-cola.com:83/cgi-bin/cclite.cgi, for example</span>
        <span class="q">        $transaction{home}      = &quot;</span><span class="q">&quot;;           # no home, not a web transaction</span>
                                                <span class="q">                                                #subaction : om_trades</span>
        <span class="q">        $transaction{subaction} = &#39;om_trades&#39;;</span>

        <span class="q">        #toregistry : dalston</span>
        <span class="q">        $transaction{toregistry} = $transaction_description_ref-&gt;{&#39;registry&#39;};</span>

        <span class="q">        #tradeAmount : 23</span>
        <span class="q">        $transaction{tradeAmount} = $transaction_description_ref-&gt;{&#39;amount&#39;};</span>

        <span class="q">        #tradeCurrency : ducket</span>
        <span class="q">        $transaction{tradeCurrency} = $transaction_description_ref-&gt;{&#39;currency&#39;};</span>

        <span class="q">        #tradeDate : this is date of reception and processing, in fact</span>
        <span class="q">        my ( $date, $time ) = &amp;Ccu::getdateandtime( time() );</span>
        <span class="q">        $transaction{tradeDate} = $date;</span>

        <span class="q">        #tradeTitle : added by this routine</span>
        <span class="q">        my $description = &#39;Via mail&#39; . $transaction_description_ref-&gt;{&#39;description&#39;}  ;</span>
        <span class="q">        $transaction{tradeTitle} = $description ;</span>

        <span class="q">        #FIXME: tradeDescription, duplicated!</span>
        <span class="q">        $transaction{tradeDescription} = $description;</span>

        <span class="q">        #tradeDestination : ddawg</span>
        <span class="q">        $transaction{tradeDestination} = $transaction_description_ref-&gt;{&#39;destination&#39;};</span>

        <span class="q">        #tradeItem : test to see variables</span>
        <span class="q">        #tradeSource : manager</span>
        <span class="q">        $transaction{tradeSource} = $transaction_description_ref-&gt;{&#39;source&#39;};</span>


        <span class="q">        # call ordinary transaction</span>
        <span class="q">        my $transaction_ref = \%transaction;</span>
        <span class="q">        my ( $metarefresh, $home, $error, $output_message, $page, $c ) =</span>
          <span class="q">          transaction( &#39;mail&#39;, $transaction{fromregistry},</span>
            <span class="q">            &#39;om_trades&#39;, $transaction_ref, $pages, $token );</span>
        
    <span class="q">    return $output_message ;        </span>
<span class="q">}            </span>


<span class="q">1;</span>
<a name="EOF-"></a></pre></body>

</html>
