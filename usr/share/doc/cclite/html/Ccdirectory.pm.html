<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ccdirectory.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #F0F0F0;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
<body style="background-color: white">
<a name="-top-"></a>
<h1>Ccdirectory.pm</h1>

<p><a name="__index__"></a></p>
<!-- INDEX BEGIN -->

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#author">AUTHOR</a></li>
	<li><a href="#copyright">COPYRIGHT</a></li>
	<ul>

		<ul>

			<li><a href="#add_yellow">add_yellow</a></li>
			<li><a href="#show_yellow">show_yellow</a></li>
			<li><a href="#show_yellow_dir">show_yellow_dir</a></li>
			<li><a href="#show_yellow_dir1">show_yellow_dir1</a></li>
		</ul>

	</ul>

</ul>
<!-- INDEX END -->
<h2>Code Index:</h2>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#package-Ccdirectory-">package Ccdirectory</a>
<ul>
<li><a href="#add_yellow-">add_yellow</a></li>
<li><a href="#show_yellow-">show_yellow</a></li>
<li><a href="#show_yellow_dir-">show_yellow_dir</a></li>
<li><a href="#show_yellow_dir1-">show_yellow_dir1</a></li>
</ul>
</li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->

<hr />
<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Ccdirectory.pm</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<p>Ccdirectory main</p>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>This is the the directory/yellow pages module for Cclite. It's now separated from
the transaction motor, so that custom directories can be built</p>
<p>These functions assume that all the local data has been validated
Probably this is done via Ccvalidate.pm. 
There are extra actions for remote registry checks already</p>
<p>
</p>
<hr />
<h1><a name="author">AUTHOR</a></h1>
<p>Hugh Barnard</p>
<p>
</p>
<hr />
<h1><a name="copyright">COPYRIGHT</a></h1>
<p>(c) Hugh Barnard 2004-2007 GPL Licenced</p>
<pre>
<a name="package-Ccdirectory-"></a><span class="k">package </span><span class="i">Ccdirectory</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">strict</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">vars</span> <span class="q">qw(@ISA @EXPORT)</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Exporter</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccu</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Cclitedb</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccvalidate</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Ccsecure</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$VERSION</span> = <span class="n">1.00</span><span class="sc">;</span>
<span class="i">@ISA</span>    = <span class="q">qw(Exporter)</span><span class="sc">;</span>
<span class="i">@EXPORT</span> = <span class="q">qw(add_yellow</span>
  <span class="q">show_yellow</span>
  <span class="q">show_yellow_dir</span>
  <span class="q">show_yellow_dir1</span>
<span class="q">)</span><span class="sc">;</span>

<span class="c"># read messages from literals file, this isn&#39;t fully multilingual yet</span>
<span class="k">our</span> <span class="i">%messages</span> = <span class="i">readmessages</span><span class="s">(</span><span class="q">&quot;en&quot;</span><span class="s">)</span><span class="sc">;</span>

</pre><p></p>
<h3><a name="add_yellow">add_yellow</a></h3>
<p>add a yellow page, promoted from raw add_database_record to
do specific validations etc. needs fleshing out...
now added, parse of option fields so that the category, parent
category and keywords work out</p>
<pre>
<a name="add_yellow-"></a><span class="k">sub </span><span class="m">add_yellow</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$date</span><span class="cm">,</span> <span class="i">$time</span> <span class="s">)</span> = <span class="i">&amp;Ccu::getdateandtime</span><span class="s">(</span> <span class="k">time</span><span class="s">(</span><span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">date</span>}   = <span class="i">$date</span><span class="sc">;</span>
    <span class="i">$$fieldsref</span>{<span class="w">status</span>} = <span class="q">&#39;active&#39;</span><span class="sc">;</span>

    <span class="c"># parse the option field</span>
    <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">category</span>}<span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">parent</span>}<span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">keywords</span>} <span class="s">)</span> =
      <span class="i">$$fieldsref</span>{<span class="w">classification</span>} =~ <span class="q">/(\d{4})(\d{4})(.*)/</span><span class="sc">;</span>

    <span class="c">#</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span> =
      <span class="i">add_database_record</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$messages</span>{<span class="w">directorypageadded</span>}<span class="cm">,</span>
        <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&quot;&quot;</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_yellow">show_yellow</a></h3>
<p>Join the specific yellow pages record with the user
record to display telephone number and email etc.</p>
<p>Run show balance and volume to show balance and volume at 
bottom of ad. This is a pretty heavy operation and perhaps
should be done as a nightly batch to generate static html</p>
<p>This also contains SQL at present, goodbye n-tier purity!</p>
<pre>
<a name="show_yellow-"></a><span class="k">sub </span><span class="m">show_yellow</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">  SELECT DISTINCT u.userEmail, y.id, y.subject, y.description, u.userMobile, u.userTelephone, y.fromuserid</span>
<span class="hh">  FROM om_yellowpages y, om_users u</span>
<span class="hh">  WHERE (</span>
<span class="hh">  y.fromuserid = u.userLogin AND y.id = &#39;$$fieldsref{id}&#39;)</span>
<span class="h">EOT</span>

    <span class="c"># get equi-joined table</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%report</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$hash_key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>

        <span class="c"># my $parent = &quot;$hash_ref-&gt;{$hash_key}-&gt;{parent}&quot; ;</span>
        <span class="k">my</span> <span class="i">$record_ref</span> = <span class="i">$hash_ref</span>-&gt;{<span class="i">$hash_key</span>}<span class="sc">;</span>
        <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$record_ref</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">   &lt;tr&gt;&lt;td class=&quot;pme-key-1&quot;&gt;$key&lt;/td&gt;&lt;td class=&quot;pme-value-1&quot;&gt;$hash_ref-&gt;{$hash_key}-&gt;{$key}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="h">EOT</span>

        <span class="s">}</span>
    <span class="s">}</span>

    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;$html&lt;/table&gt;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$$fieldsref</span>{<span class="w">home</span>}<span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$fieldsref</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_yellow_dir">show_yellow_dir</a></h3>
<p>Show yellow pages directory by category, based on the work done by Mary Fee
for Camden. Should work with any scheme that has categories and parent categories
only nested once, otherwise needs re-writing to be recursive</p>
<p>won't work as web service because it returns hashes!</p>
<pre>
<a name="show_yellow_dir-"></a><span class="k">sub </span><span class="m">show_yellow_dir</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span>
        <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span>   <span class="i">$table</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$fieldname</span><span class="cm">,</span>
        <span class="i">$value</span><span class="cm">,</span> <span class="i">$type</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span>    <span class="i">$limit</span>
    <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$refresh</span><span class="cm">,</span> <span class="i">$metarefresh</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$pagename</span><span class="cm">,</span> <span class="i">$cookies</span><span class="cm">,</span> <span class="i">$order</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># stick the major categories equi-joined to the individual ads</span>
    <span class="c"># whole directory</span>
    <span class="c">#</span>
    <span class="c"># next generation, join categories to itself and order</span>
    <span class="c"># by the alphabetic description</span>
    <span class="c">#</span>
    <span class="c"># SELECT DISTINCT c1.description, c2.description, c1.category, c2.category</span>
    <span class="c"># FROM om_categories c1, om_categories c2</span>
    <span class="c"># WHERE (</span>
    <span class="c"># c2.parent = c1.category</span>
    <span class="c"># )</span>
    <span class="c"># ORDER BY c1.description, c2.description</span>
    <span class="c"># LIMIT 0 , 30</span>
    <span class="c">#</span>

    <span class="k">my</span> <span class="i">$sqlstring</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$summary_flag</span> = <span class="q">&quot;no&quot;</span><span class="sc">;</span>    <span class="c"># set to yes if summary</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">parent</span>} <span class="s">)</span> &amp;&amp; !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">category</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$summary_flag</span> = <span class="q">&quot;yes&quot;</span><span class="sc">;</span>
        <span class="i">$sqlstring</span>    = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT DISTINCT c.parent, c.description, y.id, y.subject, y.fromuserid</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent</span>
<span class="hh">)</span>
<span class="hh">ORDER BY c.parent, c.description</span>
<span class="h">EOT</span>

        <span class="c"># one major category only</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">parent</span>} <span class="s">)</span>
        &amp;&amp; !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">category</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT DISTINCT c.parent, c.description, y.id, y.subject, y.fromuserid</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent AND y.parent = $$fieldsref{parent}</span>
<span class="hh">)</span>
<span class="hh">ORDER BY c.parent, c.description</span>
<span class="h">EOT</span>

    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">parent</span>} <span class="s">)</span> &amp;&amp; <span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">category</span>} <span class="s">)</span> <span class="s">)</span>
    <span class="s">{</span>

        <span class="c"># one specific category</span>

        <span class="i">$sqlstring</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">SELECT DISTINCT c.parent, c.description, y.id, y.subject, y.fromuserid</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent AND y.parent = $$fieldsref{parent} AND y.category = $$fieldsref{category}</span>
<span class="hh">)</span>
<span class="hh">ORDER BY c.parent, c.description</span>
<span class="h">EOT</span>

    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$row</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%counter</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$major</span><span class="cm">,</span> <span class="i">$save_major</span><span class="cm">,</span> <span class="i">$minor</span><span class="cm">,</span> <span class="i">$save_minor</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$first_pass</span> = <span class="n">1</span><span class="sc">;</span>

    <span class="c"># get equi-joined table</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref</span> <span class="s">)</span> = <span class="i">sqlraw</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%report</span><span class="sc">;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$key</span><span class="cm">,</span> <span class="i">$categoryref</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># for example print &quot;Name for id 42 is $hash_ref-&gt;{42}-&gt;{name}\n&quot;;</span>

    <span class="c"># once through to accumulate by category</span>
    <span class="k">my</span> <span class="i">%counter</span><span class="sc">;</span>    <span class="c"># hash to count each major category</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$hash_key</span> <span class="s">(</span> <span class="k">keys</span> <span class="i">%$hash_ref</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$parent</span> = <span class="q">&quot;$hash_ref-&gt;{$hash_key}-&gt;{parent}&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$categoryref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_categories&#39;</span><span class="cm">,</span> <span class="q">&#39;category&#39;</span><span class="cm">,</span> <span class="i">$parent</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>

<span class="c"># must be revisited this is wrong! parasitic call to table because of fetchall_hashref!</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$hash_ref1</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_yellowpages&#39;</span><span class="cm">,</span> <span class="q">&#39;id&#39;</span><span class="cm">,</span> <span class="i">$hash_key</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span>
            <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$lower</span> = <span class="k">lc</span><span class="s">(</span> <span class="i">$$categoryref</span>{<span class="w">description</span>} <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$lower</span> = <span class="q">&quot;\u$lower&quot;</span><span class="sc">;</span>
        <span class="i">$counter</span>{<span class="i">$lower</span>}++<span class="sc">;</span>    <span class="c"># increment count for this category</span>
        <span class="i">$key</span> = <span class="q">&quot;$lower---$hash_ref-&gt;{$hash_key}-&gt;{description}---$parent&quot;</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$login</span> = <span class="q">&quot;$hash_ref-&gt;{$hash_key}-&gt;{fromuserid}&quot;</span><span class="sc">;</span>

        <span class="c"># this gives an individual item number entry. It&#39;s red, if it&#39;s a want</span>
        <span class="c"># it&#39;s yellow if for sale</span>
        <span class="i">$report</span>{<span class="i">$key</span>} .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;a class=&quot;pme-key-1&quot; title=&quot;$$hash_ref1{majorclass} :: $$hash_ref1{type}::$hash_ref-&gt;{$hash_key}-&gt;{subject}&quot;</span>
<span class="hh"> href=&quot;$ENV{SCRIPT_PATH}?subaction=$table&amp;userLogin=$login&amp;action=showuser&quot;&gt;</span>
<span class="hh">&lt;span &gt;$login&lt;/span&gt;&lt;/a&gt; -- </span>
<span class="h">EOT</span>

        <span class="c"># these change the colour of individual items in the listing</span>
        <span class="i">$report</span>{<span class="i">$key</span>} =~ <span class="q">s/key-1/key-debit/g</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$$hash_ref1</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&#39;wanted&#39;</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># kludge for debits</span>
        <span class="i">$report</span>{<span class="i">$key</span>} =~ <span class="q">s/key-1/key-sale/g</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$$hash_ref1</span>{<span class="w">majorclass</span>} <span class="k">eq</span> <span class="q">&#39;goods&#39;</span>
            &amp;&amp; <span class="i">$$hash_ref1</span>{<span class="w">type</span>} <span class="k">eq</span> <span class="q">&#39;offered&#39;</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># kludge for for sale</span>

    <span class="s">}</span>    <span class="c"># end foreach</span>

    <span class="k">my</span> <span class="i">$save_major</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$html</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;h3&gt;$messages{directorylisting}&lt;/h3&gt;</span>
<span class="hh"> &lt;span class=&quot;pme-key-1&quot;&gt;$messages{offered}&lt;/span&gt; </span>
<span class="hh"> &lt;span class=&quot;pme-key-debit&quot;&gt;$messages{wanted}&lt;/span&gt; </span>
<span class="hh"> &lt;span class=&quot;pme-key-sale&quot;&gt;$messages{forsale}&lt;/span&gt; </span>
<span class="hh">&amp;nbsp; &amp;nbsp;&lt;!-- &lt;i&gt;$messages{putcursoron}&lt;/i&gt; --&gt;</span>
<span class="hh">&lt;br/&gt;</span>
<span class="h">EOT</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$key</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%report</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$major</span><span class="cm">,</span> <span class="i">$minor</span><span class="cm">,</span> <span class="i">$parent</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/---/</span><span class="cm">,</span> <span class="i">$key</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$first_pass</span> || <span class="s">(</span> <span class="i">$save_major</span> <span class="k">ne</span> <span class="i">$major</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>

            <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">parent</span>} <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>
<span class="hh">&lt;h4&gt;</span>
<span class="hh">&lt;a class=&quot;big&quot; title=&quot;$major : $messages{clicktoexpand}&quot;</span>
<span class="hh"> href=&quot;$ENV{SCRIPT_PATH}?subaction=$table&amp;parent=$parent&amp;action=showyellowdir&quot;&gt;</span>
<span class="hh">+&lt;/a&gt;&amp;nbsp;$major ($counter{$major}) &lt;/h4&gt;</span>

<span class="h">EOT</span>

            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>

                <span class="i">$html</span> .= <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">&lt;h4&gt;</span>
<span class="hh">&lt;a class=&quot;big&quot; title=&quot;$major : $messages{clicktocollapse}&quot;</span>
<span class="hh"> href=&quot;$ENV{SCRIPT_PATH}?subaction=$table&amp;action=showyellowdir&quot;&gt;</span>
<span class="hh">-&lt;/a&gt;&amp;nbsp;$major ($counter{$major}) &lt;/h4&gt;</span>

<span class="h">EOT</span>

            <span class="s">}</span>    <span class="c"># endif</span>

        <span class="s">}</span>    <span class="c"># endif</span>

        <span class="i">$report</span>{<span class="i">$key</span>} =~ <span class="q">s/\s--\s$//</span><span class="sc">;</span>

        <span class="i">$html</span> .=
          <span class="q">&quot;&amp;nbsp;&amp;nbsp;  $minor &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;$report{$key}&lt;br/&gt;\n&quot;</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$summary_flag</span> <span class="k">eq</span> <span class="q">&quot;no&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$save_major</span> = <span class="i">$major</span><span class="sc">;</span>
        <span class="i">$first_pass</span> = <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">my</span> <span class="i">$template</span> = <span class="q">&quot;result.html&quot;</span> <span class="k">if</span> <span class="s">(</span> !<span class="k">length</span><span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">resulttemplate</span>} <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&quot;&quot;</span><span class="cm">,</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="i">$template</span><span class="cm">,</span> <span class="i">$cookies</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># no remote access for this, put somewhere else?</span>
<span class="s">}</span>

</pre><p></p>
<h3><a name="show_yellow_dir1">show_yellow_dir1</a></h3>
<p>Show yellow pages directory by category description, based on the work done by Mary Fee
for Camden. Should work with any scheme that has categories and parent categories
only nested once, otherwise needs re-writing to be recursive</p>
<p>Shows all lower level description in a big craiglist like table, will make a big
page when there lots of ads.</p>
<p>Also this is a lot simpler that the first one with its expanding and contracting
display etc. 06/2007</p>

<pre>
<a name="show_yellow_dir1-"></a><span class="k">sub </span><span class="m">show_yellow_dir1</span> <span class="s">{</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="i">$fieldsref</span><span class="cm">,</span> <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$interval</span> = <span class="n">1</span><span class="sc">;</span>    <span class="c"># if there are items a week or less in a category</span>
                         <span class="c"># they&#39;ll show up as new</span>

    <span class="k">my</span> <span class="i">$sqldetail</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT c.description, count( 1 ) AS &#39;major count&#39;, y.type, y.category</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent</span>
<span class="hh">)</span>
<span class="hh">GROUP BY y.parent,y.category,y.type</span>
<span class="hh">ORDER BY c.description ASC</span>
<span class="h">EOT</span>

    <span class="c"># same data set as detail but count &#39;new&#39; ads</span>

    <span class="k">my</span> <span class="i">$sqltestifnew</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT y.category, count( 1 )</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE </span>
<span class="hh">((y.date</span>
<span class="hh">BETWEEN DATE_SUB( CURDATE( ) , INTERVAL $interval</span>
<span class="hh">DAY )</span>
<span class="hh">AND CURDATE( ))</span>
<span class="hh">AND</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent)</span>
<span class="hh">GROUP BY y.parent,y.category,y.type</span>
<span class="hh">ORDER BY c.description ASC</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="i">$sqlmajor</span> = <span class="h">&lt;&lt;EOT</span><span class="sc">;</span>

<span class="hh">SELECT  c.parent, count( 1 ) AS &#39;major count&#39;, y.type, y.category</span>
<span class="hh">FROM om_yellowpages y, om_categories c</span>
<span class="hh">WHERE (</span>
<span class="hh">y.category = c.category</span>
<span class="hh">AND c.parent = y.parent</span>
<span class="hh">)</span>
<span class="hh">GROUP BY y.parent</span>
<span class="hh">ORDER BY y.parent ASC</span>
<span class="h">EOT</span>

    <span class="k">my</span> <span class="i">$sqlstring</span> = <span class="i">$sqlmajor</span><span class="sc">;</span>

    <span class="i">$sqlstring</span> = <span class="i">$sqldetail</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$$fieldsref</span>{<span class="w">getdetail</span>} <span class="s">)</span><span class="sc">;</span>

    <span class="c"># look up categories which have new ads</span>
    <span class="k">my</span> <span class="i">%newads</span><span class="sc">;</span>

    <span class="c"># get a list of categories which have received ads recently</span>
    <span class="c"># put in a hash</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqltestifnew</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row_ref</span> <span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$newads</span>{ <span class="i">$$row_ref</span>[<span class="n">0</span>] } = <span class="q">&quot;y&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="s">(</span> <span class="i">$registryerror</span><span class="cm">,</span> <span class="i">$array_ref</span> <span class="s">)</span> =
      <span class="i">sqlraw_return_array</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="i">$sqlstring</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$html</span>        = <span class="q">&quot;&lt;tr&gt;&quot;</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$width_count</span> = <span class="n">1</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$max_depth</span>   = <span class="i">$$fieldsref</span>{<span class="w">maxdepth</span>}
      || <span class="n">3</span><span class="sc">;</span>    <span class="c"># four cells wide as default if not specified</span>
    <span class="k">my</span> <span class="i">$item_count</span><span class="sc">;</span>
    <span class="k">foreach</span> <span class="k">my</span> <span class="i">$row_ref</span> <span class="s">(</span><span class="i">@$array_ref</span><span class="s">)</span> <span class="s">{</span>
        <span class="i">$item_count</span> = <span class="k">scalar</span><span class="s">(</span><span class="i">@$row_ref</span><span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$error</span><span class="cm">,</span> <span class="i">$categoryref</span> <span class="s">)</span> =
          <span class="i">get_where</span><span class="s">(</span> <span class="i">$class</span><span class="cm">,</span> <span class="i">$db</span><span class="cm">,</span> <span class="q">&#39;om_categories&#39;</span><span class="cm">,</span> <span class="q">&#39;category&#39;</span><span class="cm">,</span> <span class="i">$$row_ref</span>[<span class="n">0</span>]<span class="cm">,</span>
            <span class="i">$token</span><span class="cm">,</span> <span class="i">$offset</span><span class="cm">,</span> <span class="i">$limit</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="i">$$fieldsref</span>{<span class="w">getdetail</span>} <span class="s">)</span> <span class="s">{</span>
            <span class="i">$$row_ref</span>[<span class="n">0</span>] =
              <span class="i">$$categoryref</span>{<span class="w">description</span>}<span class="sc">;</span>    <span class="c"># replace category number with desc</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$$row_ref</span>[<span class="n">2</span>] =
              <span class="i">$messages</span>{ <span class="i">$$row_ref</span>[<span class="n">2</span>]
              }<span class="sc">;</span>    <span class="c"># replace offered/wanted with multilingual message</span>
        <span class="s">}</span>
        <span class="i">$$row_ref</span>[<span class="n">0</span>] =
<span class="q">&quot;&lt;a href=\&quot;/cgi-bin/cclite.cgi?action=showyellowbycat&amp;string=$$row_ref[0]\&quot;&gt;$$row_ref[0]&lt;/a&gt;&quot;</span><span class="sc">;</span>

  <span class="c"># if there&#39;s recent ads in this category add a small &#39;New&#39; flag in the listing</span>
        <span class="i">$$row_ref</span>[<span class="n">0</span>] =
          <span class="q">&quot;$$row_ref[0]&lt;sup class=\&quot;spaced\&quot;&gt;$messages{&#39;new&#39;}&lt;/sup&gt;&quot;</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$newads</span>{ <span class="i">$$row_ref</span>[<span class="n">3</span>] } <span class="k">eq</span> <span class="q">&quot;y&quot;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># numeric category does not appear in display</span>
        <span class="k">delete</span> <span class="i">$$row_ref</span>[<span class="n">3</span>]<span class="sc">;</span>

        <span class="k">my</span> <span class="i">$row</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&quot;&lt;/td&gt;&lt;td class=\&quot;offered\&quot;&gt;&quot;</span><span class="cm">,</span> <span class="i">@$row_ref</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$row</span> = <span class="q">&quot;&lt;td class=\&quot;offered\&quot;&gt;$row&lt;/td&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&quot;</span><span class="sc">;</span>
        <span class="i">$row</span> =~ <span class="q">s/\=\&quot;offered\&quot;/\=\&quot;wanted\&quot;/g</span>
          <span class="k">if</span> <span class="s">(</span> <span class="i">$row</span> =~ <span class="q">/wanted/</span> <span class="s">)</span>
          <span class="sc">;</span> <span class="c"># change class to wanted if wanted advert, means colour change on display</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$width_count</span> == <span class="i">$max_depth</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$html</span> .= <span class="q">&quot;$row&lt;/tr&gt;\n&lt;tr&gt;&quot;</span><span class="sc">;</span>
            <span class="i">$width_count</span> = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="i">$html</span> .= <span class="i">$row</span><span class="sc">;</span>
            <span class="i">$width_count</span>++<span class="sc">;</span>
        <span class="s">}</span>

    <span class="s">}</span>

    <span class="c"># pad the end of the table, if necessary</span>
    <span class="k">my</span> <span class="i">$endtable</span> =
      <span class="q">&quot;&lt;td&gt;&lt;/td&gt;&quot;</span> x <span class="s">(</span> <span class="s">(</span> <span class="i">$max_depth</span> - <span class="i">$width_count</span> <span class="s">)</span> * <span class="i">$item_count</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$html</span> .= <span class="q">&quot;$endtable&lt;/tr&gt;&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$html</span> !~ <span class="q">/&lt;tr&gt;$/</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$html</span> = <span class="q">&quot;&lt;table&gt;&lt;tbody class=\&quot;stripy\&quot;&gt;$html&lt;/tbody&gt;&lt;/table&gt;&quot;</span><span class="sc">;</span>

    <span class="k">return</span> <span class="s">(</span> <span class="n">0</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$html</span><span class="cm">,</span> <span class="q">&quot;result.html&quot;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="q">&#39;&#39;</span><span class="cm">,</span> <span class="i">$token</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>

<a name="EOF-"></a></pre></body>

</html>
